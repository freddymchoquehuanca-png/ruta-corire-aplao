<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Control Ruta Corireâ€“Aplao</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap');

:root {
  --bg:#080c10; --s1:#0e1318; --s2:#141a22; --s3:#1c2430;
  --border:#243040; --border2:#2e3d50;
  --corire:#3b9eff; --corire-dim:rgba(59,158,255,.15);
  --aplao:#ff9a3b;  --aplao-dim:rgba(255,154,59,.15);
  --mamas:#3bff8a;  --mamas-dim:rgba(59,255,138,.1);
  --red:#ff4757;    --red-dim:rgba(255,71,87,.15);
  --yellow:#ffd32a; --yellow-dim:rgba(255,211,42,.12);
  --text:#d8e8f8; --muted:#5a7a9a; --muted2:#8aabcc;
  --fd:'Barlow Condensed',sans-serif;
  --fb:'Barlow',sans-serif;
  --fm:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--fb);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* â”€â”€ SETUP SCREEN â”€â”€ */
#setup-screen{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:2000;padding:20px;overflow-y:auto;
}
.setup-logo{font-family:var(--fd);font-size:42px;font-weight:800;letter-spacing:3px;text-align:center;margin-bottom:4px}
.setup-logo .c{color:var(--corire)} .setup-logo .a{color:var(--aplao)}
.setup-sub{font-family:var(--fd);font-size:12px;letter-spacing:5px;color:var(--muted);text-align:center;margin-bottom:32px}
.setup-card{background:var(--s2);border:1px solid var(--border2);border-radius:16px;padding:28px;width:100%;max-width:480px}
.setup-card h2{font-family:var(--fd);font-size:17px;font-weight:700;letter-spacing:2px;color:var(--muted2);margin-bottom:6px}
.setup-card p{font-size:12px;color:var(--muted);margin-bottom:20px;line-height:1.6}
.step-badge{display:inline-block;background:var(--corire-dim);color:var(--corire);font-family:var(--fd);font-size:11px;font-weight:700;letter-spacing:1px;padding:3px 10px;border-radius:4px;margin-bottom:12px}
.sep{border:none;border-top:1px solid var(--border);margin:20px 0}
.note-box{background:var(--yellow-dim);border:1px solid rgba(255,211,42,.3);border-radius:8px;padding:12px;font-size:11px;color:var(--yellow);line-height:1.6;margin-bottom:16px}
.note-box strong{display:block;margin-bottom:4px;font-size:12px}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#login-screen{
  position:fixed;inset:0;background:var(--bg);
  display:none;flex-direction:column;align-items:center;justify-content:center;
  z-index:1000;padding:24px;
}
.login-logo{font-family:var(--fd);font-size:48px;font-weight:800;letter-spacing:3px;text-align:center;margin-bottom:4px}
.login-logo .c{color:var(--corire)} .login-logo .a{color:var(--aplao)}
.login-sub{font-family:var(--fd);font-size:12px;letter-spacing:6px;color:var(--muted);text-align:center;margin-bottom:40px}
.login-card{background:var(--s2);border:1px solid var(--border2);border-radius:16px;padding:28px;width:100%;max-width:380px}
.login-card h2{font-family:var(--fd);font-size:18px;font-weight:700;letter-spacing:2px;color:var(--muted2);margin-bottom:20px;text-align:center}
.roles-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.role-btn{
  padding:14px 8px;border-radius:10px;border:2px solid var(--border2);
  background:var(--s3);color:var(--text);cursor:pointer;text-align:center;
  transition:.2s;font-family:var(--fd);font-size:14px;font-weight:700;letter-spacing:1px;
}
.role-btn .ri{font-size:22px;display:block;margin-bottom:3px}
.role-btn.selected{border-color:var(--corire);background:var(--corire-dim);color:var(--corire)}

/* â”€â”€ FORM ELEMENTS â”€â”€ */
select,input[type=text],input[type=number],input[type=date],input[type=time],input[type=password]{
  width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:8px;
  color:var(--text);font-family:var(--fm);font-size:14px;padding:10px 12px;
  outline:none;transition:border-color .2s;-webkit-appearance:none;margin-bottom:0;
}
select:focus,input:focus{border-color:var(--corire)}
.fg{margin-bottom:12px}
.fg label{font-family:var(--fd);font-size:10px;font-weight:700;letter-spacing:2px;color:var(--muted);display:block;margin-bottom:4px;text-transform:uppercase}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  display:flex;align-items:center;justify-content:center;gap:7px;
  padding:12px 18px;border-radius:10px;font-family:var(--fd);font-size:15px;
  font-weight:700;letter-spacing:1.5px;cursor:pointer;border:none;
  transition:.15s;width:100%;
}
.btn-primary{background:var(--corire);color:#000}
.btn-primary:hover{filter:brightness(1.1)}
.btn-danger{background:var(--red);color:#fff}
.btn-success{background:var(--mamas);color:#000}
.btn-warning{background:var(--aplao);color:#000}
.btn-ghost{background:var(--s3);color:var(--text);border:1px solid var(--border2)}
.btn-ghost:hover{border-color:var(--corire)}
.btn-sm{padding:7px 14px;font-size:12px;width:auto;border-radius:7px}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* â”€â”€ MAIN APP â”€â”€ */
#app{display:none;min-height:100vh;flex-direction:column}
#app.visible{display:flex}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  background:var(--s1);border-bottom:1px solid var(--border);
  padding:9px 14px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:90;
}
.topbar-logo{font-family:var(--fd);font-size:20px;font-weight:800;letter-spacing:2px}
.topbar-logo .c{color:var(--corire)} .topbar-logo .sep2{color:var(--muted)} .topbar-logo .a{color:var(--aplao)}
.user-pill{background:var(--s3);border:1px solid var(--border2);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;letter-spacing:.5px}
.clock{font-family:var(--fm);font-size:32px;font-weight:700;color:var(--mamas);letter-spacing:2px;line-height:1}
.clock-ampm{font-size:11px;font-weight:400;color:var(--muted2);letter-spacing:1px;vertical-align:middle;margin-left:3px}
.logout-btn{background:none;border:1px solid var(--border2);color:var(--muted);border-radius:6px;padding:4px 9px;cursor:pointer;font-size:11px;transition:.2s}
.logout-btn:hover{border-color:var(--red);color:var(--red)}

/* â”€â”€ ONLINE INDICATOR â”€â”€ */
.online-dot{width:7px;height:7px;border-radius:50%;background:var(--mamas);display:inline-block;margin-right:4px}
.online-dot.offline{background:var(--red)}
.online-dot.syncing{background:var(--yellow);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â”€â”€ ROUTE HEADER â”€â”€ */
.route-header{
  background:var(--s2);border-bottom:1px solid var(--border);
  padding:8px 14px;display:flex;align-items:center;justify-content:center;gap:0;
}
.rh-stop{text-align:center;min-width:64px}
.rh-stop.active .rh-circle{box-shadow:0 0 0 3px rgba(255,255,255,.4);transform:scale(1.12)}
.rh-stop.done .rh-circle{opacity:.7}
.rh-arrow{position:absolute;top:50%;font-size:10px;color:var(--muted2);transform:translateY(-50%)}
.rh-time-below{font-family:var(--fm);font-size:9px;color:var(--muted2);margin-top:3px;letter-spacing:.3px}
.rh-circle{
  width:34px;height:34px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--fd);font-size:8px;font-weight:700;
  letter-spacing:.5px;margin:0 auto 2px;border:2px solid;
}
.rh-c{border-color:var(--corire);color:var(--corire);background:var(--corire-dim)}
.rh-m{border-color:var(--mamas);color:var(--mamas);background:var(--mamas-dim)}
.rh-a{border-color:var(--aplao);color:var(--aplao);background:var(--aplao-dim)}
.rh-name{font-size:9px;font-weight:700;letter-spacing:.5px}
.rh-line{flex:1;height:2px;background:var(--border2);position:relative;max-width:80px}
.rh-time{position:absolute;top:-15px;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:8px;color:var(--muted);white-space:nowrap}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{
  padding:11px 16px;cursor:pointer;font-family:var(--fd);font-size:13px;font-weight:700;
  letter-spacing:1px;color:var(--muted);border-bottom:2px solid transparent;
  white-space:nowrap;transition:.2s;
}
.tab.active{color:var(--corire);border-bottom-color:var(--corire)}

/* â”€â”€ PANELS â”€â”€ */
.panel{display:none;padding:14px;max-width:960px;margin:0 auto;width:100%}
.panel.active{display:block}

/* â”€â”€ GPS BANNER â”€â”€ */
.gps-banner{border-radius:9px;padding:9px 12px;display:flex;align-items:center;gap:9px;margin-bottom:12px;font-size:12px;font-weight:500}
.gps-ok{background:var(--mamas-dim);border:1px solid rgba(59,255,138,.3);color:var(--mamas)}
.gps-err{background:var(--red-dim);border:1px solid rgba(255,71,87,.3);color:var(--red)}
.gps-loading{background:var(--yellow-dim);border:1px solid rgba(255,211,42,.3);color:var(--yellow)}
.gps-dot{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0}
.gps-dot.spin{animation:pulse 1.5s infinite}

/* â”€â”€ SYNC BANNER â”€â”€ */
.sync-banner{
  background:var(--corire-dim);border:1px solid rgba(59,158,255,.3);
  border-radius:9px;padding:8px 12px;font-size:11px;color:var(--corire);
  display:none;align-items:center;gap:8px;margin-bottom:10px;
}
.sync-banner.show{display:flex}

/* â”€â”€ CARDS â”€â”€ */
.card{
  background:var(--s1);border:1px solid var(--border);border-radius:11px;
  padding:16px;margin-bottom:12px;position:relative;overflow:hidden;
}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.card-corire::before{background:var(--corire)}
.card-mamas::before{background:var(--mamas)}
.card-aplao::before{background:var(--aplao)}
.card-red::before{background:var(--red)}
.card-dark::before{background:var(--border2)}
.card-title{font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:2px;color:var(--muted2);margin-bottom:12px;text-transform:uppercase;display:flex;align-items:center;gap:7px}

/* â”€â”€ ALERT â”€â”€ */
.alert{padding:9px 12px;border-radius:7px;font-size:12px;font-weight:500;display:none;margin-bottom:10px}
.alert.show{display:block}
.alert-ok{background:var(--mamas-dim);border:1px solid rgba(59,255,138,.3);color:var(--mamas)}
.alert-err{background:var(--red-dim);border:1px solid rgba(255,71,87,.3);color:var(--red)}
.alert-warn{background:var(--yellow-dim);border:1px solid rgba(255,211,42,.3);color:var(--yellow)}

/* â”€â”€ GEO LOCK â”€â”€ */
.geo-lock{background:var(--red-dim);border:1px solid rgba(255,71,87,.3);border-radius:9px;padding:14px;text-align:center;margin-bottom:12px;display:none}
.geo-lock.show{display:block}
.geo-lock h3{font-family:var(--fd);font-size:16px;color:var(--red);letter-spacing:1px;margin-bottom:4px}
.geo-lock p{font-size:11px;color:var(--muted2)}

/* â”€â”€ PROXIMITY BAR â”€â”€ */
.prox-wrap{margin-bottom:10px;display:none}
.prox-lbl{font-size:10px;color:var(--muted);margin-bottom:3px}
.prox-bar{height:5px;background:var(--s3);border-radius:3px;overflow:hidden}
.prox-fill{height:100%;border-radius:3px;transition:width .5s,background .5s}

/* â”€â”€ STEPS â”€â”€ */
.steps{display:flex;gap:5px;margin-bottom:14px}
.step{flex:1;height:3px;border-radius:2px;background:var(--border2);transition:.3s}
.step.done{background:var(--mamas)}
.step.active{background:var(--corire)}

/* â”€â”€ MONITOR TABLE â”€â”€ */
.tbl-wrap{overflow-x:auto;border-radius:7px}
table{width:100%;border-collapse:collapse;font-size:11px;min-width:560px}
th{background:var(--s2);color:var(--muted);font-family:var(--fd);font-size:9px;font-weight:700;letter-spacing:1.5px;padding:8px 9px;text-align:left;border-bottom:1px solid var(--border)}
td{padding:8px 9px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-family:var(--fd);font-size:10px;font-weight:700;letter-spacing:.5px}
.badge-c{background:var(--corire-dim);color:var(--corire)}
.badge-a{background:var(--aplao-dim);color:var(--aplao)}
.badge-ok{background:rgba(59,255,138,.15);color:var(--mamas)}
.badge-run{background:rgba(59,158,255,.15);color:var(--corire)}
.badge-late{background:var(--red-dim);color:var(--red)}
.badge-warn{background:var(--yellow-dim);color:var(--yellow)}

/* â”€â”€ STATS â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:9px;margin-bottom:12px}
.stat{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:12px;text-align:center}
.stat-val{font-family:var(--fd);font-size:28px;font-weight:800;color:var(--corire);line-height:1}
.stat-lbl{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:3px}

/* â”€â”€ UNITS GRID â”€â”€ */
.units-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:7px}
.unit-card{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:11px;transition:.2s}
.unit-card.running{border-color:var(--corire)}
.unit-card.late{border-color:var(--red);background:rgba(255,71,87,.04)}
.uc-num{font-family:var(--fd);font-size:20px;font-weight:800;line-height:1;color:var(--muted2);margin-bottom:3px}
.unit-card.running .uc-num{color:var(--corire)}
.unit-card.late .uc-num{color:var(--red)}
.uc-name{font-size:10px;color:var(--muted);margin-bottom:5px}
.uc-status{font-size:11px;font-weight:600}
.uc-gps{font-family:var(--fm);font-size:9px;color:var(--muted);margin-top:2px}

/* â”€â”€ MULTA ROW â”€â”€ */
.multa-row{display:flex;gap:7px;align-items:flex-end}
.multa-row .fg{flex:1;margin-bottom:0}

/* â”€â”€ MONTH NAV â”€â”€ */
.month-nav{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.month-lbl{font-family:var(--fd);font-size:20px;font-weight:800;color:var(--aplao);letter-spacing:2px}

/* â”€â”€ GPS IND â”€â”€ */
.gps-ind{display:inline-flex;align-items:center;gap:3px;font-size:10px}
.gps-ind .dot{width:5px;height:5px;border-radius:50%}
.gps-valid .dot{background:var(--mamas)}
.gps-invalid .dot{background:var(--red)}


/* â”€â”€ COUNTDOWN â”€â”€ */
.countdown-box{
  background:var(--s2);border:1px solid var(--border2);border-radius:10px;
  padding:10px 14px;margin-bottom:10px;display:none;
}
.countdown-box.show{display:block}
.cd-label{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.cd-timer{font-family:var(--fm);font-size:28px;font-weight:600;line-height:1}
.cd-timer.green{color:var(--mamas)} .cd-timer.yellow{color:var(--yellow)} .cd-timer.red{color:var(--red)}
.cd-bar{height:4px;background:var(--s3);border-radius:2px;margin-top:6px;overflow:hidden}
.cd-fill{height:100%;border-radius:2px;transition:width 1s linear}

/* â”€â”€ AUTO MARK FLASH â”€â”€ */
@keyframes autoFlash{0%{opacity:1}50%{opacity:.3}100%{opacity:1}}
.auto-flash{animation:autoFlash .5s ease 3}

/* â”€â”€ LIVE MAP â”€â”€ */
.live-map{
  background:var(--s2);border:1px solid var(--border);border-radius:10px;
  padding:12px;margin-bottom:12px;position:relative;overflow:hidden;
}
.live-map-title{font-family:var(--fd);font-size:12px;font-weight:700;letter-spacing:2px;color:var(--muted2);margin-bottom:10px}
.route-svg-wrap{width:100%;overflow:visible}
.unit-dot{transition:cx .5s,cy .5s}

/* â”€â”€ EXPORT BTN â”€â”€ */
.export-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}


/* â”€â”€ INCIDENTE â”€â”€ */
.incidente-btn{
  background:var(--yellow-dim);border:1px solid rgba(255,211,42,.4);
  color:var(--yellow);border-radius:9px;padding:10px 14px;
  font-family:var(--fd);font-size:13px;font-weight:700;letter-spacing:1px;
  cursor:pointer;width:100%;margin-bottom:10px;display:flex;align-items:center;gap:8px;
  transition:.2s;
}
.incidente-btn:hover{background:rgba(255,211,42,.2)}

/* â”€â”€ CHART â”€â”€ */
.chart-wrap{margin-bottom:10px}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.bar-label{font-size:10px;color:var(--muted2);width:48px;text-align:right;flex-shrink:0;font-family:var(--fm)}
.bar-track{flex:1;height:18px;background:var(--s3);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;transition:width .4s;display:flex;align-items:center;padding-left:6px}
.bar-val{font-size:10px;font-weight:700;color:#000;font-family:var(--fm)}

/* â”€â”€ RETOMAR VIAJE BANNER â”€â”€ */
.retomar-banner{
  background:linear-gradient(135deg,rgba(59,158,255,.2),rgba(59,158,255,.08));
  border:2px solid var(--corire);border-radius:12px;
  padding:16px;margin-bottom:12px;display:none;
}
.retomar-banner.show{display:block}
.retomar-title{font-family:var(--fd);font-size:16px;font-weight:800;color:var(--corire);letter-spacing:1px;margin-bottom:6px}
.retomar-info{font-size:12px;color:var(--muted2);margin-bottom:12px;line-height:1.6}
.retomar-btns{display:flex;gap:8px}

/* â”€â”€ OFFLINE BANNER â”€â”€ */
.offline-banner{
  background:var(--yellow-dim);border:1px solid rgba(255,211,42,.4);
  border-radius:8px;padding:8px 12px;font-size:11px;color:var(--yellow);
  display:none;align-items:center;gap:8px;margin-bottom:8px;
}
.offline-banner.show{display:flex}

/* â”€â”€ MAPA GOOGLE â”€â”€ */
#gmap-frame{width:100%;height:280px;border-radius:10px;border:1px solid var(--border2);display:none}
#gmap-frame.show{display:block}

/* â”€â”€ HISTORIAL FECHAS â”€â”€ */
.fecha-nav{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.fecha-lbl{font-family:var(--fm);font-size:13px;color:var(--corire);font-weight:600}

/* â”€â”€ NOMBRE CHOFER â”€â”€ */
.chofer-name-tag{font-size:10px;color:var(--mamas);font-weight:600;margin-top:2px}

/* â”€â”€ MODAL ANULAR â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:500;
  display:none;align-items:center;justify-content:center;padding:20px;
}
.modal-overlay.show{display:flex}
.modal-box{
  background:var(--s2);border:1px solid var(--red);border-radius:14px;
  padding:24px;width:100%;max-width:380px;
}
.modal-title{font-family:var(--fd);font-size:20px;font-weight:800;color:var(--red);
  letter-spacing:1px;margin-bottom:6px}
.modal-sub{font-size:12px;color:var(--muted2);margin-bottom:16px}
.modal-btns{display:flex;gap:10px;margin-top:16px}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

.money{color:var(--red);font-family:var(--fm);font-weight:600}
.ok-txt{color:var(--mamas)}
.mono{font-family:var(--fm)}

/* â”€â”€ FIREBASE STATUS BAR â”€â”€ */
.fb-status{
  display:flex;align-items:center;gap:6px;padding:6px 10px;
  background:var(--s2);border-bottom:1px solid var(--border);
  font-size:10px;color:var(--muted);font-family:var(--fm);
}

/* â”€â”€ COPY BOX â”€â”€ */
.copy-box{
  background:var(--bg);border:1px solid var(--border2);border-radius:6px;
  padding:10px 12px;font-family:var(--fm);font-size:11px;color:var(--corire);
  word-break:break-all;cursor:pointer;transition:.2s;margin-bottom:8px;
}
.copy-box:hover{border-color:var(--corire)}

@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card,.stat,.unit-card{animation:fadeUp .3s ease both}

@media(max-width:520px){
  .frow,.frow3{grid-template-columns:1fr}
  .stats{grid-template-columns:1fr 1fr}
  .units-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr))}
  .multa-row{flex-direction:column}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP SCREEN â€” Configurar Firebase
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen">
  <div class="setup-logo"><span class="c">CORIRE</span> <span style="color:var(--muted)">â†”</span> <span class="a">APLAO</span></div>
  <div class="setup-sub">SISTEMA DE CONTROL DE RUTA</div>

  <div class="setup-card">
    <div class="step-badge" style="background:rgba(59,255,138,.2);color:var(--mamas)">âœ… FIREBASE YA CONFIGURADO</div>
    <h2>Ruta Corireâ€“Aplao</h2>
    <p>Firebase estÃ¡ preconfigurado. Si necesitas cambiar el proyecto, actualiza los campos abajo.</p>

    <div class="note-box">
      <strong>ğŸ“‹ PASOS PARA OBTENER TU FIREBASE CONFIG:</strong>
      1. Ve a <strong>console.firebase.google.com</strong><br>
      2. Clic en "Crear proyecto" â†’ nombre: <em>ruta-corire-aplao</em><br>
      3. En el panel: ConfiguraciÃ³n (âš™ï¸) â†’ "Tus apps" â†’ clic en &lt;/&gt; Web<br>
      4. Registra la app y copia el objeto <em>firebaseConfig</em><br>
      5. Ve a "Realtime Database" â†’ Crear base de datos â†’ Modo de prueba<br>
      6. Pega los valores abajo y guarda.
    </div>

    <div class="frow">
      <div class="fg"><label>API Key</label><input type="text" id="cfg-apikey" placeholder="AIzaSy..."></div>
      <div class="fg"><label>Auth Domain</label><input type="text" id="cfg-authdomain" placeholder="tu-app.firebaseapp.com"></div>
    </div>
    <div class="fg"><label>Database URL</label><input type="text" id="cfg-dburl" placeholder="https://tu-app-default-rtdb.firebaseio.com"></div>
    <div class="frow">
      <div class="fg"><label>Project ID</label><input type="text" id="cfg-projectid" placeholder="ruta-corire-aplao"></div>
      <div class="fg"><label>App ID</label><input type="text" id="cfg-appid" placeholder="1:123:web:abc..."></div>
    </div>

    <div id="setup-alert" class="alert" style="margin-bottom:12px"></div>
    <button class="btn btn-primary" onclick="guardarConfig()">ğŸ’¾ GUARDAR Y CONECTAR</button>

    <div class="sep"></div>
    <p style="font-size:11px;color:var(--muted);text-align:center">
      Â¿Ya tienes la config guardada?
    </p>
    <button class="btn btn-ghost" style="margin-top:8px" onclick="cargarConfigGuardada()">ğŸ“² USAR CONFIG GUARDADA</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-logo"><span class="c">CORIRE</span><span style="color:var(--muted)"> â†” </span><span class="a">APLAO</span></div>
  <div class="login-sub">SISTEMA DE CONTROL</div>

  <div class="login-card">
    <h2>SELECCIONA ROL</h2>
    <div class="roles-grid">
      <div class="role-btn" id="role-chofer" onclick="selectRole('chofer')"><span class="ri">ğŸšŒ</span>CHOFER</div>
      <div class="role-btn" id="role-supervisor" onclick="selectRole('supervisor')"><span class="ri">ğŸ‘®</span>SUPERVISOR</div>
    </div>
    <div id="unit-row" style="display:none">
      <div class="fg"><label>Tu Unidad</label><select id="login-unit"></select></div>
    </div>
    <div id="sup-row" style="display:none">
      <div class="fg"><label>Clave Supervisor</label><input type="password" id="sup-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    </div>
    <div id="login-alert" class="alert" style="margin-bottom:10px"></div>
    <button class="btn btn-primary" onclick="doLogin()">INGRESAR â†’</button>
    <button class="btn btn-ghost" style="margin-top:8px;font-size:11px" onclick="reconfigurar()">âš™ï¸ Cambiar configuraciÃ³n Firebase</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Firebase status bar -->
  <div class="fb-status">
    <div class="online-dot" id="fb-dot"></div>
    <span id="fb-status-txt">Conectando...</span>
    <span style="margin-left:auto" id="last-sync-txt"></span>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="topbar-logo"><span class="c">COR</span><span class="sep2">â€“</span><span class="a">APL</span></div>
      <div class="user-pill" id="user-pill">â€”</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="clock" id="clock">00:00:00</div>
      <button class="logout-btn" onclick="logout()">SALIR</button>
    </div>
  </div>

  <!-- ROUTE HEADER â€” dinÃ¡mico segÃºn viaje -->
  <div class="route-header" id="route-header">
    <!-- Se renderiza por updateRouteDiagram() -->
    <div class="rh-stop"><div class="rh-circle rh-c">COR</div><div class="rh-name" style="color:var(--corire)">CORIRE</div></div>
    <div class="rh-line"><span class="rh-time" id="rh-t1">18 min</span><span class="rh-arrow" style="right:-6px">â†’</span></div>
    <div class="rh-stop"><div class="rh-circle rh-m">MMA</div><div class="rh-name" style="color:var(--mamas)">MAMÃS</div></div>
    <div class="rh-line"><span class="rh-time" id="rh-t2">12 min</span><span class="rh-arrow" style="right:-6px">â†’</span></div>
    <div class="rh-stop"><div class="rh-circle rh-a">APL</div><div class="rh-name" style="color:var(--aplao)">APLAO</div></div>
  </div>

  <div class="tabs" id="tab-bar"></div>

  <!-- â”€â”€ PANEL CHOFER â”€â”€ -->
  <div class="panel" id="panel-chofer">
    <!-- RETOMAR VIAJE BANNER -->
    <div class="retomar-banner" id="retomar-banner">
      <div class="retomar-title">ğŸšŒ TIENES UN VIAJE EN CURSO</div>
      <div class="retomar-info" id="retomar-info">Cargando...</div>
      <div class="retomar-btns">
        <button class="btn btn-primary" style="flex:2" onclick="retomarViaje()">â–¶ï¸ CONTINUAR VIAJE</button>
        <button class="btn btn-danger" style="flex:1" onclick="cancelarViajePropio()">ğŸ—‘ï¸ CANCELAR</button>
      </div>
    </div>

    <!-- OFFLINE BANNER -->
    <div class="offline-banner" id="offline-banner">
      âš ï¸ Sin conexiÃ³n â€” los viajes se guardarÃ¡n localmente y se sincronizarÃ¡n al reconectar
    </div>

    <div class="sync-banner" id="sync-banner">
      <div class="gps-dot spin" style="background:var(--corire)"></div>
      <span id="sync-msg">Sincronizando...</span>
    </div>
    <div class="gps-banner gps-loading" id="gps-banner">
      <div class="gps-dot spin"></div><span id="gps-msg">Obteniendo GPS...</span>
    </div>

    <div class="steps">
      <div class="step active" id="step-1"></div>
      <div class="step" id="step-2"></div>
      <div class="step" id="step-3"></div>
    </div>
    <!-- DEBUG PANEL -->
    <div id="debug-panel" style="background:#111;border:1px solid #333;border-radius:8px;padding:10px;margin-bottom:10px;font-family:monospace;font-size:11px;color:#0f0;display:none">
      <div style="color:#ff0;font-weight:bold;margin-bottom:4px">ğŸ”§ DEBUG (toca MARCAR EN MAMÃS para ver log)</div>
      <div id="debug-log" style="white-space:pre-wrap;line-height:1.6"></div>
      <button onclick="document.getElementById('debug-panel').style.display='none'" style="margin-top:6px;padding:2px 8px;font-size:10px">Cerrar</button>
    </div>



    <!-- SALIDA -->
    <div class="card card-corire" id="card-salida">
      <div class="card-title">ğŸš€ PASO 1 â€” REGISTRAR SALIDA</div>
      <div class="frow">
        <div class="fg"><label>Punto de Salida</label>
          <select id="s-origen" onchange="actualizarProximidad();updateRouteDiagram(this.value)">
            <option value="">â€” Selecciona â€”</option>
            <option value="CORIRE">CORIRE</option>
            <option value="APLAO">APLAO</option>
          </select>
        </div>
        <div class="fg"><label>Hora salida</label><input type="time" id="s-hora"></div>
      </div>
      <div class="prox-wrap" id="prox-salida-wrap">
        <div class="prox-lbl">ğŸ“ Dist. al punto: <span id="prox-dist-salida" style="color:var(--yellow);font-family:var(--fm)">â€”</span></div>
        <div class="prox-bar"><div class="prox-fill" id="prox-fill-salida" style="width:0%"></div></div>
      </div>
      <div class="geo-lock" id="geo-lock-salida">
        <h3>ğŸ“ FUERA DE ZONA</h3>
        <p>Debes estar en el punto de salida.<br>Distancia actual: <strong id="dist-salida-txt">â€”</strong></p>
      </div>
      <div id="salida-alert" class="alert"></div>
      <button class="btn btn-primary" id="btn-salida" onclick="registrarSalida()">ğŸš€ REGISTRAR SALIDA</button>
    </div>

    <!-- INCIDENTE -->
    <div id="incidente-section" style="display:none">
      <button class="incidente-btn" onclick="abrirModalIncidente()">
        ğŸš¨ REPORTAR INCIDENTE
      </button>
    </div>

    <!-- MAMÃS -->
    <div class="card card-mamas" id="card-mamas" style="opacity:.4;pointer-events:none">
      <div class="card-title">ğŸ“ PASO 2 â€” LLEGADA A MAMÃS</div>
      <!-- hora capturada automÃ¡ticamente al tocar botÃ³n -->
      <input type="hidden" id="m-hora">
      <div class="prox-wrap" id="prox-mamas-wrap">
        <div class="prox-lbl">ğŸ“ Dist. a MamÃ¡s: <span id="prox-dist-mamas" style="color:var(--yellow);font-family:var(--fm)">â€”</span></div>
        <div class="prox-bar"><div class="prox-fill" id="prox-fill-mamas" style="width:0%"></div></div>
      </div>

      <!-- COUNTDOWN MAMÃS inside paso 2 -->
      <div class="countdown-box" id="cd-mamas">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <div class="cd-label" style="margin-bottom:0">â±ï¸ TIEMPO PARA LLEGAR A MAMÃS</div>
        </div>
        <div class="cd-timer green" id="cd-mamas-val">--:--</div>
        <div class="cd-bar"><div class="cd-fill" id="cd-mamas-fill" style="width:100%;background:var(--mamas)"></div></div>
      </div>

      <!-- CANCELAR AUTO MAMÃS -->
      <div id="cancel-mamas-box" style="display:none;background:var(--red-dim);border:1px solid rgba(255,71,87,.4);border-radius:10px;padding:14px;text-align:center;margin-bottom:10px">
        <div style="font-family:var(--fd);font-size:18px;font-weight:800;color:var(--red);margin-bottom:4px">ğŸ¤– AUTO-MARCANDO EN <span id="cancel-mamas-count">3</span>s</div>
        <div style="font-size:11px;color:var(--muted2);margin-bottom:10px">El sistema marcarÃ¡ MamÃ¡s automÃ¡ticamente</div>
        <button class="btn btn-danger" onclick="cancelarAutoMamas()" style="max-width:200px;margin:0 auto">âœ‹ CANCELAR</button>
      </div>

      <div class="geo-lock" id="geo-lock-mamas">
        <h3>ğŸ“ FUERA DE ZONA MAMÃS</h3>
        <p>AcÃ©rcate al punto MamÃ¡s. Dist: <strong id="dist-mamas-txt">â€”</strong></p>
      </div>
      <div id="mamas-alert" class="alert"></div>
      <div style="text-align:center;font-size:11px;color:var(--muted);margin-bottom:8px;font-family:var(--fm)">â±ï¸ Se grabarÃ¡ la hora exacta al tocar</div>
      <button class="btn btn-success" onclick="registrarMamas()">ğŸ“ MARCAR EN MAMÃS</button>
      <button onclick="dbg('--- ESTADO ---'); dbg('LOCAL_VIAJE='+(LOCAL_VIAJE?JSON.stringify(LOCAL_VIAJE).substring(0,100):'NULL')); dbg('_viajeEnCurso='+_viajeEnCurso); document.getElementById('debug-panel').style.display='block';" 
        style="margin-top:6px;width:100%;padding:6px;background:#333;color:#0f0;border:1px solid #555;border-radius:6px;font-size:11px;font-family:monospace">
        ğŸ”§ VER DEBUG
      </button>
    </div>

    <!-- LLEGADA -->
    <div class="card card-aplao" id="card-llegada" style="opacity:.4;pointer-events:none">
      <div class="card-title">ğŸ PASO 3 â€” LLEGADA FINAL</div>
      <div class="frow">
        <div class="fg"><label>Destino (automÃ¡tico)</label>
          <select id="l-destino" onchange="actualizarProximidad()" style="display:none">
            <option value="">â€” Selecciona â€”</option>
            <option value="CORIRE">CORIRE</option>
            <option value="APLAO">APLAO</option>
          </select>
          <div id="destino-display" style="background:var(--bg);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:var(--fm);font-size:14px;padding:10px 12px;font-weight:700;letter-spacing:1px">
            â€” AutomÃ¡tico segÃºn origen â€”
          </div>
        </div>
        <!-- hora capturada automÃ¡ticamente al tocar botÃ³n -->
        <input type="hidden" id="l-hora">
      </div>
      <div class="prox-wrap" id="prox-llegada-wrap">
        <div class="prox-lbl">ğŸ“ Dist. al destino: <span id="prox-dist-llegada" style="color:var(--yellow);font-family:var(--fm)">â€”</span></div>
        <div class="prox-bar"><div class="prox-fill" id="prox-fill-llegada" style="width:0%"></div></div>
      </div>

      <!-- COUNTDOWN DESTINO inside paso 3 -->
      <div class="countdown-box" id="cd-destino">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <div class="cd-label" style="margin-bottom:0">â±ï¸ TIEMPO PARA LLEGAR AL DESTINO</div>
        </div>
        <div class="cd-timer green" id="cd-destino-val">--:--</div>
        <div class="cd-bar"><div class="cd-fill" id="cd-destino-fill" style="width:100%;background:var(--corire)"></div></div>
      </div>

      <!-- CANCELAR AUTO LLEGADA -->
      <div id="cancel-llegada-box" style="display:none;background:var(--red-dim);border:1px solid rgba(255,71,87,.4);border-radius:10px;padding:14px;text-align:center;margin-bottom:10px">
        <div style="font-family:var(--fd);font-size:18px;font-weight:800;color:var(--red);margin-bottom:4px">ğŸ¤– AUTO-REGISTRANDO EN <span id="cancel-llegada-count">3</span>s</div>
        <div style="font-size:11px;color:var(--muted2);margin-bottom:10px">El sistema registrarÃ¡ la llegada automÃ¡ticamente</div>
        <button class="btn btn-danger" onclick="cancelarAutoLlegada()" style="max-width:200px;margin:0 auto">âœ‹ CANCELAR</button>
      </div>

      <div class="geo-lock" id="geo-lock-llegada">
        <h3>ğŸ“ FUERA DEL DESTINO</h3>
        <p>Debes estar en el destino. Dist: <strong id="dist-llegada-txt">â€”</strong></p>
      </div>
      <div id="llegada-alert" class="alert"></div>
      <div style="text-align:center;font-size:11px;color:var(--muted);margin-bottom:8px;font-family:var(--fm)">â±ï¸ Se grabarÃ¡ la hora exacta al tocar</div>
      <button class="btn btn-warning" onclick="registrarLlegada()">ğŸ REGISTRAR LLEGADA</button>
    </div>

    <!-- Mis viajes hoy -->
    <div class="card card-dark">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="card-title" style="margin-bottom:0">ğŸ“‹ MIS VIAJES HOY</div>
        <button class="btn btn-ghost btn-sm" onclick="exportarViajes()" style="font-size:11px">ğŸ“¥ EXPORTAR</button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Llegada</th><th>Tardanza</th><th>S/</th></tr></thead>
          <tbody id="historial-chofer-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PANEL MONITOR â”€â”€ -->
  <div class="panel" id="panel-monitor">
    <div class="stats">
      <div class="stat"><div class="stat-val" id="st-total">20</div><div class="stat-lbl">Unidades</div></div>
      <div class="stat"><div class="stat-val" id="st-en-ruta" style="color:var(--corire)">0</div><div class="stat-lbl">En ruta</div></div>
      <div class="stat"><div class="stat-val" id="st-tarde" style="color:var(--red)">0</div><div class="stat-lbl">Tardanza</div></div>
      <div class="stat"><div class="stat-val" id="st-gps-al" style="color:var(--yellow)">0</div><div class="stat-lbl">GPS Alert</div></div>
      <div class="stat"><div class="stat-val" id="st-multas" style="color:var(--red)">S/0</div><div class="stat-lbl">Multas hoy</div></div>
    </div>
    <!-- MAPA VISUAL RUTA -->
    <div class="live-map">
      <div class="live-map-title">ğŸ—ºï¸ MAPA DE RUTA EN TIEMPO REAL Â· <span id="monitor-ts" style="color:var(--mamas);font-family:var(--fm);font-size:10px"></span></div>
      <svg id="route-svg" viewBox="0 0 340 80" width="100%" style="display:block">
        <!-- LÃ­nea de ruta -->
        <line x1="30" y1="40" x2="310" y2="40" stroke="#2e3d50" stroke-width="3"/>
        <!-- Segmento CORIRE-MAMÃS -->
        <line x1="30" y1="40" x2="170" y2="40" stroke="#243040" stroke-width="3"/>
        <!-- Puntos fijos -->
        <circle cx="30" cy="40" r="12" fill="#0e1318" stroke="#3b9eff" stroke-width="2"/>
        <text x="30" y="44" text-anchor="middle" fill="#3b9eff" font-size="7" font-family="Barlow Condensed" font-weight="700">COR</text>
        <text x="30" y="60" text-anchor="middle" fill="#3b9eff" font-size="7" font-family="Barlow Condensed">CORIRE</text>
        <circle cx="170" cy="40" r="12" fill="#0e1318" stroke="#3bff8a" stroke-width="2"/>
        <text x="170" y="44" text-anchor="middle" fill="#3bff8a" font-size="7" font-family="Barlow Condensed" font-weight="700">MMA</text>
        <text x="170" y="60" text-anchor="middle" fill="#3bff8a" font-size="7" font-family="Barlow Condensed">MAMÃS</text>
        <circle cx="310" cy="40" r="12" fill="#0e1318" stroke="#ff9a3b" stroke-width="2"/>
        <text x="310" y="44" text-anchor="middle" fill="#ff9a3b" font-size="7" font-family="Barlow Condensed" font-weight="700">APL</text>
        <text x="310" y="60" text-anchor="middle" fill="#ff9a3b" font-size="7" font-family="Barlow Condensed">APLAO</text>
        <!-- Unidades (puntos dinÃ¡micos) -->
        <g id="svg-units"></g>
      </svg>
      <div style="font-size:9px;color:var(--muted);margin-top:4px;text-align:center">Cada punto = una unidad en ruta. PosiciÃ³n estimada segÃºn tiempo transcurrido.</div>
    </div>

    <div class="card card-dark">
      <div class="card-title">ESTADO EN TIEMPO REAL</div>
      <div class="units-grid" id="units-grid"></div>
    </div>
    <div class="card card-dark">
      <div class="card-title">VIAJES EN CURSO</div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>U#</th><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Esperada</th><th>Tardanza</th><th>GPS</th><th>Acum S/</th><th>âš™ï¸</th></tr></thead>
          <tbody id="monitor-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PANEL SUPERVISOR â”€â”€ -->
  <div class="panel" id="panel-supervisor">
    <div class="card card-dark">
      <div class="card-title">âš™ï¸ TIEMPOS DE RUTA (min)</div>
      <div class="frow3">
        <div class="fg"><label>Corire â†’ MamÃ¡s</label><input type="number" id="t-cm" value="18" min="1" onchange="guardarTiempos()"></div>
        <div class="fg"><label>Corire â†’ Aplao</label><input type="number" id="t-ca" value="31" min="1" onchange="guardarTiempos()"></div>
        <div class="fg"><label>Aplao â†’ MamÃ¡s</label><input type="number" id="t-am" value="19" min="1" onchange="guardarTiempos()"></div>
      </div>
      <div class="frow3">
        <div class="fg"><label>Aplao â†’ Corire</label><input type="number" id="t-ac" value="31" min="1" onchange="guardarTiempos()"></div>
        <div class="fg"><label>MamÃ¡s â†’ Corire</label><input type="number" id="t-mc" value="13" min="1" onchange="guardarTiempos()"></div>
        <div class="fg"><label>MamÃ¡s â†’ Aplao</label><input type="number" id="t-ma" value="12" min="1" onchange="guardarTiempos()"></div>
      </div>
    </div>
    <div class="card card-dark" style="border-color:var(--corire)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="card-title" style="margin-bottom:0">âš™ï¸ CONFIGURACIÃ“N</div>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('modal-clave').classList.add('show')">ğŸ”‘ CAMBIAR CLAVE</button>
      </div>
      <div class="card-title" style="margin-bottom:8px">ğŸ‘¤ NOMBRES DE CHOFERES</div>
      <div id="nombres-choferes-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:7px"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="renderNombresGrid()">âœï¸ Editar nombres</button>
    </div>

    <div class="card card-dark">
      <div class="card-title">ğŸ“ PUNTOS GPS</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--corire);margin-bottom:8px;letter-spacing:1px;padding:5px 8px;background:var(--corire-dim);border-radius:6px;text-align:center">ğŸ”µ CORIRE</div>
          <div class="fg"><label>Lat</label><input type="text" id="lat-corire" value="-16.2163867" onchange="guardarPuntos()"></div>
          <div class="fg"><label>Lon</label><input type="text" id="lon-corire" value="-72.4692981" onchange="guardarPuntos()"></div>
          <div class="fg"><label>Radio (m)</label><input type="number" id="radio-corire" value="300" min="50" max="2000" onchange="guardarPuntos()"></div>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--mamas);margin-bottom:8px;letter-spacing:1px;padding:5px 8px;background:var(--mamas-dim);border-radius:6px;text-align:center">ğŸŸ¢ MAMÃS</div>
          <div class="fg"><label>Lat</label><input type="text" id="lat-mamas" value="-16.1515679" onchange="guardarPuntos()"></div>
          <div class="fg"><label>Lon</label><input type="text" id="lon-mamas" value="-72.4918005" onchange="guardarPuntos()"></div>
          <div class="fg"><label>Radio (m)</label><input type="number" id="radio-mamas" value="200" min="50" max="2000" onchange="guardarPuntos()"></div>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--aplao);margin-bottom:8px;letter-spacing:1px;padding:5px 8px;background:var(--aplao-dim);border-radius:6px;text-align:center">ğŸŸ¡ APLAO</div>
          <div class="fg"><label>Lat</label><input type="text" id="lat-aplao" value="-16.0897344" onchange="guardarPuntos()"></div>
          <div class="fg"><label>Lon</label><input type="text" id="lon-aplao" value="-72.4919021" onchange="guardarPuntos()"></div>
          <div class="fg"><label>Radio (m)</label><input type="number" id="radio-aplao" value="300" min="50" max="2000" onchange="guardarPuntos()"></div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:4px">ğŸ’¡ Google Maps â†’ clic derecho â†’ copiar coordenadas</div>
    </div>
    <div class="card card-red">
      <div class="card-title">âš ï¸ MULTAS EXTERNAS</div>
      <div id="multas-list"></div>
      <div class="multa-row" style="margin-top:8px">
        <div class="fg"><label>Unidad</label><select id="mult-unit"></select></div>
        <div class="fg"><label>Monto S/</label><input type="number" id="mult-monto" placeholder="0" min="1"></div>
        <div class="fg" style="flex:2"><label>Motivo</label><input type="text" id="mult-motivo" placeholder="DescripciÃ³n"></div>
        <button class="btn btn-danger btn-sm" onclick="agregarMulta()">+ MULTA</button>
      </div>
      <div id="mult-alert" class="alert"></div>
    </div>
    <div class="card card-dark" style="border-color:var(--yellow)">
      <div class="card-title" style="color:var(--yellow)">ğŸš¨ INCIDENTES REPORTADOS</div>
      <div id="incidentes-lista" style="font-size:11px;color:var(--muted)">Sin incidentes hoy.</div>
    </div>

    <div class="card card-dark">
      <div class="card-title">ğŸš¨ ALERTAS GPS HOY</div>
      <div id="gps-alertas-list" style="font-size:11px;color:var(--muted)">Sin alertas.</div>
    </div>
    <div class="card card-dark">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="card-title" style="margin-bottom:0">ğŸ“‹ HISTORIAL HOY</div>
        <div class="export-row" style="margin-bottom:0">
          <select id="export-unit-sel" style="padding:6px 10px;font-size:11px;width:auto;margin-bottom:0">
            <option value="all">Todas las unidades</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="exportarViajesSup()" style="font-size:11px">ğŸ“¥ EXPORTAR CSV</button>
        </div>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>U#</th><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Llegada</th><th>Tardanza</th><th>GPS</th><th>S/</th><th>âš™ï¸</th></tr></thead>
          <tbody id="historial-sup-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PANEL REPORTE â”€â”€ -->
  <div class="panel" id="panel-reporte">
    <div class="month-nav">
      <button class="btn btn-ghost btn-sm" style="width:auto" onclick="cambiarMes(-1)">â—€</button>
      <div class="month-lbl" id="mes-lbl"></div>
      <button class="btn btn-ghost btn-sm" style="width:auto" onclick="cambiarMes(1)">â–¶</button>
      <button class="btn btn-danger btn-sm" onclick="cerrarMes()">ğŸ”’ CERRAR MES</button>
      <button class="btn btn-ghost btn-sm" onclick="exportarPDFTodas()" style="font-size:11px">ğŸ“„ PDF GENERAL</button>
    </div>
    <div id="reporte-alert" class="alert"></div>
    <div class="card card-dark">
      <div class="card-title">RESUMEN MENSUAL</div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Unidad</th><th>Viajes</th><th>Min Tarda</th><th>Multa Tard.</th><th>Multas Ext.</th><th>GPS Alertas</th><th>TOTAL S/</th><th>Estado</th><th>PDF</th></tr></thead>
          <tbody id="reporte-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PANEL HISTORIAL (dÃ­as anteriores) â”€â”€ -->
  <div class="panel" id="panel-historial">
    <div class="fecha-nav">
      <button class="btn btn-ghost btn-sm" style="width:auto" onclick="cambiarFechaHist(-1)">â—€</button>
      <div class="fecha-lbl" id="hist-fecha-lbl"></div>
      <button class="btn btn-ghost btn-sm" style="width:auto" onclick="cambiarFechaHist(1)">â–¶</button>
      <button class="btn btn-ghost btn-sm" onclick="exportarHistorialFecha()" style="font-size:11px">ğŸ“¥ CSV</button>
    </div>
    <div class="stats" id="hist-stats"></div>
    <div class="card card-dark">
      <div class="card-title">VIAJES DEL DÃA</div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>U#</th><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Llegada</th><th>Tardanza</th><th>S/</th></tr></thead>
          <tbody id="historial-fecha-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PANEL DASHBOARD â”€â”€ -->
  <div class="panel" id="panel-dashboard">
    <div class="card card-dark">
      <div class="card-title">ğŸ“Š TARDANZA POR UNIDAD (HOY)</div>
      <div id="chart-unidades" class="chart-wrap"></div>
    </div>
    <div class="card card-dark">
      <div class="card-title">ğŸ“ˆ VIAJES POR HORA (HOY)</div>
      <div id="chart-horas" class="chart-wrap"></div>
    </div>
    <div class="card card-dark">
      <div class="card-title">ğŸ† RANKING PUNTUALIDAD (MES)</div>
      <div id="chart-ranking" class="chart-wrap"></div>
    </div>
  </div>

  <!-- â”€â”€ PANEL MAPA GOOGLE â”€â”€ -->
  <div class="panel" id="panel-mapa">
    <div class="card card-dark">
      <div class="card-title">ğŸ“ UBICACIÃ“N EN TIEMPO REAL</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px">PosiciÃ³n GPS actual de las unidades en ruta</div>
      <div id="mapa-unidades-lista" style="margin-bottom:12px"></div>
      <div id="gmap-frame"></div>
      <div style="font-size:10px;color:var(--muted);margin-top:6px;text-align:center">
        ğŸ’¡ Toca una unidad para ver su ubicaciÃ³n en Google Maps
      </div>
    </div>
  </div>

<!-- â•â•â• MODAL ANULAR VIAJE â•â•â• --><!-- â•â•â• MODAL ANULAR VIAJE â•â•â• -->
<div class="modal-overlay" id="modal-anular">
  <div class="modal-box">
    <div class="modal-title">âš ï¸ ANULAR VIAJE</div>
    <div class="modal-sub" id="modal-anular-sub">Unidad â€” Â· Viaje â€”</div>
    <div class="fg">
      <label>Motivo de anulaciÃ³n</label>
      <select id="anular-motivo-sel" onchange="toggleMotivoCustom()">
        <option value="">â€” Selecciona motivo â€”</option>
        <option value="Error de registro">Error de registro</option>
        <option value="Viaje no realizado">Viaje no realizado</option>
        <option value="Falla mecÃ¡nica">Falla mecÃ¡nica</option>
        <option value="Accidente">Accidente</option>
        <option value="Otro">Otro (especificar)</option>
      </select>
    </div>
    <div class="fg" id="motivo-custom-row" style="display:none">
      <label>Especificar motivo</label>
      <input type="text" id="anular-motivo-custom" placeholder="Escribe el motivo...">
    </div>
    <div class="fg">
      <label>Â¿QuÃ© deseas hacer?</label>
      <select id="anular-accion">
        <option value="anular_viaje_activo">Cancelar viaje activo (en ruta)</option>
        <option value="anular_historial">Anular viaje del historial (quitar tardanza)</option>
      </select>
    </div>
    <div class="fg" id="anular-historial-row" style="display:none">
      <label>Selecciona viaje del historial</label>
      <select id="anular-viaje-sel"></select>
    </div>
    <div id="modal-alert" class="alert"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="cerrarModalAnular()" style="flex:1">CANCELAR</button>
      <button class="btn btn-danger" onclick="ejecutarAnulacion()" style="flex:1">ğŸ—‘ï¸ ANULAR</button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL INCIDENTE â•â•â• -->
<div class="modal-overlay" id="modal-incidente">
  <div class="modal-box">
    <div class="modal-title" style="color:var(--yellow)">ğŸš¨ REPORTAR INCIDENTE</div>
    <div class="modal-sub" id="modal-inc-sub">Unidad en ruta</div>
    <div class="fg">
      <label>Tipo de incidente</label>
      <select id="inc-tipo">
        <option value="">â€” Selecciona â€”</option>
        <option value="Falla mecÃ¡nica">ğŸ”§ Falla mecÃ¡nica</option>
        <option value="Accidente">ğŸ’¥ Accidente</option>
        <option value="Demora por trÃ¡fico">ğŸš— Demora por trÃ¡fico</option>
        <option value="Pasajero con emergencia">ğŸ¥ Pasajero con emergencia</option>
        <option value="Pinchazo">ğŸ› Pinchazo</option>
        <option value="Bloqueo de vÃ­a">ğŸš§ Bloqueo de vÃ­a</option>
        <option value="Otro">ğŸ“ Otro</option>
      </select>
    </div>
    <div class="fg">
      <label>DescripciÃ³n</label>
      <input type="text" id="inc-desc" placeholder="Describe brevemente el incidente...">
    </div>
    <div class="fg">
      <label>UbicaciÃ³n actual</label>
      <input type="text" id="inc-ubic" placeholder="Se captura GPS automÃ¡ticamente" readonly style="color:var(--mamas)">
    </div>
    <div id="inc-alert" class="alert"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="cerrarModal('modal-incidente')" style="flex:1">CANCELAR</button>
      <button class="btn btn-warning" onclick="enviarIncidente()" style="flex:1">ğŸ“¤ ENVIAR</button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL CAMBIAR CLAVE â•â•â• -->
<div class="modal-overlay" id="modal-clave">
  <div class="modal-box">
    <div class="modal-title" style="color:var(--corire)">ğŸ”‘ CAMBIAR CLAVE SUPERVISOR</div>
    <div class="modal-sub">La nueva clave se guarda en Firebase</div>
    <div class="fg"><label>Clave actual</label><input type="password" id="clave-actual" placeholder="â€¢â€¢â€¢â€¢"></div>
    <div class="fg"><label>Nueva clave</label><input type="password" id="clave-nueva" placeholder="â€¢â€¢â€¢â€¢"></div>
    <div class="fg"><label>Confirmar nueva clave</label><input type="password" id="clave-confirm" placeholder="â€¢â€¢â€¢â€¢"></div>
    <div id="clave-alert" class="alert"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="cerrarModal('modal-clave')" style="flex:1">CANCELAR</button>
      <button class="btn btn-primary" onclick="cambiarClave()" style="flex:1">ğŸ’¾ GUARDAR</button>
    </div>
  </div>
</div>

</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NUM_U   = 20;
const SUP_KEY_DEFAULT = '1234';
let SUP_KEY_LIVE = localStorage.getItem('sup_clave')||'1234';
const MESES   = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const CHOFERES = Array.from({length:NUM_U},(_,i)=>`Chofer U${String(i+1).padStart(2,'0')}`);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTADO LOCAL (cachÃ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CFG  = null;   // firebase config
let DB   = null;   // firebase database
let SESSION = { role:null, unidad:null };
let gpsPos  = null, gpsWatcher = null;
let mesActual = new Date();

// Datos en memoria (se sincronizan con Firebase)
let DATA = {
  config: {
    tiempos:{ cm:18, ca:31, am:19, ac:31, mc:13, ma:12 },
    puntos:{ CORIRE:{lat:-16.2163867,lon:-72.4692981,radio:300}, MAMAS:{lat:-16.1515679,lon:-72.4918005,radio:200}, APLAO:{lat:-16.0897344,lon:-72.4919021,radio:300} },
    geoRadio:300,
    supClave:'1234',
    choferes:{}
  },
  viajesActivos:{},
  historialDia:{},
  historialArchivo:{},   // dias anteriores: fecha -> viajes
  tardanzaAcum:{},
  multasExternas:{},
  gpsAlertas:{},
  incidentes:{},
  reporteMensual:{}
};
let OFFLINE_QUEUE = JSON.parse(localStorage.getItem('offline_queue')||'[]');
let isOnline = true;
let _viajeEnCurso = false; // true cuando el chofer ya estÃ¡ en un viaje activo en esta sesiÃ³n
let LOCAL_VIAJE = null;  // Estado LOCAL del viaje activo â€” NO se sobreescribe con Firebase

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guardarConfig() {
  const cfg = {
    apiKey:    document.getElementById('cfg-apikey').value.trim(),
    authDomain:document.getElementById('cfg-authdomain').value.trim(),
    databaseURL:document.getElementById('cfg-dburl').value.trim(),
    projectId: document.getElementById('cfg-projectid').value.trim(),
    appId:     document.getElementById('cfg-appid').value.trim()
  };
  if (!cfg.apiKey || !cfg.databaseURL) {
    showSetupAlert('Completa al menos API Key y Database URL','err'); return;
  }
  localStorage.setItem('fb_cfg_v2', JSON.stringify(cfg));
  iniciarFirebase(cfg);
}

function cargarConfigGuardada() {
  const s = localStorage.getItem('fb_cfg_v2');
  if (!s) { showSetupAlert('No hay configuraciÃ³n guardada. Completa los campos.','err'); return; }
  iniciarFirebase(JSON.parse(s));
}

function reconfigurar() {
  document.getElementById('login-screen').style.display='none';
  document.getElementById('setup-screen').style.display='flex';
}

function iniciarFirebase(cfg) {
  try {
    if (firebase.apps.length) firebase.app().delete();
  } catch(e) {}
  try {
    firebase.initializeApp(cfg);
    DB = firebase.database();
    CFG = cfg;

    // Test de conexiÃ³n
    DB.ref('.info/connected').on('value', snap => {
      const online = snap.val();
      document.getElementById('fb-dot').className = 'online-dot' + (online?'':' offline');
      document.getElementById('fb-status-txt').textContent = online ? 'ğŸŸ¢ Firebase conectado' : 'ğŸ”´ Sin conexiÃ³n â€“ modo offline';
    });

    // Cargar datos al conectar
    suscribirDatos();
    document.getElementById('setup-screen').style.display='none';
    document.getElementById('login-screen').style.display='flex';
    showSetupAlert('Conectado correctamente','ok');

  } catch(e) {
    showSetupAlert('Error al conectar: '+e.message,'err');
  }
}

function suscribirDatos() {
  // Config
  DB.ref('config').on('value', snap => {
    if (snap.val()) DATA.config = { ...DATA.config, ...snap.val() };
    if (document.getElementById('t-cm')) actualizarFormsConfig();
  });
  // Viajes activos
  DB.ref('viajesActivos').on('value', snap => {
    DATA.viajesActivos = snap.val() || {};
    // NO llamar checkViajeActivo aquÃ­ â€” solo al hacer login
    if (document.getElementById('units-grid').innerHTML !== '') renderMonitor();
  });
  // Historial del dÃ­a
  DB.ref('historialDia').on('value', snap => {
    DATA.historialDia = snap.val() || {};
    if (SESSION.unidad) renderHistorialChofer();
    if (document.getElementById('historial-sup-tbody')) renderHistorialSup();
    document.getElementById('last-sync-txt').textContent = 'Sync: '+ahoraTxt();
  });
  // Tardanza acumulada
  DB.ref('tardanzaAcum').on('value', snap => { DATA.tardanzaAcum = snap.val() || {}; });
  // Multas externas
  DB.ref('multasExternas').on('value', snap => {
    DATA.multasExternas = snap.val() || {};
    if (document.getElementById('multas-list')) renderMultasLista();
  });
  // GPS alertas
  DB.ref('gpsAlertas').on('value', snap => {
    DATA.gpsAlertas = snap.val() || {};
    if (document.getElementById('gps-alertas-list')) renderGpsAlertas();
  });
  // Reporte mensual
  DB.ref('reporteMensual').on('value', snap => {
    DATA.reporteMensual = snap.val() || {};
  });
  // Incidentes
  DB.ref('incidentes').on('value', snap => {
    DATA.incidentes = snap.val() || {};
    if(document.getElementById('incidentes-lista')) renderIncidentes();
  });
  // Config (incluye clave sup y nombres choferes)
  DB.ref('config/supClave').on('value', snap => {
    if(snap.val()) SUP_KEY_LIVE = snap.val();
  });
  DB.ref('config/choferes').on('value', snap => {
    if(snap.val()) DATA.config.choferes = snap.val();
  });
  // Historial archivo (dÃ­as anteriores)
  DB.ref('historialArchivo').on('value', snap => {
    DATA.historialArchivo = snap.val() || {};
  });
  // Detectar online/offline
  DB.ref('.info/connected').on('value', snap => {
    isOnline = !!snap.val();
    const ob = document.getElementById('offline-banner');
    if(ob) ob.classList.toggle('show', !isOnline);
    if(isOnline && OFFLINE_QUEUE.length > 0) flushOfflineQueue();
  });
}

function fbSet(path, val) {
  if (!DB) return Promise.resolve();
  setSyncBanner(true, 'Guardando...');
  return DB.ref(path).set(val)
    .then(()=>{ setSyncBanner(false); document.getElementById('last-sync-txt').textContent='Sync: '+ahoraTxt(); })
    .catch(e=>{ setSyncBanner(false); console.error('fbSet error',e); });
}
function fbUpdate(path, val) {
  if (!DB) return Promise.resolve();
  setSyncBanner(true, 'Guardando...');
  return DB.ref(path).update(val)
    .then(()=>{ setSyncBanner(false); document.getElementById('last-sync-txt').textContent='Sync: '+ahoraTxt(); })
    .catch(e=>{ setSyncBanner(false); console.error('fbUpdate error',e); });
}
function fbRemove(path) {
  if (!DB) return Promise.resolve();
  return DB.ref(path).remove();
}
function fbPush(path, val) {
  if (!DB) return Promise.resolve();
  setSyncBanner(true, 'Guardando...');
  return DB.ref(path).push(val)
    .then(()=>setSyncBanner(false))
    .catch(e=>setSyncBanner(false));
}

function setSyncBanner(show, msg='') {
  const b=document.getElementById('sync-banner');
  b.classList.toggle('show',show);
  if (msg) document.getElementById('sync-msg').textContent=msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN / LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectRole(role) {
  document.getElementById('role-chofer').classList.toggle('selected',role==='chofer');
  document.getElementById('role-supervisor').classList.toggle('selected',role==='supervisor');
  document.getElementById('unit-row').style.display=role==='chofer'?'block':'none';
  document.getElementById('sup-row').style.display=role==='supervisor'?'block':'none';
  SESSION.role=role;
}

function doLogin() {
  const role=SESSION.role;
  if (!role){ showAlert('login-alert','Selecciona un rol','err'); return; }
  if (role==='supervisor'){
    if (document.getElementById('sup-pass').value!==SUP_KEY_LIVE){ showAlert('login-alert','Clave incorrecta','err'); return; }
    SESSION.unidad=null;
  } else {
    const u=document.getElementById('login-unit').value;
    if (!u){ showAlert('login-alert','Selecciona tu unidad','err'); return; }
    SESSION.unidad=u;
  }
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  document.getElementById('user-pill').textContent = role==='supervisor'
    ? 'ğŸ‘® SUPERVISOR' : `ğŸšŒ U${String(SESSION.unidad).padStart(2,'0')}`;
  buildTabs();
  iniciarGPS();
  poblarSelects();
  actualizarFormsConfig();
  setInterval(tickClock,1000); tickClock();
  setInterval(renderMonitor,15000);
  renderMonitor();
  actualizarMesLabel();
  // Check for active trip after data loads (give Firebase 1.5s to sync)
  if(role==='chofer') setTimeout(()=>{ checkViajeActivo(); updateRouteDiagram(); }, 1500);
  else updateRouteDiagram();
}

function logout() {
  if (gpsWatcher) navigator.geolocation.clearWatch(gpsWatcher);
  SESSION={role:null,unidad:null}; gpsPos=null;
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('role-chofer').classList.remove('selected');
  document.getElementById('role-supervisor').classList.remove('selected');
  document.getElementById('unit-row').style.display='none';
  document.getElementById('sup-row').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS TIEMPO / GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function horaAMin(h){ if(!h)return null; const[hh,mm]=h.split(':').map(Number); return hh*60+mm; }
function minAHora(m){ if(m==null)return'--:--'; return String(Math.floor(m/60)%24).padStart(2,'0')+':'+String(m%60).padStart(2,'0'); }
function ahoraTxt(){ const d=new Date(); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
function tickClock(){
  const d=new Date();
  let h=d.getHours(); const m=d.getMinutes(), s=d.getSeconds();
  const ampm=h>=12?'PM':'AM';
  h=h%12||12;
  document.getElementById('clock').innerHTML=
    String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')+
    '<span class="clock-ampm">'+ampm+'</span>';
}
function tiempoEsp(o,d){ const t=DATA.config.tiempos; return ({CORIRE_APLAO:t.ca,APLAO_CORIRE:t.ac,CORIRE_MAMAS:t.cm,APLAO_MAMAS:t.am,MAMAS_CORIRE:t.mc,MAMAS_APLAO:t.ma})[o+'_'+d]||31; }
function mesKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function hoy(){ return new Date().toISOString().slice(0,10); }

function haversine(la1,lo1,la2,lo2){
  const R=6371000,r=Math.PI/180,dl=(la2-la1)*r,dn=(lo2-lo1)*r;
  const a=Math.sin(dl/2)**2+Math.cos(la1*r)*Math.cos(la2*r)*Math.sin(dn/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function distPunto(nom){
  if(!gpsPos)return Infinity;
  const p=DATA.config.puntos[nom];
  return haversine(gpsPos.lat,gpsPos.lon,p.lat,p.lon);
}
function enZona(nom){
  const p=DATA.config.puntos[nom];
  const radio=(p&&p.radio)?p.radio:(DATA.config.geoRadio||300);
  return distPunto(nom)<=radio;
}
function radioDelPunto(nom){
  const p=DATA.config.puntos[nom];
  return (p&&p.radio)?p.radio:(DATA.config.geoRadio||300);
}

function iniciarGPS(){
  if(!navigator.geolocation){ setBanner('err','GPS no disponible'); return; }
  setBanner('loading','Obteniendo GPS...');
  gpsWatcher=navigator.geolocation.watchPosition(
    pos=>{
      gpsPos={lat:pos.coords.latitude,lon:pos.coords.longitude,acc:pos.coords.accuracy};
      const cerca=puntoMasCercano();
      setBanner('ok',`GPS Â±${Math.round(pos.coords.accuracy)}m Â· Cerca de ${cerca.punto} (${Math.round(cerca.dist)}m)`);
      // Auto-seleccionar origen si no hay viaje activo y no hay origen elegido
      const sel=document.getElementById('s-origen');
      const tieneViaje=LOCAL_VIAJE||_viajeEnCurso;
      if(sel&&!sel.value&&!tieneViaje&&SESSION.role==='chofer'){
        if(cerca.punto==='CORIRE'&&cerca.dist<=600){ sel.value='CORIRE'; updateRouteDiagram('CORIRE'); }
        else if(cerca.punto==='APLAO'&&cerca.dist<=600){ sel.value='APLAO'; updateRouteDiagram('APLAO'); }
      }
      actualizarProximidad();
    },
    ()=>{ gpsPos=null; setBanner('err','GPS desactivado â€“ registros sin validaciÃ³n GPS'); },
    {enableHighAccuracy:true,timeout:15000,maximumAge:5000}
  );
}
function puntoMasCercano(){
  let min=Infinity,best='CORIRE';
  ['CORIRE','MAMAS','APLAO'].forEach(p=>{ const d=distPunto(p); if(d<min){min=d;best=p;} });
  return{punto:best,dist:min};
}
function setBanner(type,msg){
  const b=document.getElementById('gps-banner');
  b.className='gps-banner '+(type==='ok'?'gps-ok':type==='err'?'gps-err':'gps-loading');
  b.innerHTML=`<div class="gps-dot${type==='loading'?' spin':''}"></div><span>${msg}</span>`;
}
function actualizarProximidad(){
  const origen=document.getElementById('s-origen').value;
  if(origen&&gpsPos){
    const r=radioDelPunto(origen);
    const d=Math.round(distPunto(origen));
    const pct=Math.max(0,Math.min(100,(1-d/r)*100));
    document.getElementById('prox-salida-wrap').style.display='block';
    document.getElementById('prox-dist-salida').textContent=d+'m (zona: '+r+'m)';
    document.getElementById('prox-fill-salida').style.cssText=`width:${pct}%;background:${d<=r?'var(--mamas)':'var(--red)'}`;
    document.getElementById('dist-salida-txt').textContent=d+'m';
    document.getElementById('geo-lock-salida').classList.toggle('show',d>r);
  }
  if(gpsPos){
    const r=radioDelPunto('MAMAS');
    const d=Math.round(distPunto('MAMAS'));
    const pct=Math.max(0,Math.min(100,(1-d/r)*100));
    document.getElementById('prox-mamas-wrap').style.display='block';
    document.getElementById('prox-dist-mamas').textContent=d+'m (zona: '+r+'m)';
    document.getElementById('prox-fill-mamas').style.cssText=`width:${pct}%;background:${d<=r?'var(--mamas)':'var(--red)'}`;
    document.getElementById('dist-mamas-txt').textContent=d+'m';
    document.getElementById('geo-lock-mamas').classList.toggle('show',d>r);
  }
  const destino=document.getElementById('l-destino').value;
  if(destino&&gpsPos){
    const r=radioDelPunto(destino);
    const d=Math.round(distPunto(destino));
    const pct=Math.max(0,Math.min(100,(1-d/r)*100));
    document.getElementById('prox-llegada-wrap').style.display='block';
    document.getElementById('prox-dist-llegada').textContent=d+'m (zona: '+r+'m)';
    document.getElementById('prox-fill-llegada').style.cssText=`width:${pct}%;background:${d<=r?'var(--mamas)':'var(--red)'}`;
    document.getElementById('dist-llegada-txt').textContent=d+'m';
    document.getElementById('geo-lock-llegada').classList.toggle('show',d>r);
  }
}
setInterval(()=>{ if(gpsPos)actualizarProximidad(); },5000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTabs(){
  const isSup=SESSION.role==='supervisor';
  const tabs=isSup
    ?[['monitor','ğŸ–¥ï¸ MONITOR'],['dashboard','ğŸ“Š DASHBOARD'],['mapa','ğŸ—ºï¸ MAPA'],['supervisor','ğŸ‘® SUPERVISOR'],['historial','ğŸ“… HISTORIAL'],['reporte','ğŸ“‹ REPORTE']]
    :[['chofer','ğŸšŒ MIS VIAJES'],['monitor','ğŸ–¥ï¸ MONITOR']];
  document.getElementById('tab-bar').innerHTML=tabs.map(([id,lbl],i)=>
    `<div class="tab${i===0?' active':''}" onclick="setTab('${id}')">${lbl}</div>`).join('');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+tabs[0][0]).classList.add('active');
}
function setTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  if(name==='monitor')renderMonitor();
  if(name==='supervisor'){ renderHistorialSup(); renderMultasLista(); renderGpsAlertas(); renderIncidentes(); }
  if(name==='reporte'){ renderReporte(); actualizarMesLabel(); }
  if(name==='dashboard'){ renderDashboard(); }
  if(name==='historial'){ renderHistorialFecha(); }
  if(name==='mapa'){ renderMapaUnidades(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REGISTRO CHOFER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function registrarSalida(){
  const origen=document.getElementById('s-origen').value;
  const hora=document.getElementById('s-hora').value||ahoraTxt();
  if(!origen){ showAlert('salida-alert','Selecciona punto de salida','err'); return; }
  const u=SESSION.unidad;
  let gpsOk=true, dist=null, gpsSnap=null;
  if(gpsPos){ dist=Math.round(distPunto(origen)); gpsOk=dist<=radioDelPunto(origen); gpsSnap={lat:gpsPos.lat,lon:gpsPos.lon,acc:Math.round(gpsPos.acc)}; }
  const destino=origen==='CORIRE'?'APLAO':'CORIRE';
  // Auto-set destino field
  const ldest=document.getElementById('l-destino');
  ldest.value=destino;
  const dd=document.getElementById('destino-display');
  if(dd){
    dd.textContent=destino;
    dd.style.color=destino==='APLAO'?'var(--aplao)':'var(--corire)';
    dd.style.borderColor=destino==='APLAO'?'var(--aplao)':'var(--corire)';
  }
  const espMin=tiempoEsp(origen,destino);
  const salidaMin=horaAMin(hora);
  const esperadaMin=salidaMin+espMin;
  const viaje={ unidad:u, origen, salida:hora, salidaMin, destino, esperadaMin, mamasHora:null, gpsOk, dist, gpsSalida:gpsSnap, id:Date.now(), fecha:hoy() };

  LOCAL_VIAJE = viaje; // guardar localmente ANTES de Firebase
  fbSet('viajesActivos/'+u, viaje);

  if(!gpsOk&&gpsPos){
    fbPush('gpsAlertas', {tipo:'SALIDA',unidad:u,dist,hora,punto:origen,fecha:hoy(),ts:Date.now()});
    showAlert('salida-alert',`âš ï¸ GPS: estÃ¡s a ${dist}m de ${origen}. Salida registrada con alerta.`,'warn');
  } else {
    showAlert('salida-alert',`âœ… Salida de ${origen} a las ${hora}. Llega antes de ${minAHora(esperadaMin)}`,'ok');
  }
  document.getElementById('card-mamas').style.opacity='1';
  document.getElementById('card-mamas').style.pointerEvents='auto';
  document.getElementById('incidente-section').style.display='block';
  _viajeEnCurso = true;
  setStep(2);
  resetAutoLocks();
  iniciarCountdowns();
  updateRouteDiagram(origen);
}

// â”€â”€â”€ PASO 2: MARCAR MAMÃS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dbg(msg) {
  const p = document.getElementById('debug-panel');
  const l = document.getElementById('debug-log');
  if(p && l){ p.style.display='block'; l.textContent += new Date().toLocaleTimeString()+' '+msg+'\n'; }
  console.log('[DBG]', msg);
}

function registrarMamas() {
  dbg('registrarMamas() llamado');
  dbg('LOCAL_VIAJE = ' + JSON.stringify(LOCAL_VIAJE));
  dbg('SESSION.unidad = ' + SESSION.unidad);
  dbg('DATA.viajesActivos keys = ' + Object.keys(DATA.viajesActivos||{}).join(','));
  
  // Usar LOCAL_VIAJE â€” no depende de Firebase
  if (!LOCAL_VIAJE) { 
    dbg('ERROR: LOCAL_VIAJE es null/undefined');
    showAlert('mamas-alert','Sin viaje activo.','err'); return; 
  }
  if (LOCAL_VIAJE.mamasHora) { 
    dbg('WARN: mamasHora ya existe = ' + LOCAL_VIAJE.mamasHora);
    showAlert('mamas-alert','MamÃ¡s ya registrado: '+LOCAL_VIAJE.mamasHora,'warn'); return; 
  }
  dbg('PasÃ³ validaciones OK, continuando...');

  // Limpiar auto-locks
  if (_autoMamasTimer) { clearInterval(_autoMamasTimer); _autoMamasTimer = null; }
  window._autoMamasLock = false; window._cancelMamas = false;
  const cb = document.getElementById('cancel-mamas-box');
  if (cb) cb.style.display = 'none';

  // Capturar hora y GPS
  const hora = ahoraTxt();
  const u = SESSION.unidad;
  let gpsOk = true, dist = null, gpsSnap = null;
  if (gpsPos) {
    dist = Math.round(distPunto('MAMAS'));
    gpsOk = dist <= radioDelPunto('MAMAS');
    gpsSnap = {lat: gpsPos.lat, lon: gpsPos.lon, acc: Math.round(gpsPos.acc)};
  }

  // Calcular tardanza MamÃ¡s
  const mamasEspMin = LOCAL_VIAJE.salidaMin + tiempoEsp(LOCAL_VIAJE.origen, 'MAMAS');
  const mamasLlegMin = horaAMinCross(hora, LOCAL_VIAJE.salida);
  const tardMamas = Math.max(0, mamasLlegMin - mamasEspMin);

  // Actualizar LOCAL_VIAJE inmediatamente (fuente de verdad)
  LOCAL_VIAJE = {...LOCAL_VIAJE, mamasHora: hora, tardMamas, mamasEspMin, gpsMamas: gpsSnap, gpsOkMamas: gpsOk};

  dbg('Guardando en Firebase: hora='+hora+' tardMamas='+tardMamas);
  // Sincronizar con Firebase (asÃ­ncrono, no bloquea UI)
  fbUpdate('viajesActivos/' + u, {
    mamasHora: hora, gpsMamas: gpsSnap, gpsOkMamas: gpsOk,
    tardMamas, mamasEspMin
  });
  if (!gpsOk && gpsPos)
    fbPush('gpsAlertas', {tipo:'MAMÃS', unidad:u, dist, hora, punto:'MAMAS', fecha:hoy(), ts:Date.now()});

  // Mostrar alerta
  showAlert('mamas-alert',
    tardMamas > 0
      ? `âš ï¸ MamÃ¡s +${tardMamas}min tarde Â· Hora: ${hora}`
      : `âœ… MamÃ¡s a tiempo Â· Hora: ${hora}`,
    tardMamas > 0 ? 'warn' : 'ok');

  // Habilitar Paso 3
  const destino = LOCAL_VIAJE.destino;
  const dd = document.getElementById('destino-display');
  if (dd) {
    dd.textContent = destino;
    dd.style.color = destino === 'APLAO' ? 'var(--aplao)' : 'var(--corire)';
    dd.style.borderColor = destino === 'APLAO' ? 'var(--aplao)' : 'var(--corire)';
  }
  document.getElementById('l-destino').value = destino;
  const cardLleg = document.getElementById('card-llegada');
  cardLleg.style.opacity = '1';
  cardLleg.style.pointerEvents = 'auto';
  cardLleg.style.display = 'block';
  document.getElementById('cd-destino').classList.add('show');
  setStep(3);
  dbg('âœ… Paso 3 activado exitosamente');
}

// â”€â”€â”€ PASO 3: REGISTRAR LLEGADA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function registrarLlegada() {
  // Usar LOCAL_VIAJE â€” fuente de verdad local
  if (!LOCAL_VIAJE) { showAlert('llegada-alert','Sin viaje activo.','err'); return; }

  const u = SESSION.unidad;
  const v = LOCAL_VIAJE; // alias claro

  // Limpiar auto-locks
  if (_autoLlegadaTimer) { clearInterval(_autoLlegadaTimer); _autoLlegadaTimer = null; }
  window._autoLlegadaLock = false; window._cancelLlegada = false;
  const cb = document.getElementById('cancel-llegada-box');
  if (cb) cb.style.display = 'none';

  // Capturar hora y GPS
  const hora = ahoraTxt();
  const destino = v.destino;
  let gpsOk = true, dist = null, gpsSnap = null;
  if (gpsPos) {
    dist = Math.round(distPunto(destino));
    gpsOk = dist <= radioDelPunto(destino);
    gpsSnap = {lat: gpsPos.lat, lon: gpsPos.lon, acc: Math.round(gpsPos.acc)};
  }

  // Calcular tardanza total
  const llegadaMin = horaAMinCross(hora, v.salida);
  const tardLlegada = Math.max(0, llegadaMin - v.esperadaMin);
  const tardMamas = v.tardMamas || 0;
  const tardMin = tardLlegada + tardMamas;
  const acumPrev = DATA.tardanzaAcum[u] || 0;
  const acumNuevo = acumPrev + tardMin;
  const todoGpsOk = v.gpsOk !== false && v.gpsOkMamas !== false && gpsOk;

  // Construir registro completo
  const viajeComp = {
    ...v, destinoFinal: destino, llegada: hora, llegadaMin,
    tardanza: tardMin, tardMamas, tardLlegada,
    gpsLlegada: gpsSnap, gpsOkLlegada: gpsOk,
    gpsAlert: !todoGpsOk, completado: Date.now()
  };

  // Limpiar LOCAL_VIAJE ANTES de guardar en Firebase
  LOCAL_VIAJE = null;
  _viajeEnCurso = false;

  // Guardar en Firebase
  fbRemove('viajesActivos/' + u);
  fbPush('historialDia', viajeComp);
  fbSet('tardanzaAcum/' + u, acumNuevo);
  if (!gpsOk && gpsPos)
    fbPush('gpsAlertas', {tipo:'LLEGADA', unidad:u, dist, hora, punto:destino, fecha:hoy(), ts:Date.now()});

  // Mostrar resultado
  let parts = [];
  if (tardMamas > 0) parts.push(`MamÃ¡s +${tardMamas}min`);
  if (tardLlegada > 0) parts.push(`Llegada +${tardLlegada}min`);
  const detalle = parts.length ? ` (${parts.join(', ')})` : '';
  showAlert('llegada-alert',
    tardMin > 0
      ? `âš ï¸ ${tardMin}min tardanza${detalle} Â· Multa S/${tardMin} Â· Acum: S/${acumNuevo}`
      : `âœ… A tiempo en ${destino} Â· Llegada: ${hora}`,
    tardMin > 0 ? 'warn' : 'ok');

  // Reset UI
  resetAutoLocks();
  ocultarCountdowns();
  setStep(1);
  document.getElementById('card-salida').style.opacity = '1';
  document.getElementById('card-salida').style.pointerEvents = 'auto';
  document.getElementById('card-mamas').style.opacity = '0.4';
  document.getElementById('card-mamas').style.pointerEvents = 'none';
  document.getElementById('card-llegada').style.opacity = '0.4';
  document.getElementById('card-llegada').style.pointerEvents = 'none';
  document.getElementById('incidente-section').style.display = 'none';
  document.getElementById('s-origen').value = '';
  document.getElementById('l-destino').value = '';
  const ddR = document.getElementById('destino-display');
  if (ddR) { ddR.textContent = 'â€” AutomÃ¡tico segÃºn origen â€”'; ddR.style.color = ''; ddR.style.borderColor = ''; }
  updateRouteDiagram(null);
  renderHistorialChofer();
}

function setStep(n){
  [1,2,3].forEach(i=>{
    document.getElementById('step-'+i).className='step'+(i<n?' done':i===n?' active':'');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonitor(){
  const now=horaAMin(ahoraTxt());
  let enRuta=0,tarde=0,gpsAl=0,multasHoy=0;
  document.getElementById('monitor-ts').textContent=ahoraTxt();

  const hist=Object.entries(DATA.historialDia||{});
  const mult=Object.values(DATA.multasExternas||{}).filter(m=>m.fecha===hoy());
  hist.forEach(h=>multasHoy+=h.tardanza||0);
  mult.forEach(m=>multasHoy+=m.monto||0);

  let grid='',tbody='';
  for(let i=1;i<=NUM_U;i++){
    const u=String(i);
    const v=DATA.viajesActivos[u];
    const acum=DATA.tardanzaAcum[u]||0;
    if(v){
      enRuta++;
      const tardAct=Math.max(0,now-v.esperadaMin);
      if(tardAct>0){tarde++;
        // Push notification si nueva tardanza
        if(tardAct===1||tardAct===5||tardAct===10) notificarTardanza(u,tardAct);
      }
      if(!v.gpsOk)gpsAl++;
      grid+=`<div class="unit-card ${tardAct>0?'late':'running'}">
        <div class="uc-num">U${String(i).padStart(2,'0')}</div>
        <div class="uc-name">${getNombreChofer(i)}</div>
        <div class="uc-status" style="color:${tardAct>0?'var(--red)':'var(--corire)'}">
          ${tardAct>0?`+${tardAct}min TARDE`:'EN RUTA â–¶'}
        </div>
        <div class="uc-gps">${v.gpsOk!==false?'ğŸ“ GPS OK':'âš ï¸ GPS ALERTA'}</div>
      </div>`;
      const mamasEspMon = minAHora(v.salidaMin + tiempoEsp(v.origen,'MAMAS'));
      const mamasCelda = v.mamasHora
        ? `<span style="color:var(--mamas);font-family:var(--fm)">${v.mamasHora} âœ…</span>`
        : `<span style="color:var(--muted2);font-family:var(--fm)">${mamasEspMon}</span>`;
      tbody+=`<tr>
        <td><strong class="mono">U${String(i).padStart(2,'0')}</strong><div class="chofer-name-tag">${getNombreChofer(i)}</div></td>
        <td><span class="badge badge-${v.origen==='CORIRE'?'c':'a'}">${v.origen}</span></td>
        <td class="mono">${v.salida}</td>
        <td>${mamasCelda}</td>
        <td><span class="badge badge-${v.destino==='CORIRE'?'c':'a'}">${v.destino}</span></td>
        <td class="mono" style="color:var(--mamas)">${minAHora(v.esperadaMin)}</td>
        <td class="${tardAct>0?'money':''}">${tardAct>0?`+${tardAct}m`:'â€”'}</td>
        <td><span class="gps-ind ${v.gpsOk!==false?'gps-valid':'gps-invalid'}"><div class="dot"></div>${v.gpsOk!==false?'OK':'ALERTA'}</span></td>
        <td class="${acum>0?'money':''}">${acum>0?`S/${acum}`:'â€”'}</td>
        <td>${SESSION.role==='supervisor'?`<button class="btn btn-danger btn-sm" onclick="abrirModalAnular('${u}','activo')" style="padding:3px 8px;font-size:10px">ğŸ—‘ï¸</button>`:''}</td>
      </tr>`;
    } else {
      grid+=`<div class="unit-card">
        <div class="uc-num" style="color:var(--muted)">U${String(i).padStart(2,'0')}</div>
        <div class="uc-name">${getNombreChofer(i)}</div>
        <div class="uc-status" style="color:var(--muted)">EN BASE</div>
        <div class="uc-gps" style="color:var(--muted)">${acum>0?`Acum S/${acum}`:''}</div>
      </div>`;
    }
  }
  document.getElementById('units-grid').innerHTML=grid;
  document.getElementById('monitor-tbody').innerHTML=tbody||'<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:16px">Sin unidades en ruta</td></tr>';
  document.getElementById('st-en-ruta').textContent=enRuta;
  document.getElementById('st-tarde').textContent=tarde;
  document.getElementById('st-gps-al').textContent=gpsAl;
  document.getElementById('st-multas').textContent='S/'+multasHoy;
  renderLiveMap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistorialChofer(){
  const u=SESSION.unidad;
  const mis=Object.values(DATA.historialDia||{}).filter(h=>h.unidad===u);
  let rows=mis.length===0?'<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:12px">Sin viajes hoy</td></tr>':'';
  mis.slice().reverse().forEach(h=>{
    rows+=`<tr>
      <td><span class="badge badge-${h.origen==='CORIRE'?'c':'a'}">${h.origen}</span></td>
      <td class="mono">${h.salida}</td>
      <td class="mono">${h.mamasHora||'â€”'}</td>
      <td><span class="badge badge-${h.destinoFinal==='CORIRE'?'c':'a'}">${h.destinoFinal}</span></td>
      <td class="mono">${h.llegada}</td>
      <td class="${h.tardanza>0?'money':'ok-txt'}" title="${h.tardMamas>0?'MamÃ¡s +'+h.tardMamas+'min':''} ${h.tardLlegada>0?'Â· Llegada +'+h.tardLlegada+'min':''}">
        ${h.tardanza>0?`+${h.tardanza}m`:'OK'}
        ${h.tardMamas>0?`<div style="font-size:9px;color:var(--muted2)">M:+${h.tardMamas}m</div>`:''}
      </td>
      <td class="${h.tardanza>0?'money':''}">${h.tardanza>0?`S/${h.tardanza}`:'â€”'}</td>
    </tr>`;
  });
  document.getElementById('historial-chofer-tbody').innerHTML=rows;
}

function renderHistorialSup(){
  const hist=Object.values(DATA.historialDia||{});
  let rows=hist.length===0?'<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:12px">Sin viajes hoy</td></tr>':'';
  hist.slice().reverse().forEach(([key,h])=>{
    const gOk=!h.gpsAlert;
    rows+=`<tr>
      <td><strong class="mono">U${String(h.unidad).padStart(2,'0')}</strong></td>
      <td><span class="badge badge-${h.origen==='CORIRE'?'c':'a'}">${h.origen}</span></td>
      <td class="mono">${h.salida}</td>
      <td class="mono">${h.mamasHora||'â€”'}</td>
      <td><span class="badge badge-${h.destinoFinal==='CORIRE'?'c':'a'}">${h.destinoFinal}</span></td>
      <td class="mono">${h.llegada}</td>
      <td class="${h.anulado?'':''}${h.tardanza>0&&!h.anulado?'money':'ok-txt'}">${h.anulado?'<span class="badge badge-warn">ANULADO</span>':(h.tardanza>0?`+${h.tardanza}m`:'OK')}</td>
      <td><span class="gps-ind ${gOk?'gps-valid':'gps-invalid'}"><div class="dot"></div>${gOk?'OK':'ALERTA'}</span></td>
      <td class="${h.tardanza>0&&!h.anulado?'money':''}">${h.anulado?`<span style="font-size:10px;color:var(--muted)">${h.motivoAnulacion||''}</span>`:(h.tardanza>0?`S/${h.tardanza}`:'â€”')}</td>
      <td><button class="btn btn-danger btn-sm" onclick="abrirModalAnular('${h.unidad}','historial','${key}')" style="padding:3px 8px;font-size:10px">ğŸ—‘ï¸</button></td>
    </tr>`;
  });
  document.getElementById('historial-sup-tbody').innerHTML=rows;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GPS ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGpsAlertas(){
  const el=document.getElementById('gps-alertas-list');
  const alertas=Object.values(DATA.gpsAlertas||{}).filter(a=>a.fecha===hoy());
  if(!alertas.length){ el.innerHTML='<span style="color:var(--muted)">Sin alertas GPS hoy.</span>'; return; }
  el.innerHTML=alertas.map(a=>`
    <div style="display:flex;gap:9px;align-items:center;padding:7px 9px;background:var(--red-dim);border:1px solid rgba(255,71,87,.2);border-radius:6px;margin-bottom:5px;font-size:11px">
      <span style="color:var(--red)">âš ï¸</span>
      <strong style="color:var(--red)">U${String(a.unidad).padStart(2,'0')}</strong>
      <span style="color:var(--muted2)">${a.tipo}</span>
      <span class="mono">${a.hora}</span>
      <span style="color:var(--muted)">${a.dist}m al punto ${a.punto}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function agregarMulta(){
  const u=document.getElementById('mult-unit').value;
  const monto=Number(document.getElementById('mult-monto').value);
  const motivo=document.getElementById('mult-motivo').value.trim();
  if(!u||!monto||!motivo){ showAlert('mult-alert','Completa todos los campos','err'); return; }
  fbPush('multasExternas',{unidad:u,monto,motivo,fecha:hoy(),ts:Date.now()});
  document.getElementById('mult-monto').value='';
  document.getElementById('mult-motivo').value='';
  showAlert('mult-alert',`Multa S/${monto} registrada para U${String(u).padStart(2,'0')}`,'warn');
}
function renderMultasLista(){
  const hoyM=Object.entries(DATA.multasExternas||{}).filter(([,m])=>m.fecha===hoy());
  const el=document.getElementById('multas-list');
  if(!hoyM.length){ el.innerHTML='<p style="color:var(--muted);font-size:11px;margin-bottom:7px">Sin multas externas hoy</p>'; return; }
  el.innerHTML=hoyM.map(([key,m])=>`
    <div style="display:flex;align-items:center;gap:9px;padding:7px 9px;background:var(--s2);border-radius:6px;margin-bottom:5px;font-size:11px">
      <strong>U${String(m.unidad).padStart(2,'0')}</strong>
      <span class="money">S/${m.monto}</span>
      <span style="flex:1;color:var(--muted2)">${m.motivo}</span>
      <button class="btn btn-ghost btn-sm" onclick="fbRemove('multasExternas/${key}')" style="padding:2px 8px;font-size:10px">âœ•</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG SUPERVISOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function actualizarFormsConfig(){
  const c=DATA.config;
  if(!c)return;
  ['cm','ca','am','ac','mc','ma'].forEach(k=>{ const el=document.getElementById('t-'+k); if(el)el.value=c.tiempos[k]; });
  ['CORIRE','MAMAS','APLAO'].forEach(p=>{ const pn=p.toLowerCase();
    const la=document.getElementById('lat-'+pn), lo=document.getElementById('lon-'+pn), ra=document.getElementById('radio-'+pn);
    if(la&&c.puntos[p])la.value=c.puntos[p].lat;
    if(lo&&c.puntos[p])lo.value=c.puntos[p].lon;
    if(ra&&c.puntos[p]&&c.puntos[p].radio)ra.value=c.puntos[p].radio;
  });
}
function guardarTiempos(){
  const t={cm:+document.getElementById('t-cm').value,ca:+document.getElementById('t-ca').value,
            am:+document.getElementById('t-am').value,ac:+document.getElementById('t-ac').value,
            mc:+document.getElementById('t-mc').value,ma:+document.getElementById('t-ma').value};
  fbUpdate('config/tiempos',t);
  DATA.config.tiempos=t;
}
function guardarPuntos(){
  const puntos={
    CORIRE:{lat:+document.getElementById('lat-corire').value, lon:+document.getElementById('lon-corire').value, radio:+document.getElementById('radio-corire').value},
    MAMAS: {lat:+document.getElementById('lat-mamas').value,  lon:+document.getElementById('lon-mamas').value,  radio:+document.getElementById('radio-mamas').value},
    APLAO: {lat:+document.getElementById('lat-aplao').value,  lon:+document.getElementById('lon-aplao').value,  radio:+document.getElementById('radio-aplao').value}
  };
  fbUpdate('config',{puntos});
  DATA.config.puntos=puntos;
  // Compatibilidad: geoRadio global como mÃ¡ximo
  DATA.config.geoRadio=Math.max(puntos.CORIRE.radio, puntos.MAMAS.radio, puntos.APLAO.radio);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORTE MENSUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function actualizarMesLabel(){ document.getElementById('mes-lbl').textContent=MESES[mesActual.getMonth()]+' '+mesActual.getFullYear(); }
function cambiarMes(d){ mesActual=new Date(mesActual.getFullYear(),mesActual.getMonth()+d,1); actualizarMesLabel(); renderReporte(); }

function renderReporte(){
  const mk=mesKey(mesActual);
  const datos=(DATA.reporteMensual||{})[mk]||{};
  const esMesActual=mk===mesKey(new Date());
  let rows='',total=0;
  for(let i=1;i<=NUM_U;i++){
    const u=String(i);
    let viajes=0,minT=0,multE=0,gpsAl=0;
    if(datos[u]){ viajes=datos[u].viajes||0; minT=datos[u].minTardanza||0; multE=datos[u].multasExternas||0; gpsAl=datos[u].gpsAlertas||0; }
    if(esMesActual){
      viajes+=Object.values(DATA.historialDia||{}).filter(h=>h.unidad===u).length;
      minT+=DATA.tardanzaAcum[u]||0;
      multE+=Object.values(DATA.multasExternas||{}).filter(m=>m.unidad===u).reduce((s,m)=>s+m.monto,0);
      gpsAl+=Object.values(DATA.gpsAlertas||{}).filter(a=>a.unidad===u&&a.fecha===hoy()).length;
    }
    const tot=minT+multE; total+=tot;
    rows+=`<tr>
      <td><strong class="mono">U${String(i).padStart(2,'0')}</strong><div class="chofer-name-tag">${getNombreChofer(i)}</div></td>
      <td style="text-align:center">${viajes}</td>
      <td class="${minT>0?'money':''}" style="text-align:center">${minT}</td>
      <td class="${minT>0?'money':''}">${minT>0?`S/ ${minT}`:'â€”'}</td>
      <td class="${multE>0?'money':''}">${multE>0?`S/ ${multE}`:'â€”'}</td>
      <td style="color:${gpsAl>0?'var(--yellow)':'var(--muted)'};text-align:center">${gpsAl>0?`âš ï¸${gpsAl}`:'â€”'}</td>
      <td class="${tot>0?'money':''}" style="font-weight:700">${tot>0?`S/ ${tot}`:'â€”'}</td>
      <td><span class="badge ${datos[u]&&datos[u].cerrado?'badge-late':'badge-run'}">${datos[u]&&datos[u].cerrado?'CERRADO':'ABIERTO'}</span></td>
    </tr>`;
  }
  rows+=`<tr style="background:var(--s2)">
    <td colspan="6" style="text-align:right;font-weight:700;color:var(--muted2)">TOTAL DESCUENTOS:</td>
    <td class="money" style="font-size:14px;font-weight:700">S/ ${total}</td><td></td>
  </tr>`;
  document.getElementById('reporte-tbody').innerHTML=rows;
}

function cerrarMes(){
  if(!confirm('Â¿Cerrar el mes? Se consolidan todas las multas y tardanzas en el reporte.'))return;
  archivarDiaActual();
  const mk=mesKey(mesActual);
  const nuevo={};
  const hist=Object.values(DATA.historialDia||{});
  const multext=Object.values(DATA.multasExternas||{});
  const gpsAl=Object.values(DATA.gpsAlertas||{});
  for(let i=1;i<=NUM_U;i++){
    const u=String(i);
    const prev=(DATA.reporteMensual[mk]||{})[u]||{};
    nuevo[u]={
      viajes:(prev.viajes||0)+hist.filter(h=>h.unidad===u).length,
      minTardanza:(prev.minTardanza||0)+(DATA.tardanzaAcum[u]||0),
      multasExternas:(prev.multasExternas||0)+multext.filter(m=>m.unidad===u).reduce((s,m)=>s+m.monto,0),
      gpsAlertas:(prev.gpsAlertas||0)+gpsAl.filter(a=>a.unidad===u).length,
      cerrado:true
    };
  }
  fbUpdate('reporteMensual',{[mk]:nuevo});
  fbSet('historialDia',null);
  fbSet('tardanzaAcum',null);
  fbSet('multasExternas',null);
  fbSet('gpsAlertas',null);
  fbSet('viajesActivos',null);
  DATA.historialDia={}; DATA.tardanzaAcum={}; DATA.multasExternas={}; DATA.gpsAlertas={}; DATA.viajesActivos={};
  showAlert('reporte-alert','ğŸ”’ Mes cerrado y guardado en Firebase.','ok');
  renderReporte(); renderMonitor();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function poblarSelects(){
  ['login-unit','mult-unit'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    el.innerHTML='<option value="">â€” Selecciona â€”</option>';
    for(let i=1;i<=NUM_U;i++) el.innerHTML+=`<option value="${i}">U${String(i).padStart(2,'0')} Â· ${CHOFERES[i-1]}</option>`;
  });
  const h=ahoraTxt();
  // Solo hora de salida es editable por el chofer
  const sh=document.getElementById('s-hora'); if(sh&&!sh.value)sh.value=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAlert(id,msg,type){
  const el=document.getElementById(id);
  if(!el)return;
  el.className=`alert alert-${type==='ok'?'ok':type==='warn'?'warn':'err'} show`;
  el.textContent=msg;
  setTimeout(()=>el.classList.remove('show'),6000);
}
function showSetupAlert(msg,type){ showAlert('setup-alert',msg,type); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Poblar login-unit aunque no se haya logueado aÃºn
(()=>{
  const el=document.getElementById('login-unit');
  el.innerHTML='<option value="">â€” Tu unidad â€”</option>';
  for(let i=1;i<=NUM_U;i++) el.innerHTML+=`<option value="${i}">U${String(i).padStart(2,'0')} Â· ${CHOFERES[i-1]}</option>`;
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OFFLINE QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fbSetOfflineSafe(path,val){if(isOnline)return fbSet(path,val);OFFLINE_QUEUE.push({op:'set',path,val,ts:Date.now()});localStorage.setItem('offline_queue',JSON.stringify(OFFLINE_QUEUE));return Promise.resolve();}
function fbPushOfflineSafe(path,val){if(isOnline)return fbPush(path,val);OFFLINE_QUEUE.push({op:'push',path,val,ts:Date.now()});localStorage.setItem('offline_queue',JSON.stringify(OFFLINE_QUEUE));return Promise.resolve();}
function flushOfflineQueue(){if(!OFFLINE_QUEUE.length)return;const q=[...OFFLINE_QUEUE];OFFLINE_QUEUE=[];localStorage.setItem('offline_queue','[]');q.forEach(item=>{if(item.op==='set')fbSet(item.path,item.val);else if(item.op==='push')fbPush(item.path,item.val);});showAlert('salida-alert','âœ… '+q.length+' registro(s) sincronizados','ok');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INCIDENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirModalIncidente(){const v=LOCAL_VIAJE||DATA.viajesActivos[SESSION.unidad];const u='U'+String(SESSION.unidad).padStart(2,'0');document.getElementById('modal-inc-sub').textContent=v?`${u} Â· ${v.origen} â†’ ${v.destino} Â· Salida ${v.salida}`:u;const ub=document.getElementById('inc-ubic');if(gpsPos&&ub)ub.value=`${gpsPos.lat.toFixed(5)}, ${gpsPos.lon.toFixed(5)}`;else if(ub)ub.value='GPS no disponible';document.getElementById('inc-tipo').value='';document.getElementById('inc-desc').value='';document.getElementById('inc-alert').className='alert';document.getElementById('modal-incidente').classList.add('show');}
function enviarIncidente(){const tipo=document.getElementById('inc-tipo').value;const desc=document.getElementById('inc-desc').value.trim();if(!tipo){showAlert('inc-alert','Selecciona el tipo de incidente','err');return;}const v=LOCAL_VIAJE||DATA.viajesActivos[SESSION.unidad];const inc={unidad:SESSION.unidad,tipo,desc,hora:ahoraTxt(),fecha:hoy(),gps:gpsPos?{lat:gpsPos.lat,lon:gpsPos.lon}:null,origen:v?.origen||'',destino:v?.destino||'',ts:Date.now()};fbPush('incidentes',inc);beep(880,200,0.4);showAlert('inc-alert','âœ… Incidente reportado correctamente','ok');setTimeout(()=>cerrarModal('modal-incidente'),1500);}
function renderIncidentes(){const el=document.getElementById('incidentes-lista');if(!el)return;const incs=Object.values(DATA.incidentes||{}).filter(i=>i.fecha===hoy());if(!incs.length){el.innerHTML='<span style="color:var(--muted)">Sin incidentes hoy.</span>';return;}el.innerHTML=incs.sort((a,b)=>b.ts-a.ts).map(i=>`<div style="background:var(--yellow-dim);border:1px solid rgba(255,211,42,.25);border-radius:7px;padding:9px 11px;margin-bottom:6px"><div style="display:flex;gap:8px;align-items:center;margin-bottom:3px"><strong style="color:var(--yellow)">U${String(i.unidad).padStart(2,'00')}</strong><span class="mono" style="font-size:10px">${i.hora}</span><span style="background:var(--s3);border-radius:4px;padding:1px 7px;font-size:10px;color:var(--aplao)">${i.tipo}</span></div><div style="font-size:11px;color:var(--muted2)">${i.desc||'Sin descripciÃ³n'}</div></div>`).join('');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAMBIAR CLAVE SUPERVISOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cambiarClave(){const actual=document.getElementById('clave-actual').value;const nueva=document.getElementById('clave-nueva').value;const conf=document.getElementById('clave-confirm').value;if(actual!==SUP_KEY_LIVE){showAlert('clave-alert','Clave actual incorrecta','err');return;}if(nueva.length<4){showAlert('clave-alert','MÃ­nimo 4 caracteres','err');return;}if(nueva!==conf){showAlert('clave-alert','Las claves no coinciden','err');return;}SUP_KEY_LIVE=nueva;localStorage.setItem('sup_clave',nueva);fbUpdate('config',{supClave:nueva});showAlert('clave-alert','âœ… Clave cambiada correctamente','ok');setTimeout(()=>cerrarModal('modal-clave'),1500);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORIAL DE DÃAS ANTERIORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fechaHistorial=new Date();
function cambiarFechaHist(d){fechaHistorial=new Date(fechaHistorial.getFullYear(),fechaHistorial.getMonth(),fechaHistorial.getDate()+d);renderHistorialFecha();}
function renderHistorialFecha(){
  const fk=fechaHistorial.toISOString().slice(0,10);
  const esHoy=fk===hoy();
  document.getElementById('hist-fecha-lbl').textContent=esHoy?'ğŸ“… HOY':fk;
  let viajes=[];
  if(esHoy){viajes=Object.values(DATA.historialDia||{});}
  else{viajes=Object.values((DATA.historialArchivo||{})[fk]||{});if(!viajes.length){const local=JSON.parse(localStorage.getItem('hist_'+fk)||'[]');viajes=local;}}
  const tot=viajes.length,tarde=viajes.filter(v=>v.tardanza>0).length,multa=viajes.reduce((s,v)=>s+(v.tardanza||0),0);
  document.getElementById('hist-stats').innerHTML=`<div class="stat"><div class="stat-val">${tot}</div><div class="stat-lbl">Viajes</div></div><div class="stat"><div class="stat-val" style="color:var(--red)">${tarde}</div><div class="stat-lbl">Con tardanza</div></div><div class="stat"><div class="stat-val" style="color:var(--red)">S/${multa}</div><div class="stat-lbl">Multas</div></div><div class="stat"><div class="stat-val" style="color:var(--mamas)">${tot-tarde}</div><div class="stat-lbl">A tiempo</div></div>`;
  let rows=viajes.length?'':'<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:16px">Sin datos para esta fecha</td></tr>';
  viajes.forEach(h=>{rows+=`<tr><td><strong class="mono">U${String(h.unidad).padStart(2,'00')}</strong></td><td><span class="badge badge-${h.origen==='CORIRE'?'c':'a'}">${h.origen}</span></td><td class="mono">${h.salida}</td><td class="mono">${h.mamasHora||'â€”'}</td><td><span class="badge badge-${(h.destinoFinal||h.destino)==='CORIRE'?'c':'a'}">${h.destinoFinal||h.destino}</span></td><td class="mono">${h.llegada||'â€”'}</td><td class="${h.tardanza>0?'money':'ok-txt'}">${h.tardanza>0?'+'+h.tardanza+'m':'OK'}</td><td class="${h.tardanza>0?'money':''}">${h.tardanza>0?'S/'+h.tardanza:'â€”'}</td></tr>`;});
  document.getElementById('historial-fecha-tbody').innerHTML=rows;
}
function exportarHistorialFecha(){const fk=fechaHistorial.toISOString().slice(0,10);const viajes=fk===hoy()?Object.values(DATA.historialDia||{}):Object.values((DATA.historialArchivo||{})[fk]||{});if(!viajes.length){alert('Sin datos');return;}descargarCSV(viajes,'historial_'+fk+'.csv');}
function archivarDiaActual(){const fk=hoy();const viajes=DATA.historialDia||{};if(Object.keys(viajes).length){fbUpdate('historialArchivo',{[fk]:viajes});localStorage.setItem('hist_'+fk,JSON.stringify(Object.values(viajes)));}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD / GRÃFICAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){renderChartUnidades();renderChartHoras();renderChartRanking();}
function renderChartUnidades(){const el=document.getElementById('chart-unidades');if(!el)return;const hist=Object.values(DATA.historialDia||{});const tardByUnit={};for(let i=1;i<=NUM_U;i++)tardByUnit[i]=0;hist.forEach(h=>{if(h.tardanza>0)tardByUnit[h.unidad]=(tardByUnit[h.unidad]||0)+h.tardanza;});const units=Object.entries(tardByUnit).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,10);if(!units.length){el.innerHTML='<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">âœ… Sin tardanzas hoy</div>';return;}const max=Math.max(...units.map(([,v])=>v),1);el.innerHTML=units.map(([u,v])=>`<div class="bar-row"><div class="bar-label">U${String(u).padStart(2,'00')}</div><div class="bar-track"><div class="bar-fill" style="width:${(v/max*100).toFixed(1)}%;background:var(--red)"><span class="bar-val">${v}m Â· S/${v}</span></div></div></div>`).join('');}
function renderChartHoras(){const el=document.getElementById('chart-horas');if(!el)return;const hist=Object.values(DATA.historialDia||{});const byHora={};for(let h=4;h<=22;h++)byHora[h]=0;hist.forEach(h=>{const hr=parseInt(h.salida?.split(':')[0]||0);if(byHora[hr]!==undefined)byHora[hr]++;});const max=Math.max(...Object.values(byHora),1);el.innerHTML=Object.entries(byHora).filter(([,v])=>v>0).map(([hr,v])=>`<div class="bar-row"><div class="bar-label">${String(hr).padStart(2,'00')}:00</div><div class="bar-track"><div class="bar-fill" style="width:${(v/max*100).toFixed(1)}%;background:var(--corire)"><span class="bar-val">${v} viajes</span></div></div></div>`).join('')||'<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Sin viajes hoy</div>';}
function renderChartRanking(){const el=document.getElementById('chart-ranking');if(!el)return;const mk=mesKey(new Date());const rep=(DATA.reporteMensual||{})[mk]||{};const unidades=[];for(let i=1;i<=NUM_U;i++){const u=String(i);const viajes=(rep[u]?.viajes||0)+Object.values(DATA.historialDia||{}).filter(h=>h.unidad===u).length;const minT=(rep[u]?.minTardanza||0)+(DATA.tardanzaAcum[u]||0);if(viajes>0)unidades.push({u,viajes,minT,pct:Math.max(0,((viajes-Math.min(viajes,Math.ceil(minT/5)))/viajes*100)).toFixed(0)});}unidades.sort((a,b)=>b.pct-a.pct);if(!unidades.length){el.innerHTML='<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Sin datos este mes</div>';return;}el.innerHTML=unidades.slice(0,10).map((u,i)=>`<div class="bar-row"><div class="bar-label">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'  '}U${String(u.u).padStart(2,'00')}</div><div class="bar-track"><div class="bar-fill" style="width:${u.pct}%;background:${u.pct>80?'var(--mamas)':u.pct>60?'var(--yellow)':'var(--red)'}"><span class="bar-val">${u.pct}%</span></div></div></div>`).join('');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAPA GOOGLE MAPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMapaUnidades(){const el=document.getElementById('mapa-unidades-lista');if(!el)return;const activos=Object.entries(DATA.viajesActivos||{});if(!activos.length){el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:10px">Sin unidades en ruta.</div>';return;}el.innerHTML=activos.map(([u,v])=>{const now=horaAMin(ahoraTxt());const tard=Math.max(0,now-v.esperadaMin);const hasGPS=v.gpsSalida&&v.gpsSalida.lat;return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--s2);border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="abrirGoogleMaps('${u}')"><strong style="color:${tard>0?'var(--red)':'var(--corire)'}">U${String(u).padStart(2,'00')}</strong><span style="font-size:11px">${v.origen} â†’ ${v.destino}</span><span class="mono" style="font-size:10px">${v.salida}</span>${tard>0?`<span class="badge badge-late">+${tard}m</span>`:'<span class="badge badge-ok">OK</span>'}<span style="font-size:10px;color:var(--muted);margin-left:auto">${hasGPS?'ğŸ“ GPS':'ğŸ“ Sin GPS'}</span><span style="font-size:11px;color:var(--corire)">Ver â†’</span></div>`;}).join('');}
function abrirGoogleMaps(unidad){const v=DATA.viajesActivos[unidad];if(!v)return;const gps=v.gpsMamas||v.gpsSalida;if(gps&&gps.lat){window.open(`https://www.google.com/maps?q=${gps.lat},${gps.lon}&z=15`,'_blank');}else{window.open(`https://www.google.com/maps/dir/${DATA.config.puntos.CORIRE.lat},${DATA.config.puntos.CORIRE.lon}/${DATA.config.puntos.MAMAS.lat},${DATA.config.puntos.MAMAS.lon}/${DATA.config.puntos.APLAO.lat},${DATA.config.puntos.APLAO.lon}`,'_blank');}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOMBRES CHOFERES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getNombreChofer(unidad){return(DATA.config?.choferes||{})[unidad]||CHOFERES[unidad-1];}
function guardarNombreChofer(unidad,nombre){if(!nombre.trim())return;fbUpdate('config/choferes',{[unidad]:nombre.trim()});DATA.config.choferes=DATA.config.choferes||{};DATA.config.choferes[unidad]=nombre.trim();}
function renderNombresGrid(){const el=document.getElementById('nombres-choferes-grid');if(!el)return;el.innerHTML=Array.from({length:NUM_U},(_,i)=>{const u=i+1;const nombre=getNombreChofer(u);return`<div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;color:var(--muted);font-family:var(--fm);width:26px">U${String(u).padStart(2,'00')}</span><input type="text" value="${nombre}" id="nombre-u${u}" style="font-size:11px;padding:5px 8px;flex:1" onblur="guardarNombreChofer(${u},this.value)" placeholder="Nombre chofer"></div>`;}).join('');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PUSH NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function solicitarNotificaciones(){if(!('Notification'in window))return;Notification.requestPermission();}
function notificarTardanza(unidad,minutos){if(Notification.permission!=='granted')return;if(SESSION.role!=='supervisor')return;const nombre=getNombreChofer(unidad);new Notification('âš ï¸ Tardanza detectada',{body:`${nombre} (U${String(unidad).padStart(2,'00')}) lleva +${minutos} min de tardanza`,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸšŒ</text></svg>'});}
let _notifEnviadas={};
setInterval(()=>{if(SESSION.role!=='supervisor')return;if(Notification.permission!=='granted')return;const now=horaAMin(ahoraTxt());Object.entries(DATA.viajesActivos||{}).forEach(([u,v])=>{if(!v)return;const tard=Math.max(0,now-v.esperadaMin);if(tard>0&&(tard===1||tard===5||tard===10||tard%15===0)&&!_notifEnviadas[u+':'+tard]){_notifEnviadas[u+':'+tard]=true;notificarTardanza(u,tard);}});},60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPER: cerrarModal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cerrarModal(id){document.getElementById(id).classList.remove('show');}
['modal-incidente','modal-clave'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('click',function(e){if(e.target===this)cerrarModal(id);});});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORTE PDF MENSUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarPDFUnidad(unidadNum) {
  const u = unidadNum || (prompt('NÃºmero de unidad (1-20):'));
  if (!u) return;
  const un = parseInt(u);
  const mk = mesKey(new Date());
  const rep = (DATA.reporteMensual||{})[mk]||{};
  const datos = rep[String(un)]||{};
  const nombre = getNombreChofer(un);
  const mesNom = MESES[mesActual.getMonth()] + ' ' + mesActual.getFullYear();

  // Viajes del historial archivo del mes
  const todosViajes = [];
  Object.entries(DATA.historialArchivo||{}).forEach(([fecha,diaViajes])=>{
    if(fecha.startsWith(mk)) {
      Object.values(diaViajes||{}).filter(v=>v.unidad==un).forEach(v=>todosViajes.push({...v,fecha}));
    }
  });
  // TambiÃ©n hoy si coincide el mes
  Object.values(DATA.historialDia||{}).filter(v=>v.unidad==un).forEach(v=>todosViajes.push({...v,fecha:hoy()}));

  const totalViajes = todosViajes.length || datos.viajes || 0;
  const totalTard = datos.minTardanza || (DATA.tardanzaAcum[un]||0);
  const totalMulExt = datos.multasExt || 0;
  const totalGPS = datos.gpsAlertas || 0;
  const totalMulta = totalTard + totalMulExt;

  const filas = todosViajes.sort((a,b)=>a.fecha>b.fecha?1:-1).map(v=>`
    <tr>
      <td>${v.fecha||''}</td>
      <td>${v.origen||''}</td>
      <td>${v.salida||''}</td>
      <td>${v.mamasHora||'â€”'}</td>
      <td>${v.destinoFinal||v.destino||''}</td>
      <td>${v.llegada||'â€”'}</td>
      <td style="color:${v.tardanza>0?'#c0392b':'#27ae60'}">${v.tardanza>0?'+'+v.tardanza+'m':'âœ“'}</td>
      <td style="color:${v.tardanza>0?'#c0392b':'#999'}">${v.tardanza>0?'S/'+v.tardanza:'â€”'}</td>
    </tr>`).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>Reporte ${nombre} - ${mesNom}</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:12px;color:#111;margin:20px}
    h1{font-size:20px;color:#1a3a6b;margin-bottom:4px}
    h2{font-size:14px;color:#555;margin-bottom:20px;font-weight:normal}
    .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;border-bottom:2px solid #1a3a6b;padding-bottom:12px}
    .logo{font-size:24px;font-weight:800;color:#1a3a6b;letter-spacing:2px}
    .resumen{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
    .stat-box{background:#f0f4f8;border-radius:8px;padding:12px;text-align:center;border-left:3px solid #1a3a6b}
    .stat-box.red{border-left-color:#c0392b;background:#fff0f0}
    .stat-box.green{border-left-color:#27ae60;background:#f0fff4}
    .stat-num{font-size:24px;font-weight:700;margin-bottom:4px}
    .stat-lbl{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
    table{width:100%;border-collapse:collapse;font-size:11px}
    th{background:#1a3a6b;color:#fff;padding:7px 8px;text-align:left;font-size:10px;letter-spacing:.5px}
    td{padding:6px 8px;border-bottom:1px solid #e8edf2}
    tr:nth-child(even)td{background:#f7f9fb}
    .footer{margin-top:20px;font-size:10px;color:#999;text-align:center;border-top:1px solid #ddd;padding-top:10px}
    @media print{body{margin:10px}.no-print{display:none}}
  </style></head><body>
  <div class="header">
    <div>
      <div class="logo">CORâ€“APL</div>
      <h1>Reporte Mensual de Unidad</h1>
      <h2>${nombre} Â· U${String(un).padStart(2,'0')} Â· ${mesNom}</h2>
    </div>
    <div style="text-align:right;font-size:11px;color:#666">
      Generado: ${new Date().toLocaleString('es-PE')}<br>
      Ruta: Corire â€“ MamÃ¡s â€“ Aplao
    </div>
  </div>
  <div class="resumen">
    <div class="stat-box green"><div class="stat-num">${totalViajes}</div><div class="stat-lbl">Total Viajes</div></div>
    <div class="stat-box ${totalTard>0?'red':'green'}"><div class="stat-num" style="color:${totalTard>0?'#c0392b':'#27ae60'}">${totalTard} min</div><div class="stat-lbl">Min Tardanza</div></div>
    <div class="stat-box ${totalGPS>0?'red':'green'}"><div class="stat-num">${totalGPS}</div><div class="stat-lbl">Alertas GPS</div></div>
    <div class="stat-box ${totalMulta>0?'red':'green'}"><div class="stat-num" style="color:${totalMulta>0?'#c0392b':'#27ae60'}">S/${totalMulta}</div><div class="stat-lbl">Total Multas</div></div>
  </div>
  <table>
    <thead><tr><th>Fecha</th><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Llegada</th><th>Tardanza</th><th>Multa</th></tr></thead>
    <tbody>${filas||'<tr><td colspan="8" style="text-align:center;color:#999;padding:16px">Sin viajes registrados este mes</td></tr>'}</tbody>
  </table>
  <div class="footer">Control de Ruta Corireâ€“Aplao Â· Sistema de GestiÃ³n de Flota Â· ${new Date().getFullYear()}</div>
  <br><button class="no-print" onclick="window.print()" style="padding:10px 20px;background:#1a3a6b;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
  </body></html>`;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
}

function exportarPDFTodas() {
  const mk = mesKey(new Date());
  const rep = (DATA.reporteMensual||{})[mk]||{};
  const mesNom = MESES[mesActual.getMonth()] + ' ' + mesActual.getFullYear();
  let filas = '';
  for(let i=1;i<=NUM_U;i++){
    const datos = rep[String(i)]||{};
    const tard = datos.minTardanza||0;
    const ext = datos.multasExt||0;
    const gps = datos.gpsAlertas||0;
    const total = tard+ext;
    const nombre = getNombreChofer(i);
    filas += `<tr>
      <td>U${String(i).padStart(2,'0')}</td>
      <td>${nombre}</td>
      <td>${datos.viajes||0}</td>
      <td style="color:${tard>0?'#c0392b':'#27ae60'}">${tard} min</td>
      <td>${ext>0?'S/'+ext:'â€”'}</td>
      <td>${gps}</td>
      <td style="color:${total>0?'#c0392b':'#27ae60'};font-weight:700">${total>0?'S/'+total:'â€”'}</td>
      <td style="color:${datos.cerrado?'#27ae60':'#e67e22'}">${datos.cerrado?'âœ“ Cerrado':'Abierto'}</td>
    </tr>`;
  }
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Reporte General ${mesNom}</title>
  <style>body{font-family:Arial,sans-serif;font-size:12px;margin:20px}.logo{font-size:22px;font-weight:800;color:#1a3a6b;letter-spacing:2px}h1{font-size:18px;color:#1a3a6b;margin:4px 0 20px}table{width:100%;border-collapse:collapse}th{background:#1a3a6b;color:#fff;padding:8px;font-size:11px;text-align:left}td{padding:7px 8px;border-bottom:1px solid #e8edf2}tr:nth-child(even)td{background:#f7f9fb}.footer{margin-top:20px;font-size:10px;color:#999;text-align:center;border-top:1px solid #ddd;padding-top:10px}@media print{.no-print{display:none}}</style>
  </head><body>
  <div class="logo">CORâ€“APL</div>
  <h1>Reporte General Â· ${mesNom}</h1>
  <table><thead><tr><th>Unidad</th><th>Chofer</th><th>Viajes</th><th>Min Tard.</th><th>Multas Ext.</th><th>GPS Alert.</th><th>TOTAL S/</th><th>Estado</th></tr></thead>
  <tbody>${filas}</tbody></table>
  <div class="footer">Control de Ruta Corireâ€“Aplao Â· ${new Date().toLocaleString('es-PE')}</div>
  <br><button class="no-print" onclick="window.print()" style="padding:10px 20px;background:#1a3a6b;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
  </body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RETOMAR VIAJE ACTIVO (cuando el chofer vuelve a entrar)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkViajeActivo() {
  if (!SESSION.unidad || SESSION.role !== 'chofer') return;
  // Si ya hay LOCAL_VIAJE activo en esta sesiÃ³n, no mostrar banner
  if (LOCAL_VIAJE && _viajeEnCurso) return;
  const v = DATA.viajesActivos[SESSION.unidad];
  const banner = document.getElementById('retomar-banner');
  const info   = document.getElementById('retomar-info');
  if (!banner) return;

  // Solo mostrar banner si el viaje ya existÃ­a ANTES de esta sesiÃ³n (no reciÃ©n registrado)
  if (v && v.salida && !_viajeEnCurso) {
    // Hay viaje activo de sesiÃ³n anterior â€” mostrar banner
    const ahora = horaAMin(ahoraTxt());
    const tardActual = Math.max(0, ahora - v.esperadaMin);
    const paso = v.mamasHora ? '3 â€” Llegada final' : '2 â€” MamÃ¡s';
    info.innerHTML = `
      <strong>${v.origen} â†’ ${v.destino}</strong><br>
      Salida: <span class="mono">${v.salida}</span> &nbsp;Â·&nbsp;
      Hora MamÃ¡s esperada: <span class="mono">${minAHora(v.salidaMin + tiempoEsp(v.origen,'MAMAS'))}</span><br>
      ${v.mamasHora ? `âœ… MamÃ¡s registrado: <span class="mono">${v.mamasHora}</span><br>` : ''}
      Llegada esperada: <span class="mono" style="color:var(--mamas)">${minAHora(v.esperadaMin)}</span>
      ${tardActual > 0 ? `&nbsp;<span style="color:var(--red)">Â· +${tardActual}min TARDE</span>` : ''}<br>
      <span style="color:var(--muted2);font-size:11px">ContinÃºa en el Paso ${paso}</span>`;
    banner.classList.add('show');

    // Hide paso 1 if viaje is active
    document.getElementById('card-salida') && (document.getElementById('card-salida').style.opacity='0.4');
    document.getElementById('card-salida') && (document.getElementById('card-salida').style.pointerEvents='none');
  } else {
    banner.classList.remove('show');
    // Restore paso 1
    const cs = document.getElementById('card-salida');
    if(cs){cs.style.opacity='1';cs.style.pointerEvents='auto';}
  }
}

function retomarViaje() {
  const v = DATA.viajesActivos[SESSION.unidad];
  if (!v) { checkViajeActivo(); return; }

  LOCAL_VIAJE = {...v}; // copia para no compartir referencia // restaurar estado local desde Firebase
  _viajeEnCurso = true;
  document.getElementById('retomar-banner').classList.remove('show');

  // Restore paso 1 card opacity (locked)
  const cs = document.getElementById('card-salida');
  if(cs){cs.style.opacity='0.4';cs.style.pointerEvents='none';}

  // Restore origen display
  const sOrigen = document.getElementById('s-origen');
  if(sOrigen) sOrigen.value = v.origen;

  // Restore hora salida
  const hSal = document.getElementById('h-salida');
  if(hSal) hSal.value = v.salida;

  // Restore destino display
  const ldest = document.getElementById('l-destino');
  if(ldest) ldest.value = v.destino;
  const dd = document.getElementById('destino-display');
  if(dd){
    dd.textContent = v.destino;
    dd.style.color = v.destino==='APLAO'?'var(--aplao)':'var(--corire)';
    dd.style.borderColor = v.destino==='APLAO'?'var(--aplao)':'var(--corire)';
  }

  if (!v.mamasHora) {
    // Estaba en Paso 2
    document.getElementById('card-mamas').style.opacity='1';
    document.getElementById('card-mamas').style.pointerEvents='auto';
    document.getElementById('card-llegada').style.opacity='0.4';
    document.getElementById('card-llegada').style.pointerEvents='none';
    document.getElementById('incidente-section').style.display='block';
    setStep(2);
  } else {
    // Estaba en Paso 3 â€” forzar todo visible y habilitado
    document.getElementById('card-mamas').style.opacity='1';
    document.getElementById('card-mamas').style.pointerEvents='auto';
    document.getElementById('card-llegada').style.opacity='1';
    document.getElementById('card-llegada').style.pointerEvents='auto';
    document.getElementById('card-llegada').style.display='block';
    document.getElementById('incidente-section').style.display='block';
    // Mostrar hora MamÃ¡s en el display
    const mamasValEl = document.getElementById('cd-mamas-val');
    if(mamasValEl){ mamasValEl.textContent='âœ… '+v.mamasHora; mamasValEl.className='cd-timer green'; }
    // Mostrar cd-destino
    const cdDest = document.getElementById('cd-destino');
    if(cdDest) cdDest.classList.add('show');
    // Asegurar destino en el select
    const ldEl2 = document.getElementById('l-destino');
    if(ldEl2) ldEl2.value = v.destino;
    setStep(3);
  }

  resetAutoLocks();
  iniciarCountdowns();
  // Scroll al paso activo
  setTimeout(()=>{
    const cardLlegada = document.getElementById('card-llegada');
    if(cardLlegada && v.mamasHora) cardLlegada.scrollIntoView({behavior:'smooth', block:'center'});
  }, 400);
  showAlert('salida-alert', `â–¶ï¸ Viaje retomado Â· ${v.origen} â†’ ${v.destino} Â· Salida ${v.salida}`, 'ok');
  updateRouteDiagram(v.origen);
}

function cancelarViajePropio() {
  if (!confirm('Â¿Cancelar el viaje activo? Se eliminarÃ¡ sin registrar llegada ni tardanza.')) return;
  const u = SESSION.unidad;
  const v = DATA.viajesActivos[u];
  if (v) {
    fbPush('viajesAnulados', {...v, motivo:'Cancelado por el chofer', anuladoPor:'CHOFER', anuladoEn:new Date().toISOString()});
    fbRemove('viajesActivos/' + u);
  }
  LOCAL_VIAJE = null;
  _viajeEnCurso = false;
  document.getElementById('retomar-banner').classList.remove('show');
  const cs = document.getElementById('card-salida');
  if(cs){cs.style.opacity='1';cs.style.pointerEvents='auto';}
  document.getElementById('card-mamas').style.opacity='0.4';
  document.getElementById('card-mamas').style.pointerEvents='none';
  document.getElementById('card-llegada').style.opacity='0.4';
  document.getElementById('card-llegada').style.pointerEvents='none';
  document.getElementById('incidente-section').style.display='none';
  document.getElementById('s-origen').value='';
  document.getElementById('l-destino').value='';
  const ddR=document.getElementById('destino-display');
  if(ddR){ddR.textContent='â€” AutomÃ¡tico segÃºn origen â€”';ddR.style.color='';ddR.style.borderColor='';}
  ocultarCountdowns();
  setStep(1);
  showAlert('salida-alert','Viaje cancelado. Puedes registrar una nueva salida.','ok');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DIAGRAMA DE RUTA DINÃMICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateRouteDiagram(origen) {
  const cfg = DATA.config.tiempos;
  const v = SESSION.unidad ? DATA.viajesActivos[SESSION.unidad] : null;
  const actualOrigen = origen || (v && v.origen) || null;

  // Tiempos segÃºn direcciÃ³n
  let t1, t2, dir, mamasEspera;
  if (actualOrigen === 'CORIRE') {
    t1 = cfg.cm || 18;   // CORIRE â†’ MAMÃS
    t2 = cfg.ma || 12;   // MAMÃS â†’ APLAO
    dir = 1;             // izquierda a derecha
    mamasEspera = 0;
  } else if (actualOrigen === 'APLAO') {
    t1 = cfg.am || 19;   // APLAO â†’ MAMÃS
    t2 = cfg.mc || 13;   // MAMÃS â†’ CORIRE
    dir = -1;            // derecha a izquierda
    mamasEspera = 0;
  } else {
    // Sin viaje: mostrar ambas direcciones
    t1 = cfg.cm || 18;
    t2 = cfg.ma || 12;
    dir = 0;
    mamasEspera = 0;
  }

  const flecha = dir === 1 ? 'â†’' : dir === -1 ? 'â†' : 'â†”';

  // Determinar estado de cada punto
  const paso = v ? (v.mamasHora ? 3 : 2) : 1;
  const corireClass = actualOrigen === 'CORIRE' ? 'active' : (actualOrigen === 'APLAO' && v?.llegada ? 'done' : '');
  const mamasClass  = paso === 2 ? 'active' : paso === 3 ? 'done' : '';
  const aplaoClass  = actualOrigen === 'APLAO' ? 'active' : (actualOrigen === 'CORIRE' && v?.llegada ? 'done' : '');

  const rh = document.getElementById('route-header');
  if (!rh) return;

  if (dir === -1) {
    // APLAO â†’ MAMÃS â†’ CORIRE
    rh.innerHTML = `
      <div class="rh-stop ${aplaoClass}">
        <div class="rh-circle rh-a">APL</div>
        <div class="rh-name" style="color:var(--aplao)">APLAO</div>
        <div class="rh-time-below" style="color:var(--aplao);font-size:8px">SALIDA</div>
      </div>
      <div class="rh-line">
        <span class="rh-time">${t1} min</span>
        <span style="position:absolute;right:-8px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:11px">â†’</span>
      </div>
      <div class="rh-stop ${mamasClass}">
        <div class="rh-circle rh-m">MMA</div>
        <div class="rh-name" style="color:var(--mamas)">MAMÃS</div>
        <div class="rh-time-below" style="color:var(--muted)">PASO</div>
      </div>
      <div class="rh-line">
        <span class="rh-time">${t2} min</span>
        <span style="position:absolute;right:-8px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:11px">â†’</span>
      </div>
      <div class="rh-stop ${corireClass}">
        <div class="rh-circle rh-c">COR</div>
        <div class="rh-name" style="color:var(--corire)">CORIRE</div>
        <div class="rh-time-below" style="color:var(--corire);font-size:8px">DESTINO</div>
      </div>`;
  } else if (dir === 1) {
    // CORIRE â†’ MAMÃS â†’ APLAO
    rh.innerHTML = `
      <div class="rh-stop ${corireClass}">
        <div class="rh-circle rh-c">COR</div>
        <div class="rh-name" style="color:var(--corire)">CORIRE</div>
        <div class="rh-time-below" style="color:var(--corire);font-size:8px">SALIDA</div>
      </div>
      <div class="rh-line">
        <span class="rh-time">${t1} min</span>
        <span style="position:absolute;right:-8px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:11px">â†’</span>
      </div>
      <div class="rh-stop ${mamasClass}">
        <div class="rh-circle rh-m">MMA</div>
        <div class="rh-name" style="color:var(--mamas)">MAMÃS</div>
        <div class="rh-time-below" style="color:var(--muted)">PASO</div>
      </div>
      <div class="rh-line">
        <span class="rh-time">${t2} min</span>
        <span style="position:absolute;right:-8px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:11px">â†’</span>
      </div>
      <div class="rh-stop ${aplaoClass}">
        <div class="rh-circle rh-a">APL</div>
        <div class="rh-name" style="color:var(--aplao)">APLAO</div>
        <div class="rh-time-below" style="color:var(--aplao);font-size:8px">DESTINO</div>
      </div>`;
  } else {
    // Sin viaje â€” mostrar ambas direcciones con tiempos correctos
    const cm = cfg.cm||18, am = cfg.am||19, ma = cfg.ma||12, mc = cfg.mc||13;
    rh.innerHTML = `
      <div class="rh-stop">
        <div class="rh-circle rh-c">COR</div>
        <div class="rh-name" style="color:var(--corire)">CORIRE</div>
      </div>
      <div class="rh-line" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px">
        <span style="font-size:8px;color:var(--muted2);font-family:var(--fm);white-space:nowrap">${cm}m â†’</span>
        <span style="font-size:8px;color:var(--muted2);font-family:var(--fm);white-space:nowrap">â† ${am}m</span>
      </div>
      <div class="rh-stop">
        <div class="rh-circle rh-m">MMA</div>
        <div class="rh-name" style="color:var(--mamas)">MAMÃS</div>
      </div>
      <div class="rh-line" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px">
        <span style="font-size:8px;color:var(--muted2);font-family:var(--fm);white-space:nowrap">${ma}m â†’</span>
        <span style="font-size:8px;color:var(--muted2);font-family:var(--fm);white-space:nowrap">â† ${mc}m</span>
      </div>
      <div class="rh-stop">
        <div class="rh-circle rh-a">APL</div>
        <div class="rh-name" style="color:var(--aplao)">APLAO</div>
      </div>`;
  }
}

// â”€â”€ CONFIG FIREBASE RUTA CORIRE-APLAO â”€â”€
const FIREBASE_CFG_PRESET = {
  apiKey:            "AIzaSyAYsETvB3xPRqu9KXw9iCeUUanZrDBuifM",
  authDomain:        "ruta-corire-aplao.firebaseapp.com",
  databaseURL:       "https://ruta-corire-aplao-default-rtdb.firebaseio.com",
  projectId:         "ruta-corire-aplao",
  storageBucket:     "ruta-corire-aplao.firebasestorage.app",
  messagingSenderId: "930338897342",
  appId:             "1:930338897342:web:2a6ea7ffb1caf149f90def",
  measurementId:     "G-QWL4R9PEJM"
};
// Auto-conectar sin pantalla de setup
(()=>{
  localStorage.setItem('fb_cfg_v2', JSON.stringify(FIREBASE_CFG_PRESET));
  document.getElementById('setup-screen').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  iniciarFirebase(FIREBASE_CFG_PRESET);
})();

actualizarMesLabel();
poblarExportSelect();
solicitarNotificaciones();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANULAR VIAJE (SUPERVISOR)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _anularCtx = null; // {unidad, tipo, key}

function abrirModalAnular(unidad, tipo, key) {
  _anularCtx = { unidad, tipo, key };
  const u = 'U' + String(unidad).padStart(2,'0');

  // DescripciÃ³n en modal
  let desc = '';
  if (tipo === 'activo') {
    const v = DATA.viajesActivos[unidad];
    desc = v ? `${u} Â· ${v.origen} â†’ ${v.destino} Â· Salida ${v.salida}` : u + ' Â· Viaje activo';
  } else {
    const h = DATA.historialDia[key];
    desc = h ? `${u} Â· ${h.origen} â†’ ${h.destinoFinal||h.destino} Â· Salida ${h.salida} Â· Tardanza ${h.tardanza||0}min` : u;
  }
  document.getElementById('modal-anular-sub').textContent = desc;
  document.getElementById('anular-motivo-sel').value = '';
  document.getElementById('anular-motivo-custom').value = '';
  document.getElementById('motivo-custom-row').style.display = 'none';

  // AcciÃ³n segÃºn tipo
  const acSel = document.getElementById('anular-accion');
  acSel.value = tipo === 'activo' ? 'anular_viaje_activo' : 'anular_historial';
  document.getElementById('anular-historial-row').style.display = 'none';

  document.getElementById('modal-alert').className = 'alert';
  document.getElementById('modal-anular').classList.add('show');
}

function cerrarModalAnular() {
  document.getElementById('modal-anular').classList.remove('show');
  _anularCtx = null;
}

function toggleMotivoCustom() {
  const sel = document.getElementById('anular-motivo-sel').value;
  document.getElementById('motivo-custom-row').style.display = sel === 'Otro' ? 'block' : 'none';
}

function ejecutarAnulacion() {
  const motivoSel = document.getElementById('anular-motivo-sel').value;
  const motivoCustom = document.getElementById('anular-motivo-custom').value.trim();
  const motivo = motivoSel === 'Otro' ? motivoCustom : motivoSel;

  if (!motivo) {
    showAlert('modal-alert', 'Selecciona o escribe un motivo', 'err'); return;
  }
  if (!_anularCtx) return;

  const { unidad, tipo, key } = _anularCtx;
  const ts = new Date().toISOString();

  if (tipo === 'activo') {
    // Cancelar viaje activo: eliminar de viajesActivos, guardar en log anulados
    const v = DATA.viajesActivos[unidad];
    if (v) {
      fbPush('viajesAnulados', {
        ...v, motivo, anuladoPor:'SUPERVISOR', anuladoEn:ts,
        tipo:'activo'
      });
      fbRemove('viajesActivos/' + unidad);
      showAlert('modal-alert', `âœ… Viaje activo de U${String(unidad).padStart(2,'0')} cancelado.`, 'ok');
    }
  } else {
    // Anular viaje del historial: quitar tardanza acumulada
    const h = DATA.historialDia[key];
    if (h) {
      const tardAnulada = h.tardanza || 0;
      const acumActual = DATA.tardanzaAcum[unidad] || 0;
      const nuevaAcum = Math.max(0, acumActual - tardAnulada);

      // Marcar como anulado en historial (no eliminar, para tener registro)
      fbUpdate('historialDia/' + key, {
        anulado: true,
        tardanza: 0,
        motivoAnulacion: motivo,
        anuladoPor: 'SUPERVISOR',
        anuladoEn: ts,
        tardanzaOriginal: tardAnulada
      });
      fbSet('tardanzaAcum/' + unidad, nuevaAcum);

      showAlert('modal-alert',
        `âœ… Tardanza de ${tardAnulada}min removida de U${String(unidad).padStart(2,'0')}. Acumulado: S/${nuevaAcum}`,
        'ok');
    }
  }

  setTimeout(() => {
    cerrarModalAnular();
    renderHistorialSup();
    renderMonitor();
  }, 1800);
}

// Close modal on overlay click
document.getElementById('modal-anular').addEventListener('click', function(e){
  if (e.target === this) cerrarModalAnular();
});

function STATE_viaje_actual(){ return DATA.viajesActivos[SESSION.unidad]||null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COUNTDOWN + AUTO-MARK (con segundos, sonido, cancelar)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cdInterval = null;
window._autoMamasLock = false;
window._autoLlegadaLock = false;
window._cancelMamas = false;
window._cancelLlegada = false;
let _autoMamasTimer = null;
let _autoLlegadaTimer = null;

// â”€â”€ SONIDO beep (Web Audio API) â”€â”€
function beep(freq=880, dur=200, vol=0.3) {
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext||window.AudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur/1000);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + dur/1000);
  } catch(e) {}
}
function beepEntrada() {
  // 3 beeps rÃ¡pidos al entrar en zona
  beep(880, 150, 0.4);
  setTimeout(()=>beep(880,150,0.4), 200);
  setTimeout(()=>beep(1100,300,0.5), 400);
}
function beepAutoMarcado() {
  beep(1100,200,0.5);
  setTimeout(()=>beep(1320,400,0.6), 250);
}

function iniciarCountdowns() {
  document.getElementById('cd-mamas').classList.add('show');
  if (cdInterval) clearInterval(cdInterval);
  cdInterval = setInterval(tickCountdown, 1000);
  tickCountdown();
}

function ocultarCountdowns() {
  if (cdInterval) clearInterval(cdInterval);
  const cm = document.getElementById('cd-mamas');
  const cd = document.getElementById('cd-destino');
  if(cm) cm.classList.remove('show');
  if(cd) cd.classList.remove('show');
}

function tickCountdown() {
  // Usar LOCAL_VIAJE â€” no se sobreescribe con Firebase
  const v = LOCAL_VIAJE;
  if (!v) return;

  const ahora = new Date();
  let ahoraS = ahora.getHours()*3600 + ahora.getMinutes()*60 + ahora.getSeconds();
  // Ajuste medianoche
  if (v.salidaMin && ahoraS/60 < v.salidaMin - 60) ahoraS += 86400;

  // â”€â”€ PASO 2: countdown a MAMÃS â”€â”€
  const elMVal = document.getElementById('cd-mamas-val');
  const elMFill = document.getElementById('cd-mamas-fill');

  if (!v.mamasHora) {
    // AÃºn no llegÃ³ a MamÃ¡s
    const mamasEspS = (v.salidaMin + tiempoEsp(v.origen, 'MAMAS')) * 60;
    const totalS = tiempoEsp(v.origen, 'MAMAS') * 60;
    const restS = mamasEspS - ahoraS;

    if (elMVal) {
      if (restS > 0) {
        const mm = Math.floor(restS/60), ss = restS % 60;
        elMVal.textContent = String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
        const pct = Math.min(100, (restS/totalS)*100);
        elMVal.className = 'cd-timer '+(pct>50?'green':pct>20?'yellow':'red');
        if(elMFill){elMFill.style.width=pct+'%';elMFill.style.background=pct>50?'var(--mamas)':pct>20?'var(--yellow)':'var(--red)';}
      } else {
        const lM=Math.floor(Math.abs(restS)/60), lS=Math.abs(restS)%60;
        elMVal.textContent='+'+String(lM).padStart(2,'0')+':'+String(lS).padStart(2,'0')+' TARDE';
        elMVal.className='cd-timer red';
        if(elMFill){elMFill.style.width='100%';elMFill.style.background='var(--red)';}
      }
    }
    // Auto-trigger solo si GPS estÃ¡ en zona MamÃ¡s
    if (gpsPos && enZona('MAMAS') && !window._autoMamasLock) iniciarAutoMamas();

  } else {
    // Ya pasÃ³ por MamÃ¡s â€” mostrar hora
    if(elMVal){elMVal.textContent='âœ… '+v.mamasHora; elMVal.className='cd-timer green';}
    if(elMFill){elMFill.style.width='100%'; elMFill.style.background='var(--mamas)';}
    // Asegurarse que cd-destino estÃ© visible
    const cdD = document.getElementById('cd-destino');
    if(cdD) cdD.classList.add('show');
  }

  // â”€â”€ PASO 3: countdown al DESTINO (solo si ya pasÃ³ MamÃ¡s) â”€â”€
  if (v.mamasHora) {
    const elDVal = document.getElementById('cd-destino-val');
    const elDFill = document.getElementById('cd-destino-fill');
    const destEspS = v.esperadaMin * 60;
    const totalS = tiempoEsp(v.origen, v.destino) * 60;
    const restS = destEspS - ahoraS;

    if (elDVal) {
      if (restS > 0) {
        const mm=Math.floor(restS/60), ss=restS%60;
        elDVal.textContent=String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
        const pct=Math.min(100,(restS/totalS)*100);
        elDVal.className='cd-timer '+(pct>50?'green':pct>20?'yellow':'red');
        if(elDFill){elDFill.style.width=pct+'%';elDFill.style.background=pct>50?'var(--corire)':pct>20?'var(--yellow)':'var(--red)';}
      } else {
        const lM=Math.floor(Math.abs(restS)/60), lS=Math.abs(restS)%60;
        elDVal.textContent='+'+String(lM).padStart(2,'0')+':'+String(lS).padStart(2,'0')+' TARDE';
        elDVal.className='cd-timer red';
        if(elDFill){elDFill.style.width='100%';elDFill.style.background='var(--red)';}
      }
    }
    // Auto-trigger solo si GPS estÃ¡ en zona destino
    if (gpsPos && v.destino && enZona(v.destino) && !window._autoLlegadaLock) iniciarAutoLlegada();
  }
}

// â”€â”€ AUTO MAMÃS con 3s cancelar + sonido â”€â”€
function iniciarAutoMamas() {
  if (window._autoMamasLock || _autoMamasTimer) return;
  if (!LOCAL_VIAJE || LOCAL_VIAJE.mamasHora) return; // ya registrado
  window._autoMamasLock = true;
  window._cancelMamas = false;
  beepEntrada();
  let cnt = 3;
  const box = document.getElementById('cancel-mamas-box');
  const countEl = document.getElementById('cancel-mamas-count');
  if(box) box.style.display='block';
  if(countEl) countEl.textContent = cnt;

  _autoMamasTimer = setInterval(() => {
    if (window._cancelMamas) {
      clearInterval(_autoMamasTimer); _autoMamasTimer=null;
      window._autoMamasLock=false;
      if(box) box.style.display='none';
      return;
    }
    cnt--;
    if(countEl) countEl.textContent=cnt;
    beep(660,100,0.3);
    if (cnt <= 0) {
      clearInterval(_autoMamasTimer); _autoMamasTimer=null;
      if(box) box.style.display='none';
      if (!window._cancelMamas) registrarMamas();
    }
  }, 1000);
}

function cancelarAutoMamas() {
  window._cancelMamas=true;
  window._autoMamasLock=true; // mantener lock 15s para evitar re-disparo inmediato
  if(_autoMamasTimer){clearInterval(_autoMamasTimer);_autoMamasTimer=null;}
  const box=document.getElementById('cancel-mamas-box');
  if(box) box.style.display='none';
  beep(440,300,0.3);
  setTimeout(()=>{
    if(SESSION.unidad&&!DATA.viajesActivos[SESSION.unidad]?.mamasHora) {
      window._autoMamasLock=false;
      window._cancelMamas=false;
    }
  }, 15000);
}

// ejecutarAutoMamas removed â€” calls registrarMamas() directly

// â”€â”€ AUTO LLEGADA con 3s cancelar + sonido â”€â”€
function iniciarAutoLlegada() {
  if (window._autoLlegadaLock || _autoLlegadaTimer) return;
  if (!LOCAL_VIAJE || !LOCAL_VIAJE.mamasHora) return; // solo si ya pasÃ³ MamÃ¡s
  const ahoraMin = horaAMin(ahoraTxt());
  if (ahoraMin < LOCAL_VIAJE.esperadaMin - 5) return; // demasiado temprano
  window._autoLlegadaLock = true;
  window._cancelLlegada = false;
  beepEntrada();
  let cnt = 3;
  const box = document.getElementById('cancel-llegada-box');
  const countEl = document.getElementById('cancel-llegada-count');
  if(box) box.style.display='block';
  if(countEl) countEl.textContent=cnt;

  _autoLlegadaTimer = setInterval(()=>{
    if (window._cancelLlegada) {
      clearInterval(_autoLlegadaTimer); _autoLlegadaTimer=null;
      window._autoLlegadaLock=false;
      if(box) box.style.display='none';
      return;
    }
    cnt--;
    if(countEl) countEl.textContent=cnt;
    beep(660,100,0.3);
    if (cnt<=0) {
      clearInterval(_autoLlegadaTimer); _autoLlegadaTimer=null;
      if(box) box.style.display='none';
      if(!window._cancelLlegada) registrarLlegada(); // llamar directo
    }
  },1000);
}

function cancelarAutoLlegada() {
  window._cancelLlegada=true;
  window._autoLlegadaLock=true; // mantener lock 15s para evitar re-disparo inmediato
  if(_autoLlegadaTimer){clearInterval(_autoLlegadaTimer);_autoLlegadaTimer=null;}
  const box=document.getElementById('cancel-llegada-box');
  if(box) box.style.display='none';
  beep(440,300,0.3);
  // Liberar lock despuÃ©s de 15s si no se registrÃ³ manualmente
  setTimeout(()=>{
    if(!DATA.viajesActivos[SESSION.unidad]?.llegada) {
      window._autoLlegadaLock=false;
      window._cancelLlegada=false;
    }
  }, 15000);
}

// ejecutarAutoLlegada removed â€” calls registrarLlegada() directly
function resetAutoLocks(){
  window._autoMamasLock=false; window._autoLlegadaLock=false;
  window._cancelMamas=false; window._cancelLlegada=false;
  if(_autoMamasTimer){clearInterval(_autoMamasTimer);_autoMamasTimer=null;}
  if(_autoLlegadaTimer){clearInterval(_autoLlegadaTimer);_autoLlegadaTimer=null;}
  const bm=document.getElementById('cancel-mamas-box');
  const bl=document.getElementById('cancel-llegada-box');
  if(bm)bm.style.display='none';
  if(bl)bl.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIVE MAP SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderLiveMap() {
  const svgG = document.getElementById('svg-units');
  if (!svgG) return;
  const now = horaAMin(ahoraTxt());
  let html = '';
  const colors = ['#3b9eff','#ff9a3b','#3bff8a','#ff4757','#ffd32a','#a29bfe','#fd79a8','#00cec9','#e17055','#74b9ff'];

  Object.entries(DATA.viajesActivos || {}).forEach(([u, v], idx) => {
    if (!v) return;
    // PosiciÃ³n estimada en SVG (30=CORIRE, 170=MAMAS, 310=APLAO)
    const totalMin = tiempoEsp(v.origen, v.destino);
    const elapsed = Math.max(0, now - v.salidaMin);
    const pct = Math.min(1, elapsed / totalMin);

    let x1, x2;
    if (v.origen === 'CORIRE') { x1 = 30; x2 = 310; }
    else { x1 = 310; x2 = 30; }
    const cx = x1 + (x2 - x1) * pct;
    const tardAct = Math.max(0, now - v.esperadaMin);
    const col = tardAct > 0 ? '#ff4757' : (colors[idx % colors.length]);
    const label = 'U' + String(u).padStart(2,'0');

    html += `<g>
      <circle cx="${cx.toFixed(1)}" cy="40" r="8" fill="${col}" opacity="0.9"/>
      <text x="${cx.toFixed(1)}" y="28" text-anchor="middle" fill="${col}" font-size="7" font-family="Barlow Condensed" font-weight="700">${label}</text>
    </g>`;
  });
  svgG.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarViajes() {
  const u = SESSION.unidad;
  const mis = Object.values(DATA.historialDia || {}).filter(h => h.unidad === u);
  if (!mis.length) { alert('Sin viajes para exportar hoy'); return; }
  descargarCSV(mis, 'viajes_U' + String(u).padStart(2,'0') + '_' + hoy() + '.csv');
}

function exportarViajesSup() {
  const sel = document.getElementById('export-unit-sel');
  const filtro = sel ? sel.value : 'all';
  let datos = Object.values(DATA.historialDia || {});
  if (filtro !== 'all') datos = datos.filter(h => h.unidad === filtro);
  if (!datos.length) { alert('Sin viajes para exportar'); return; }
  const nombre = filtro === 'all' ? 'viajes_todas_' + hoy() : 'viajes_U' + String(filtro).padStart(2,'0') + '_' + hoy();
  descargarCSV(datos, nombre + '.csv');
}

function descargarCSV(datos, nombre) {
  const headers = ['Unidad','Fecha','Origen','Hora Salida','Hora MamÃ¡s','Destino','Hora Llegada','Min Tardanza','Multa S/','GPS Alerta'];
  const rows = datos.map(h => [
    'U'+String(h.unidad).padStart(2,'0'),
    h.fecha||hoy(),
    h.origen,
    h.salida,
    h.mamasHora||'',
    h.destinoFinal||h.destino,
    h.llegada||'',
    h.tardanza||0,
    h.tardanza||0,
    h.gpsAlert?'SI':'NO'
  ]);
  const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = nombre;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
}

// Poblar select de unidades en export supervisor
function poblarExportSelect() {
  const sel = document.getElementById('export-unit-sel');
  if (!sel) return;
  sel.innerHTML = '<option value="all">Todas las unidades</option>';
  for(let i=1;i<=NUM_U;i++) sel.innerHTML+=`<option value="${i}">U${String(i).padStart(2,'0')}</option>`;
}

</script>
</body>
</html>
