<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FleetTrack Â· Corireâ€“Aplao</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Syne:wght@700;800&family=DM+Mono:wght@400;500&display=swap');

:root{
  --ink:#0a0d12; --ink2:#111520; --ink3:#181e2c; --ink4:#202840;
  --wire:#2a3450; --wire2:#344060;
  --blu:#4f8eff; --blu-g:rgba(79,142,255,.12);
  --grn:#00e5a0; --grn-g:rgba(0,229,160,.1);
  --amb:#ffb340; --amb-g:rgba(255,179,64,.1);
  --red:#ff4466; --red-g:rgba(255,68,102,.1);
  --txt:#c8d8f0; --txt2:#6a88b0; --txt3:#3a5070;
  --fs:'Syne',sans-serif; --fb:'Space Grotesk',sans-serif; --fm:'DM Mono',monospace;
  --r:12px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;position:fixed;width:100%}
body{font-family:var(--fb);background:var(--ink);color:var(--txt);font-size:14px}

/* â”€â”€ SCREENS â”€â”€ */
.screen{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--ink)}
.screen.hidden{display:none}

/* â”€â”€ SETUP â”€â”€ */
#s-setup{align-items:center;justify-content:flex-start;padding:40px 20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.brand{font-family:var(--fs);font-size:36px;font-weight:800;letter-spacing:-1px;margin-bottom:2px}
.brand span{color:var(--blu)}
.brand-sub{font-family:var(--fm);font-size:10px;letter-spacing:4px;color:var(--txt2);margin-bottom:36px}
.glass{background:var(--ink2);border:1px solid var(--wire);border-radius:var(--r);padding:24px;width:100%;max-width:440px;margin-bottom:16px}
.glass h3{font-family:var(--fs);font-size:14px;font-weight:700;letter-spacing:1px;color:var(--txt2);margin-bottom:16px;text-transform:uppercase}
.field{margin-bottom:12px}
.field label{display:block;font-size:10px;font-weight:600;letter-spacing:2px;color:var(--txt3);margin-bottom:5px;text-transform:uppercase}
.field input,.field select,.field textarea{
  width:100%;background:var(--ink3);border:1px solid var(--wire);border-radius:8px;
  color:var(--txt);font-family:var(--fm);font-size:13px;padding:10px 12px;
  outline:none;transition:border .2s;-webkit-appearance:none;
}
.field input:focus,.field select:focus{border-color:var(--blu)}
.field textarea{resize:none;min-height:70px;line-height:1.5}
.divider{height:1px;background:var(--wire);margin:16px 0}
.info-box{background:var(--blu-g);border:1px solid rgba(79,142,255,.25);border-radius:8px;padding:12px;font-size:11px;color:var(--blu);line-height:1.6;margin-bottom:12px}
.info-box b{display:block;margin-bottom:3px}

/* â”€â”€ LOGIN â”€â”€ */
#s-login{align-items:center;justify-content:center;padding:24px}
.login-brand{font-family:var(--fs);font-size:52px;font-weight:800;letter-spacing:-2px;text-align:center;margin-bottom:2px}
.login-brand span{color:var(--blu)}
.login-sub{font-family:var(--fm);font-size:9px;letter-spacing:5px;color:var(--txt2);text-align:center;margin-bottom:40px}
.login-box{background:var(--ink2);border:1px solid var(--wire);border-radius:16px;padding:28px;width:100%;max-width:360px}
.role-tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.rt{border:2px solid var(--wire);border-radius:10px;padding:16px 8px;text-align:center;cursor:pointer;transition:.2s;background:var(--ink3)}
.rt .ico{font-size:26px;display:block;margin-bottom:4px}
.rt .lbl{font-family:var(--fs);font-size:13px;font-weight:700;letter-spacing:.5px;color:var(--txt2)}
.rt.sel{border-color:var(--blu);background:var(--blu-g)}
.rt.sel .lbl{color:var(--blu)}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:10px;
  font-family:var(--fs);font-size:14px;font-weight:700;letter-spacing:.5px;cursor:pointer;
  padding:12px 18px;width:100%;transition:.15s;touch-action:manipulation}
.btn-blue{background:var(--blu);color:#000}
.btn-blue:active{filter:brightness(.9)}
.btn-green{background:var(--grn);color:#000}
.btn-green:active{filter:brightness(.9)}
.btn-amber{background:var(--amb);color:#000}
.btn-amber:active{filter:brightness(.9)}
.btn-red{background:var(--red);color:#fff}
.btn-red:active{filter:brightness(.9)}
.btn-ghost{background:var(--ink3);color:var(--txt);border:1px solid var(--wire2)}
.btn-ghost:active{background:var(--ink4)}
.btn-sm{padding:7px 14px;font-size:12px;width:auto;border-radius:8px}
.btn:disabled{opacity:.35;pointer-events:none}

/* â”€â”€ APP SHELL â”€â”€ */
#s-app{display:none;flex-direction:column;overflow:hidden;height:100vh;height:100dvh}
#s-app.vis{display:flex}

/* TOPBAR */
.topbar{
  background:var(--ink2);border-bottom:1px solid var(--wire);
  padding:10px 16px;display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;z-index:50;position:relative;
}
.tb-left{display:flex;align-items:center;gap:10px}
.tb-logo{font-family:var(--fs);font-size:18px;font-weight:800;letter-spacing:-0.5px;color:var(--txt)}
.tb-logo b{color:var(--blu)}
.tb-pill{background:var(--ink3);border:1px solid var(--wire);border-radius:20px;padding:3px 10px;font-family:var(--fm);font-size:10px;color:var(--txt2)}
.tb-clock{font-family:var(--fm);font-size:22px;font-weight:500;color:var(--grn);letter-spacing:1px}
.tb-clock small{font-size:10px;color:var(--txt2);margin-left:2px}
.tb-right{display:flex;align-items:center;gap:8px}
.conn-dot{width:6px;height:6px;border-radius:50%;background:var(--grn)}
.conn-dot.off{background:var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.conn-dot.sync{background:var(--amb);animation:blink .8s infinite}

/* TABS */
.tabs{display:flex;background:var(--ink2);border-bottom:1px solid var(--wire);overflow-x:auto;flex-shrink:0;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:10px 16px;cursor:pointer;font-family:var(--fs);font-size:12px;font-weight:700;letter-spacing:.5px;
  color:var(--txt2);border-bottom:2px solid transparent;white-space:nowrap;transition:.2s;flex-shrink:0}
.tab.active{color:var(--blu);border-color:var(--blu)}

/* CONTENT AREA */
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;min-height:0}
.panel{display:none;padding:14px 14px 80px;max-width:900px;margin:0 auto}
.panel.active{display:block}

/* ROUTE BAR */
.route-bar{
  background:var(--ink3);border:1px solid var(--wire);border-radius:var(--r);
  padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:center;gap:0;
}
.rb-stop{text-align:center;min-width:56px}
.rb-dot{width:30px;height:30px;border-radius:50%;margin:0 auto 4px;display:flex;align-items:center;justify-content:center;font-family:var(--fs);font-size:7px;font-weight:800;letter-spacing:.3px;border:2px solid;transition:.3s}
.rb-dot.c{border-color:var(--blu);color:var(--blu);background:var(--blu-g)}
.rb-dot.m{border-color:var(--grn);color:var(--grn);background:var(--grn-g)}
.rb-dot.a{border-color:var(--amb);color:var(--amb);background:var(--amb-g)}
.rb-dot.active{transform:scale(1.2);box-shadow:0 0 0 3px rgba(255,255,255,.15)}
.rb-dot.done{opacity:.5}
.rb-name{font-family:var(--fs);font-size:8px;font-weight:700;letter-spacing:.3px}
.rb-line{flex:1;max-width:70px;position:relative;height:2px;background:var(--wire)}
.rb-time{position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:8px;color:var(--txt2);white-space:nowrap}

/* STEP INDICATOR */
.steps{display:flex;gap:4px;margin-bottom:14px}
.step-bar{flex:1;height:3px;border-radius:2px;background:var(--wire);transition:.4s}
.step-bar.done{background:var(--grn)}
.step-bar.active{background:var(--blu)}

/* CARDS */
.card{background:var(--ink2);border:1px solid var(--wire);border-radius:var(--r);padding:16px;margin-bottom:12px;position:relative}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--r) var(--r) 0 0}
.card.c-blue::before{background:linear-gradient(90deg,var(--blu),#6fafff)}
.card.c-green::before{background:linear-gradient(90deg,var(--grn),#00ffcc)}
.card.c-amber::before{background:linear-gradient(90deg,var(--amb),#ffcc70)}
.card.c-red::before{background:linear-gradient(90deg,var(--red),#ff7799)}
.card.c-wire::before{background:var(--wire2)}
.card-title{font-family:var(--fs);font-size:11px;font-weight:700;letter-spacing:2px;color:var(--txt2);margin-bottom:14px;text-transform:uppercase;display:flex;align-items:center;gap:6px}
.card-title .num{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--wire);font-family:var(--fm);font-size:10px;font-weight:500;color:var(--txt)}
.card.disabled{opacity:.4;pointer-events:none}

/* ALERTS */
.alert{border-radius:8px;padding:10px 12px;font-size:12px;font-weight:500;display:none;margin-bottom:10px;line-height:1.5}
.alert.show{display:block}
.alert.ok{background:var(--grn-g);border:1px solid rgba(0,229,160,.3);color:var(--grn)}
.alert.err{background:var(--red-g);border:1px solid rgba(255,68,102,.3);color:var(--red)}
.alert.warn{background:var(--amb-g);border:1px solid rgba(255,179,64,.3);color:var(--amb)}

/* GPS BANNER */
.gps-bar{border-radius:9px;padding:9px 14px;display:flex;align-items:center;gap:8px;margin-bottom:10px;font-family:var(--fm);font-size:11px;font-weight:500}
.gps-bar.ok{background:var(--grn-g);border:1px solid rgba(0,229,160,.25);color:var(--grn)}
.gps-bar.err{background:var(--red-g);border:1px solid rgba(255,68,102,.25);color:var(--red)}
.gps-bar.load{background:var(--amb-g);border:1px solid rgba(255,179,64,.25);color:var(--amb)}
.gps-bar .dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.gps-bar .dot.anim{animation:pulse 1.5s infinite}

/* PROXIMITY */
.prox{margin-bottom:10px;display:none}
.prox-label{font-family:var(--fm);font-size:10px;color:var(--txt2);margin-bottom:4px}
.prox-track{height:4px;background:var(--wire);border-radius:2px;overflow:hidden}
.prox-fill{height:100%;border-radius:2px;transition:width .6s,background .6s}

/* COUNTDOWN */
.countdown{background:var(--ink3);border:1px solid var(--wire);border-radius:10px;padding:12px 14px;margin-bottom:10px;display:none}
.countdown.show{display:block}
.cd-lbl{font-family:var(--fm);font-size:9px;letter-spacing:2px;color:var(--txt2);margin-bottom:4px;text-transform:uppercase}
.cd-val{font-family:var(--fm);font-size:32px;font-weight:500;line-height:1}
.cd-val.g{color:var(--grn)} .cd-val.y{color:var(--amb)} .cd-val.r{color:var(--red)}
.cd-bar{height:3px;background:var(--wire);border-radius:2px;margin-top:8px;overflow:hidden}
.cd-fill{height:100%;border-radius:2px;transition:width 1s linear}

/* AUTO BOX */
.auto-box{border-radius:10px;padding:14px;text-align:center;margin-bottom:10px;display:none;background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.3)}
.auto-box.show{display:block}
.auto-box-title{font-family:var(--fs);font-size:16px;font-weight:700;color:var(--red);margin-bottom:4px}
.auto-box-sub{font-size:11px;color:var(--txt2);margin-bottom:12px}

/* RETOMAR BANNER */
.retomar{background:linear-gradient(135deg,rgba(79,142,255,.15),rgba(0,229,160,.08));border:1px solid rgba(79,142,255,.4);border-radius:var(--r);padding:16px;margin-bottom:12px;display:none}
.retomar.show{display:block}
.retomar-title{font-family:var(--fs);font-size:14px;font-weight:700;color:var(--blu);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.retomar-info{font-size:12px;color:var(--txt2);line-height:1.8;margin-bottom:12px}
.retomar-btns{display:grid;grid-template-columns:1fr auto;gap:8px}

/* MAMAS DONE BADGE */
.mamas-done{background:var(--grn-g);border:1px solid rgba(0,229,160,.3);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:8px;font-family:var(--fm);font-size:13px;color:var(--grn);font-weight:500}

/* DESTINO DISPLAY */
.dest-display{background:var(--ink3);border:1px solid var(--wire2);border-radius:8px;padding:10px 12px;font-family:var(--fs);font-size:16px;font-weight:700;letter-spacing:1px;margin-bottom:12px}

/* FUERA ZONA */
.fuera-zona{background:var(--red-g);border:1px solid rgba(255,68,102,.25);border-radius:8px;padding:8px 12px;font-size:11px;color:rgba(255,68,102,.8);margin-bottom:10px;display:none;pointer-events:none}

/* MONITOR */
.units-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:8px;margin-bottom:14px}
.uc{background:var(--ink3);border:1px solid var(--wire);border-radius:10px;padding:12px;transition:.2s}
.uc.run{border-color:var(--blu);background:rgba(79,142,255,.04)}
.uc.late{border-color:var(--red);background:rgba(255,68,102,.04)}
.uc-n{font-family:var(--fs);font-size:22px;font-weight:800;color:var(--txt2);line-height:1}
.uc.run .uc-n{color:var(--blu)} .uc.late .uc-n{color:var(--red)}
.uc-name{font-size:10px;color:var(--txt2);margin-bottom:6px;margin-top:2px}
.uc-s{font-size:11px;font-weight:600}
.uc-g{font-family:var(--fm);font-size:9px;color:var(--txt2);margin-top:3px}

/* TABLE */
.tbl-wrap{overflow-x:auto;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:11px;min-width:500px}
th{background:var(--ink3);color:var(--txt2);font-family:var(--fs);font-size:9px;font-weight:700;letter-spacing:1.5px;padding:8px 10px;text-align:left;border-bottom:1px solid var(--wire)}
td{padding:8px 10px;border-bottom:1px solid var(--wire);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.015)}

/* BADGE */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-family:var(--fs);font-size:10px;font-weight:700}
.badge.blu{background:var(--blu-g);color:var(--blu)}
.badge.grn{background:var(--grn-g);color:var(--grn)}
.badge.red{background:var(--red-g);color:var(--red)}
.badge.amb{background:var(--amb-g);color:var(--amb)}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:12px}
.stat{background:var(--ink3);border:1px solid var(--wire);border-radius:10px;padding:12px;text-align:center}
.stat-v{font-family:var(--fs);font-size:26px;font-weight:800;color:var(--blu);line-height:1}
.stat-l{font-size:9px;color:var(--txt2);letter-spacing:1px;text-transform:uppercase;margin-top:3px}

/* FROW */
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.mono{font-family:var(--fm)}

/* SCROLLBAR */
.content::-webkit-scrollbar{width:4px}
.content::-webkit-scrollbar-track{background:var(--ink)}
.content::-webkit-scrollbar-thumb{background:var(--wire2);border-radius:2px}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-bg.show{display:flex}
.modal{background:var(--ink2);border:1px solid var(--wire2);border-radius:16px 16px 0 0;padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
.modal h3{font-family:var(--fs);font-size:16px;font-weight:700;margin-bottom:16px}
.modal-close{float:right;background:none;border:none;color:var(--txt2);cursor:pointer;font-size:18px}

/* CANVAS CHART */
.chart-wrap{background:var(--ink3);border:1px solid var(--wire);border-radius:10px;padding:12px;margin-bottom:12px}
.chart-title{font-family:var(--fs);font-size:11px;font-weight:700;letter-spacing:1px;color:var(--txt2);margin-bottom:10px;text-transform:uppercase}
canvas{width:100%!important;display:block}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â•â•â• -->
<div id="s-setup" class="screen">
  <div class="brand">Fleet<b>Track</b></div>
  <div class="brand-sub">CORIRE Â· MAMÃS Â· APLAO</div>
  <div class="glass">
    <h3>âš™ï¸ ConfiguraciÃ³n Firebase</h3>
    <div class="info-box"><b>Primera vez</b>Ingresa los datos de tu proyecto Firebase. Se guardarÃ¡n en este dispositivo.</div>
    <div class="field"><label>API Key</label><input id="cfg-key" placeholder="AIzaSy..."></div>
    <div class="field"><label>Database URL</label><input id="cfg-url" placeholder="https://proyecto.firebaseio.com"></div>
    <div class="field"><label>Project ID</label><input id="cfg-pid" placeholder="proyecto-id"></div>
    <div class="divider"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="loadSavedCfg()">ğŸ“‚ Cargar guardado</button>
      <button class="btn btn-blue" onclick="saveCfg()" style="flex:1">Conectar â†’</button>
    </div>
    <div id="setup-alert" class="alert" style="margin-top:10px;margin-bottom:0"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â• -->
<div id="s-login" class="screen hidden">
  <div class="login-brand">Fleet<span>Track</span></div>
  <div class="login-sub">CONTROL DE FLOTA</div>
  <div class="login-box">
    <div class="role-tabs">
      <div class="rt" id="rt-chofer" onclick="selRole('chofer')">
        <span class="ico">ğŸšŒ</span><span class="lbl">Chofer</span>
      </div>
      <div class="rt" id="rt-sup" onclick="selRole('sup')">
        <span class="ico">ğŸ‘®</span><span class="lbl">Supervisor</span>
      </div>
    </div>
    <div id="login-chofer" class="hidden">
      <div class="field"><label>Unidad</label>
        <select id="login-unit"><option value="">â€” Selecciona â€”</option></select>
      </div>
    </div>
    <div id="login-sup" class="hidden">
      <div class="field"><label>Clave supervisor</label>
        <input type="password" id="login-key" placeholder="â€¢â€¢â€¢â€¢">
      </div>
    </div>
    <div id="login-alert" class="alert"></div>
    <button class="btn btn-blue" onclick="doLogin()">Entrar â†’</button>
    <button class="btn btn-ghost btn-sm" onclick="reconfig()" style="margin-top:8px">Reconfigurar Firebase</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â• -->
<div id="s-app">
  <!-- Topbar -->
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-logo">Fleet<b>Track</b></div>
      <div class="tb-pill" id="tb-unit">â€”</div>
      <span class="conn-dot" id="conn-dot"></span>
    </div>
    <div class="tb-clock" id="tb-clock">--:-- <small>--</small></div>
    <div class="tb-right">
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <!-- Route bar -->
  <div id="route-bar-wrap" style="padding:10px 14px 0;max-width:900px;margin:0 auto;width:100%">
    <div class="route-bar" id="route-bar">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- Content -->
  <div class="content" id="content">
    <!-- â”€â”€ CHOFER PANEL â”€â”€ -->
    <div class="panel active" id="panel-chofer">
      <!-- GPS -->
      <div class="gps-bar load" id="gps-bar">
        <div class="dot anim"></div><span id="gps-txt">Iniciando GPS...</span>
      </div>
      <!-- Sync -->
      <div id="sync-bar" style="display:none;background:var(--blu-g);border:1px solid rgba(79,142,255,.3);border-radius:9px;padding:7px 12px;font-size:11px;color:var(--blu);margin-bottom:10px">
        â³ Sincronizando con Firebase...
      </div>
      <!-- Retomar banner -->
      <div class="retomar" id="retomar-banner">
        <div class="retomar-title">ğŸ”„ Tienes un viaje en curso</div>
        <div class="retomar-info" id="retomar-info"></div>
        <div class="retomar-btns">
          <button class="btn btn-blue" onclick="retomarViaje()">â–¶ Continuar viaje</button>
          <button class="btn btn-red btn-sm" onclick="cancelarViaje()">âœ•</button>
        </div>
      </div>
      <!-- Steps -->
      <div class="steps">
        <div class="step-bar active" id="sb-1"></div>
        <div class="step-bar" id="sb-2"></div>
        <div class="step-bar" id="sb-3"></div>
      </div>

      <!-- PASO 1: SALIDA -->
      <div class="card c-blue" id="card-1">
        <div class="card-title"><span class="num">1</span>Registrar Salida</div>
        <div class="frow" style="margin-bottom:10px">
          <div class="field" style="margin:0">
            <label>Origen</label>
            <select id="s-origen" onchange="onOrigenChange()">
              <option value="">â€” Selecciona â€”</option>
              <option value="CORIRE">ğŸ“ CORIRE</option>
              <option value="APLAO">ğŸ“ APLAO</option>
            </select>
            <div id="gps-origen-hint" style="font-size:10px;color:var(--grn);font-family:var(--fm);margin-top:4px;display:none">âœ… Auto-seleccionado por GPS</div>
          </div>
          <div class="field" style="margin:0">
            <label>Hora salida</label>
            <input type="time" id="s-hora" style="font-size:16px">
          </div>
        </div>
        <div class="prox" id="prox-1">
          <div class="prox-label" id="prox-1-lbl">ğŸ“ Dist: â€”</div>
          <div class="prox-track"><div class="prox-fill" id="prox-1-fill" style="width:0%"></div></div>
        </div>
        <div class="fuera-zona" id="fz-1">ğŸ“ EstÃ¡s lejos del punto de salida Â· <strong id="fz-1-dist">â€”</strong></div>
        <div class="alert" id="alert-1"></div>
        <button class="btn btn-blue" onclick="registrarSalida()">ğŸš€ REGISTRAR SALIDA</button>
      </div>

      <!-- Incidente -->
      <div id="inc-section" style="display:none;margin-bottom:12px">
        <button class="btn btn-ghost" style="border-color:var(--amb);color:var(--amb)" onclick="openIncModal()">ğŸš¨ Reportar Incidente</button>
      </div>

      <!-- PASO 2: MAMÃS -->
      <div class="card c-green disabled" id="card-2">
        <div class="card-title"><span class="num">2</span>Llegada a MamÃ¡s</div>
        <div class="prox" id="prox-2">
          <div class="prox-label" id="prox-2-lbl">ğŸ“ Dist. a MamÃ¡s: â€”</div>
          <div class="prox-track"><div class="prox-fill" id="prox-2-fill" style="width:0%"></div></div>
        </div>
        <div class="countdown" id="cd-mamas">
          <div class="cd-lbl">â± Tiempo para llegar a MamÃ¡s</div>
          <div class="cd-val g" id="cd-mamas-val">--:--</div>
          <div class="cd-bar"><div class="cd-fill" id="cd-mamas-fill" style="width:100%;background:var(--grn)"></div></div>
        </div>
        <div class="auto-box" id="auto-mamas">
          <div class="auto-box-title">ğŸ¤– Auto-marcando en <span id="auto-mamas-cnt">3</span>s</div>
          <div class="auto-box-sub">El sistema marcarÃ¡ MamÃ¡s automÃ¡ticamente</div>
          <button class="btn btn-red" onclick="cancelAutoMamas()" style="max-width:180px;margin:0 auto">âœ‹ Cancelar</button>
        </div>
        <div class="fuera-zona" id="fz-2">ğŸ“ Fuera de zona MamÃ¡s Â· <strong id="fz-2-dist">â€”</strong> Â· Puedes marcar igualmente</div>
        <div class="alert" id="alert-2"></div>
        <button class="btn btn-green" onclick="registrarMamas()">ğŸ“ MARCAR EN MAMÃS</button>
      </div>

      <!-- PASO 3: LLEGADA -->
      <div class="card c-amber disabled" id="card-3">
        <div class="card-title"><span class="num">3</span>Llegada Final</div>
        <div class="dest-display" id="dest-display">â€” AutomÃ¡tico â€”</div>
        <div class="prox" id="prox-3">
          <div class="prox-label" id="prox-3-lbl">ğŸ“ Dist. al destino: â€”</div>
          <div class="prox-track"><div class="prox-fill" id="prox-3-fill" style="width:0%"></div></div>
        </div>
        <div class="countdown" id="cd-dest">
          <div class="cd-lbl">â± Tiempo para llegar al destino</div>
          <div class="cd-val g" id="cd-dest-val">--:--</div>
          <div class="cd-bar"><div class="cd-fill" id="cd-dest-fill" style="width:100%;background:var(--amb)"></div></div>
        </div>
        <div class="auto-box" id="auto-dest">
          <div class="auto-box-title">ğŸ¤– Auto-registrando en <span id="auto-dest-cnt">3</span>s</div>
          <div class="auto-box-sub">El sistema registrarÃ¡ la llegada automÃ¡ticamente</div>
          <button class="btn btn-red" onclick="cancelAutoLlegada()" style="max-width:180px;margin:0 auto">âœ‹ Cancelar</button>
        </div>
        <div class="fuera-zona" id="fz-3">ğŸ“ Fuera de zona destino Â· <strong id="fz-3-dist">â€”</strong> Â· Puedes registrar igualmente</div>
        <div class="alert" id="alert-3"></div>
        <button class="btn btn-amber" onclick="registrarLlegada()">ğŸ REGISTRAR LLEGADA</button>
      </div>

      <!-- Mis viajes -->
      <div class="card c-wire">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div class="card-title" style="margin:0">ğŸ“‹ Mis viajes hoy</div>
          <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Llegada</th><th>Tardanza</th><th>Multa S/</th></tr></thead>
            <tbody id="hist-tbody"><tr><td colspan="7" style="color:var(--txt2);text-align:center;padding:20px">Sin viajes hoy</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ MONITOR PANEL â”€â”€ -->
    <div class="panel" id="panel-monitor">
      <div class="stats-row" id="monitor-stats"></div>
      <div class="units-grid" id="units-grid"></div>
      <div class="card c-wire">
        <div class="card-title" style="margin-bottom:10px">ğŸšŒ Viajes en curso</div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>U#</th><th>Chofer</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Esperada</th><th>Tardanza</th><th>GPS</th></tr></thead>
            <tbody id="monitor-tbody"><tr><td colspan="8" style="color:var(--txt2);text-align:center;padding:16px">Sin viajes activos</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ SUPERVISOR PANEL â”€â”€ -->
    <div class="panel" id="panel-sup" style="padding-bottom:80px">
      <!-- Tabs internos -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
        <button class="btn btn-blue btn-sm" onclick="showSupTab('historial')">ğŸ“… Historial</button>
        <button class="btn btn-ghost btn-sm" onclick="showSupTab('multas')">ğŸ’° Multas</button>
        <button class="btn btn-ghost btn-sm" onclick="showSupTab('config')">âš™ï¸ Config</button>
        <button class="btn btn-ghost btn-sm" onclick="showSupTab('alertas')">ğŸ“¡ GPS Alertas</button>
        <button class="btn btn-ghost btn-sm" onclick="showSupTab('incidentes')">ğŸš¨ Incidentes</button>
        <button class="btn btn-ghost btn-sm" onclick="showSupTab('reporte')">ğŸ“Š Reporte</button>
      </div>
      <!-- Historial -->
      <div id="sup-historial" class="sup-tab">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <input type="date" id="hist-fecha" style="background:var(--ink3);border:1px solid var(--wire);border-radius:8px;color:var(--txt);font-family:var(--fm);font-size:13px;padding:8px 10px;outline:none">
          <button class="btn btn-blue btn-sm" onclick="loadHistFecha()">Ver</button>
          <button class="btn btn-ghost btn-sm" onclick="exportHistCSV()">ğŸ“¥ CSV</button>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>U#</th><th>Chofer</th><th>Origen</th><th>Salida</th><th>MamÃ¡s</th><th>Destino</th><th>Llegada</th><th>Tardanza</th><th>Multa</th><th>GPS</th></tr></thead>
            <tbody id="hist-sup-tbody"></tbody>
          </table>
        </div>
      </div>
      <!-- Multas externas -->
      <div id="sup-multas" class="sup-tab hidden">
        <div class="card c-amber">
          <div class="card-title">ğŸ’° Registrar Multa Manual</div>
          <div class="frow" style="margin-bottom:10px">
            <div class="field" style="margin:0">
              <label>Unidad</label>
              <select id="mult-u"><option value="">â€”</option></select>
            </div>
            <div class="field" style="margin:0">
              <label>Monto S/</label>
              <input type="number" id="mult-m" placeholder="0" min="0">
            </div>
          </div>
          <div class="field"><label>Motivo</label><input id="mult-mot" placeholder="DescripciÃ³n..."></div>
          <button class="btn btn-amber" onclick="addMulta()">Registrar Multa</button>
        </div>
        <div id="multas-list"></div>
      </div>
      <!-- Config -->
      <div id="sup-config" class="sup-tab hidden">
        <div class="card c-blue">
          <div class="card-title">â± Tiempos (minutos)</div>
          <div class="frow3" style="margin-bottom:10px">
            <div class="field" style="margin:0"><label>CORâ†’MAM</label><input type="number" id="t-cm" min="1"></div>
            <div class="field" style="margin:0"><label>MAMâ†’APL</label><input type="number" id="t-ma" min="1"></div>
            <div class="field" style="margin:0"><label>APLâ†’MAM</label><input type="number" id="t-am" min="1"></div>
          </div>
          <div class="frow3" style="margin-bottom:10px">
            <div class="field" style="margin:0"><label>MAMâ†’COR</label><input type="number" id="t-mc" min="1"></div>
            <div class="field" style="margin:0"><label>CORâ†’APL</label><input type="number" id="t-ca" min="1"></div>
            <div class="field" style="margin:0"><label>APLâ†’COR</label><input type="number" id="t-ac" min="1"></div>
          </div>
          <button class="btn btn-blue" onclick="saveTimings()">Guardar tiempos</button>
        </div>
        <div class="card c-wire">
          <div class="card-title">ğŸ“¡ Zonas GPS</div>
          <div class="frow3" style="margin-bottom:10px">
            <div class="field" style="margin:0"><label>Lat Corire</label><input type="number" step="any" id="lat-cor"></div>
            <div class="field" style="margin:0"><label>Lon Corire</label><input type="number" step="any" id="lon-cor"></div>
            <div class="field" style="margin:0"><label>Radio (m)</label><input type="number" id="rad-cor"></div>
          </div>
          <div class="frow3" style="margin-bottom:10px">
            <div class="field" style="margin:0"><label>Lat MamÃ¡s</label><input type="number" step="any" id="lat-mam"></div>
            <div class="field" style="margin:0"><label>Lon MamÃ¡s</label><input type="number" step="any" id="lon-mam"></div>
            <div class="field" style="margin:0"><label>Radio (m)</label><input type="number" id="rad-mam"></div>
          </div>
          <div class="frow3" style="margin-bottom:10px">
            <div class="field" style="margin:0"><label>Lat Aplao</label><input type="number" step="any" id="lat-apl"></div>
            <div class="field" style="margin:0"><label>Lon Aplao</label><input type="number" step="any" id="lon-apl"></div>
            <div class="field" style="margin:0"><label>Radio (m)</label><input type="number" id="rad-apl"></div>
          </div>
          <button class="btn btn-ghost" onclick="saveZones()">Guardar zonas</button>
        </div>
        <div class="card c-wire">
          <div class="card-title">ğŸ‘¤ Nombres Choferes</div>
          <div id="choferes-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px"></div>
          <button class="btn btn-ghost" onclick="saveChoferes()">Guardar nombres</button>
        </div>
        <div class="card c-red">
          <div class="card-title">ğŸ”‘ Cambiar Clave Supervisor</div>
          <div class="frow" style="margin-bottom:10px">
            <div class="field" style="margin:0"><label>Nueva clave</label><input type="password" id="new-key"></div>
            <div class="field" style="margin:0"><label>Confirmar</label><input type="password" id="new-key2"></div>
          </div>
          <button class="btn btn-ghost" onclick="changeClave()">Cambiar clave</button>
          <div class="alert" id="clave-alert" style="margin-top:8px;margin-bottom:0"></div>
        </div>
      </div>
      <!-- GPS Alertas -->
      <div id="sup-alertas" class="sup-tab hidden">
        <div id="gps-alertas-list"></div>
      </div>
      <!-- Incidentes -->
      <div id="sup-incidentes" class="sup-tab hidden">
        <div id="inc-lista"></div>
      </div>
      <!-- Reporte mensual -->
      <div id="sup-reporte" class="sup-tab hidden">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
          <button class="btn btn-ghost btn-sm" onclick="mesRep(-1)">â€¹</button>
          <div style="font-family:var(--fs);font-size:18px;font-weight:700;color:var(--amb)" id="mes-lbl">â€”</div>
          <button class="btn btn-ghost btn-sm" onclick="mesRep(1)">â€º</button>
          <button class="btn btn-amber btn-sm" onclick="cerrarMes()">Cerrar mes</button>
          <button class="btn btn-ghost btn-sm" onclick="exportReportePDF()">ğŸ“„ PDF</button>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>U#</th><th>Chofer</th><th>Viajes</th><th>Tardanza (min)</th><th>Multa S/</th><th>Extras S/</th><th>TOTAL S/</th></tr></thead>
            <tbody id="rep-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ DASHBOARD â”€â”€ -->
    <div class="panel" id="panel-dash">
      <div class="stats-row" id="dash-stats"></div>
      <div class="chart-wrap">
        <div class="chart-title">Tardanza por Unidad (hoy)</div>
        <canvas id="chart-tard" height="180"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-title">Viajes por hora</div>
        <canvas id="chart-hora" height="140"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Incidente Modal -->
<div class="modal-bg" id="modal-inc">
  <div class="modal">
    <button class="modal-close" onclick="closeIncModal()">âœ•</button>
    <h3>ğŸš¨ Reportar Incidente</h3>
    <div id="modal-inc-sub" style="font-size:11px;color:var(--txt2);margin-bottom:14px"></div>
    <div class="field"><label>Tipo</label>
      <select id="inc-tipo">
        <option value="">â€” Selecciona â€”</option>
        <option>Accidente</option><option>AverÃ­a mecÃ¡nica</option><option>Bloqueo de vÃ­a</option>
        <option>Pasajero conflictivo</option><option>Retraso por clima</option><option>Otro</option>
      </select>
    </div>
    <div class="field"><label>DescripciÃ³n</label><textarea id="inc-desc" placeholder="Describe el incidente..."></textarea></div>
    <div class="field"><label>UbicaciÃ³n GPS</label><input id="inc-gps" readonly placeholder="â€”"></div>
    <div class="alert" id="inc-alert" style="margin-bottom:10px"></div>
    <button class="btn btn-amber" onclick="sendIncidente()">Enviar reporte</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const N_UNITS = 20;
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

let DB = null;
let SESSION = {role:null, unit:null};
let gpsPos = null, gpsWatch = null;
let repMonth = new Date();

// Ground-truth local state â€” NOT overwritten by Firebase
let LV = null; // Local Viaje
let tripActive = false;

// Firebase mirror
let FD = {
  config:{
    times:{cm:18,ma:12,am:19,mc:13,ca:31,ac:31},
    pts:{
      CORIRE:{lat:-16.2163867,lon:-72.4692981,r:300},
      MAMAS:{lat:-16.1515679,lon:-72.4918005,r:200},
      APLAO:{lat:-16.0897344,lon:-72.4919021,r:300}
    },
    choferes:{},
    supKey:'1234'
  },
  active:{}, hist:{}, acum:{}, multas:{}, gpsAlerts:{}, incidents:{}, report:{}
};

// Auto-timer state â€” using setTimeout chain, never setInterval
let cdInterval = null;
let autoMamasTO = null, autoDestTO = null;
let autoMamasLock = false, autoDestLock = false;
let cancelMamas = false, cancelDest = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const now = () => {
  const d = new Date();
  const h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
  const hh = String(h>12?h-12:h||12).padStart(2,'0');
  const mm = String(m).padStart(2,'0');
  const ss = String(s).padStart(2,'0');
  const ap = h>=12?'PM':'AM';
  return {h,m,s,min:h*60+m,sec:h*3600+m*60+s,txt:`${String(h).padStart(2,'0')}:${mm}`,txt12:`${hh}:${mm}`,ap,full:`${hh}:${mm}:${ss} ${ap}`};
};
const minToTxt = mn => `${String(Math.floor(mn/60)).padStart(2,'0')}:${String(mn%60).padStart(2,'0')}`;
const parseTxt = t => {if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+(m||0);};
const crossMin = (tArr, ref) => {
  let m = parseTxt(tArr);
  if(m < parseTxt(ref) - 60) m += 1440;
  return m;
};
const today = () => new Date().toISOString().slice(0,10);
const choferName = u => (FD.config.choferes && FD.config.choferes[u]) || `Chofer U${String(u).padStart(2,'0')}`;
const tEsp = (from, to) => {
  const T = FD.config.times;
  if(from==='CORIRE'&&to==='MAMAS') return T.cm;
  if(from==='MAMAS'&&to==='APLAO') return T.ma;
  if(from==='APLAO'&&to==='MAMAS') return T.am;
  if(from==='MAMAS'&&to==='CORIRE') return T.mc;
  if(from==='CORIRE'&&to==='APLAO') return T.cm+T.ma;
  if(from==='APLAO'&&to==='CORIRE') return T.am+T.mc;
  return 30;
};
const distTo = pt => {
  if(!gpsPos || !FD.config.pts[pt]) return null;
  const p = FD.config.pts[pt];
  const R=6371000, dLat=(p.lat-gpsPos.lat)*Math.PI/180, dLon=(p.lon-gpsPos.lon)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(gpsPos.lat*Math.PI/180)*Math.cos(p.lat*Math.PI/180)*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
};
const inZone = pt => { const d=distTo(pt); return d!==null && d<=(FD.config.pts[pt]?.r||200); };
const fmtDist = d => d>=1000?`${(d/1000).toFixed(1)}km`:`${d}m`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveCfg(){
  const cfg={apiKey:$('cfg-key').value.trim(),databaseURL:$('cfg-url').value.trim(),projectId:$('cfg-pid').value.trim()};
  if(!cfg.apiKey||!cfg.databaseURL){setAlert('setup-alert','Completa API Key y Database URL','err');return;}
  localStorage.setItem('ft_cfg',JSON.stringify(cfg));
  initFB(cfg);
}
function loadSavedCfg(){
  const s=localStorage.getItem('ft_cfg');
  if(!s){setAlert('setup-alert','No hay configuraciÃ³n guardada','err');return;}
  const c=JSON.parse(s);
  $('cfg-key').value=c.apiKey||''; $('cfg-url').value=c.databaseURL||''; $('cfg-pid').value=c.projectId||'';
  initFB(c);
}
function initFB(cfg){
  try{if(firebase.apps.length)firebase.app().delete();}catch(e){}
  try{
    firebase.initializeApp(cfg);
    DB=firebase.database();
    DB.ref('.info/connected').on('value',s=>{
      const on=s.val();
      $('conn-dot').className='conn-dot'+(on?'':' off');
    });
    subscribeFB();
    $('s-setup').classList.add('hidden');
    $('s-login').classList.remove('hidden');
    setAlert('setup-alert','Conectado âœ“','ok');
  }catch(e){setAlert('setup-alert','Error: '+e.message,'err');}
}
function reconfig(){$('s-login').classList.add('hidden');$('s-setup').classList.remove('hidden');}

function subscribeFB(){
  DB.ref('config').on('value',s=>{if(s.val())FD.config={...FD.config,...s.val()};refreshConfigForms();});
  DB.ref('viajesActivos').on('value',s=>{FD.active=s.val()||{};renderMonitor();checkRetomar();});
  DB.ref('historialDia').on('value',s=>{FD.hist=s.val()||{};renderHistChofer();renderHistSup();});
  DB.ref('tardanzaAcum').on('value',s=>{FD.acum=s.val()||{};});
  DB.ref('multasExternas').on('value',s=>{FD.multas=s.val()||{};renderMultas();});
  DB.ref('gpsAlertas').on('value',s=>{FD.gpsAlerts=s.val()||{};renderGpsAlerts();});
  DB.ref('incidentes').on('value',s=>{FD.incidents=s.val()||{};renderIncidentes();});
  DB.ref('reporteMensual').on('value',s=>{FD.report=s.val()||{};});
}
const fbSet=(p,v)=>{if(!DB)return;showSync(true);return DB.ref(p).set(v).finally(()=>showSync(false));};
const fbUpd=(p,v)=>{if(!DB)return;showSync(true);return DB.ref(p).update(v).finally(()=>showSync(false));};
const fbPush=(p,v)=>{if(!DB)return;return DB.ref(p).push(v);};
const fbDel=(p)=>{if(!DB)return;return DB.ref(p).remove();};
function showSync(on){$('sync-bar').style.display=on?'block':'none';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curRole = null;
function selRole(r){
  curRole=r;
  $('rt-chofer').classList.toggle('sel',r==='chofer');
  $('rt-sup').classList.toggle('sel',r==='sup');
  $('login-chofer').classList.toggle('hidden',r!=='chofer');
  $('login-sup').classList.toggle('hidden',r!=='sup');
}
function doLogin(){
  if(!curRole){setAlert('login-alert','Selecciona tu rol','err');return;}
  if(curRole==='chofer'){
    const u=$('login-unit').value;
    if(!u){setAlert('login-alert','Selecciona tu unidad','err');return;}
    SESSION={role:'chofer',unit:u};
    startApp();
  } else {
    const k=$('login-key').value;
    if(k!==FD.config.supKey&&k!==localStorage.getItem('sup_key')){setAlert('login-alert','Clave incorrecta','err');return;}
    SESSION={role:'sup',unit:null};
    startApp();
  }
}
function doLogout(){
  stopGPS();stopCountdown();
  LV=null;tripActive=false;SESSION={role:null,unit:null};
  $('s-app').classList.remove('vis');$('s-app').style.display='none';
  $('s-login').classList.remove('hidden');
  $('login-key').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startApp(){
  $('s-login').classList.add('hidden');
  $('s-app').style.display='flex'; $('s-app').classList.add('vis');
  buildTabs();
  buildLoginUnitSelects();
  $('tb-unit').textContent = SESSION.role==='sup' ? 'ğŸ‘® SUPERVISOR' : `ğŸšŒ U${String(SESSION.unit).padStart(2,'0')}`;
  startClock();
  if(SESSION.role==='chofer'){
    startGPS();
    setTimeout(()=>checkRetomar(),1500);
  } else {
    $('route-bar-wrap').style.display='none';
    renderMonitor();renderDash();
  }
  renderConfigForms();
  renderReporte();
  updateRouteBar(null);
}
function buildTabs(){
  const isSup=SESSION.role==='sup';
  const t=isSup
    ?[['monitor','ğŸ–¥ Monitor'],['sup','ğŸ‘® Supervisor'],['dash','ğŸ“Š Dashboard']]
    :[['chofer','ğŸšŒ Mis Viajes'],['monitor','ğŸ–¥ Monitor']];
  $('tabs').innerHTML=t.map(([id,lbl],i)=>
    `<div class="tab${i===0?' active':''}" onclick="setTab('${id}',this)">${lbl}</div>`).join('');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('panel-'+t[0][0]).classList.add('active');
}
function setTab(id,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('panel-'+id).classList.add('active');
  if(id==='monitor')renderMonitor();
  if(id==='dash')renderDash();
  if(id==='sup'){showSupTab('historial');loadHistFecha();}
}
function showSupTab(id){
  document.querySelectorAll('.sup-tab').forEach(t=>t.classList.add('hidden'));
  $('sup-'+id).classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startClock(){
  const tick=()=>{
    const t=now();
    $('tb-clock').innerHTML=`${t.txt12} <small>${t.ap}</small>`;
    // Keep hora field synced if not in active trip
    const hf=$('s-hora');
    if(hf && !LV && !tripActive) hf.value=t.txt;
  };
  tick();setInterval(tick,1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGPS(){
  if(!navigator.geolocation){setGPSBar('err','GPS no disponible');return;}
  setGPSBar('load','Iniciando GPS...');
  gpsWatch=navigator.geolocation.watchPosition(pos=>{
    gpsPos={lat:pos.coords.latitude,lon:pos.coords.longitude,acc:pos.coords.accuracy};
    const acc=Math.round(pos.coords.accuracy);
    setGPSBar('ok',`GPS Â±${acc}m Â· ${gpsPos.lat.toFixed(5)}, ${gpsPos.lon.toFixed(5)}`);
    updateProx();
    // Auto-select origin by GPS zone
    if(!LV && !tripActive){
      const sel=$('s-origen');
      const prevVal=sel.value;
      if(inZone('CORIRE')){
        sel.value='CORIRE';
        if(prevVal!=='CORIRE') onOrigenChange();
      } else if(inZone('APLAO')){
        sel.value='APLAO';
        if(prevVal!=='APLAO') onOrigenChange();
      }
    }
  },err=>{
    setGPSBar('err','Error GPS: '+err.message);
  },{enableHighAccuracy:true,timeout:30000,maximumAge:5000});
}
function stopGPS(){if(gpsWatch)navigator.geolocation.clearWatch(gpsWatch);gpsWatch=null;}
function setGPSBar(st,txt){
  const b=$('gps-bar');
  b.className='gps-bar '+st;
  b.innerHTML=`<div class="dot${st==='load'?' anim':''}"></div><span>${txt}</span>`;
}
function updateProx(){
  if(!LV&&!tripActive) updateProxPt('1','s-origen',$('s-origen').value);
  if(LV&&!LV.mamasHora) updateProxPt2();
  if(LV&&LV.mamasHora) updateProxPt3();
}
function updateProxPt(pid,selId,pt){
  const pw=$('prox-'+pid), fz=$('fz-'+pid);
  if(!pt||!gpsPos){pw.style.display='none';if(fz)fz.style.display='none';return;}
  pw.style.display='block';
  const d=distTo(pt), r=FD.config.pts[pt]?.r||200;
  const pct=Math.min(100,Math.max(0,(1-d/r)*100));
  $('prox-'+pid+'-lbl').textContent=`ğŸ“ Dist. a ${pt}: ${fmtDist(d)} (zona: ${r}m)`;
  $('prox-'+pid+'-fill').style.width=pct+'%';
  $('prox-'+pid+'-fill').style.background=pct>80?'var(--grn)':pct>40?'var(--amb)':'var(--red)';
  if(fz) fz.style.display=d>r?'block':'none';
  if(fz&&d>r) fz.querySelector('strong').textContent=fmtDist(d);
}
function updateProxPt2(){updateProxPt('2','','MAMAS');}
function updateProxPt3(){if(LV) updateProxPt('3','',LV.dest);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTE BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateRouteBar(origen){
  if(SESSION.role==='sup'){$('route-bar-wrap').style.display='none';return;}
  const T=FD.config.times;
  let html='';
  const stops=origen==='APLAO'
    ?[{id:'APLAO',cls:'a',lbl:'APLAO'},{t:T.am+'m',lbl2:'â†'+T.mc+'m'},{id:'MAMAS',cls:'m',lbl:'MAMÃS'},{t:T.mc+'m',lbl2:'â†'+T.am+'m'},{id:'CORIRE',cls:'c',lbl:'CORIRE'}]
    :[{id:'CORIRE',cls:'c',lbl:'CORIRE'},{t:T.cm+'m',lbl2:'â†'+T.mc+'m'},{id:'MAMAS',cls:'m',lbl:'MAMÃS'},{t:T.ma+'m',lbl2:'â†'+T.am+'m'},{id:'APLAO',cls:'a',lbl:'APLAO'}];

  let activeDone = origen ? false : true;
  for(const s of stops){
    if(s.t!==undefined){
      html+=`<div class="rb-line"><span class="rb-time">${s.t}</span></div>`;
    } else {
      const active = LV&&LV.origen===s.id;
      const done = LV&&((s.id==='MAMAS'&&LV.mamasHora)||(s.id===LV.dest&&LV.arrived));
      html+=`<div class="rb-stop">
        <div class="rb-dot ${s.cls}${active?' active':''}${done?' done':''}">${s.lbl.slice(0,3)}</div>
        <div class="rb-name" style="color:var(--${s.cls==='c'?'blu':s.cls==='m'?'grn':'amb'})">${s.lbl}</div>
      </div>`;
    }
  }
  $('route-bar').innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 1: SALIDA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onOrigenChange(){
  const o=$('s-origen').value;
  updateRouteBar(o);
  updateProxPt('1','s-origen',o);
}
function setOrigenGPS(pt){
  const sel=$('s-origen');
  const hint=$('gps-origen-hint');
  if(sel && sel.value !== pt){
    sel.value=pt;
    onOrigenChange();
    if(hint) hint.style.display='block';
  } else if(sel && sel.value === pt){
    if(hint) hint.style.display='block';
  }
}
function registrarSalida(){
  const origen=$('s-origen').value;
  const horaInput=$('s-hora').value;
  if(!origen){setAlert('alert-1','Selecciona origen','err');return;}
  const hora=horaInput; if(!hora){setAlert('alert-1','Ingresa la hora de salida','err');return;}
  const u=SESSION.unit;
  const salidaMin=parseTxt(hora);
  const dest=origen==='CORIRE'?'APLAO':'CORIRE';
  const esperMin=salidaMin+tEsp(origen,dest);

  let gpsOk=true,gpsSnap=null,dist=null;
  if(gpsPos){dist=distTo(origen);gpsOk=dist<=(FD.config.pts[origen]?.r||200);gpsSnap={lat:gpsPos.lat,lon:gpsPos.lon,acc:Math.round(gpsPos.acc)};}

  const viaje={unit:u,origen,dest,salida:hora,salidaMin,esperMin,mamasHora:null,tardMamas:0,gpsOk,gpsSal:gpsSnap,fecha:today(),id:Date.now()};

  // Set local state FIRST
  LV=viaje;tripActive=true;

  // Firebase async
  fbSet('viajesActivos/'+u,viaje);
  if(!gpsOk&&gpsPos) fbPush('gpsAlertas',{tipo:'SALIDA',unit:u,dist,hora,pt:origen,fecha:today(),ts:Date.now()});

  setAlert('alert-1', gpsOk?`âœ… Salida de ${origen} a las ${hora}`:`âš ï¸ GPS a ${dist}m de ${origen} â€” salida registrada`, gpsOk?'ok':'warn');

  // Update UI
  $('dest-display').textContent=dest;
  $('dest-display').style.color=dest==='APLAO'?'var(--amb)':'var(--blu)';
  $('card-2').classList.remove('disabled');
  $('cd-mamas').classList.add('show');
  $('prox-2').style.display='block';
  $('inc-section').style.display='block';
  setStep(2);
  updateRouteBar(origen);
  startCountdown();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 2: MAMÃS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function registrarMamas(){
  if(!LV){setAlert('alert-2','Sin viaje activo','err');return;}
  if(LV.mamasHora){setAlert('alert-2','MamÃ¡s ya registrado: '+LV.mamasHora,'warn');return;}

  // Stop auto immediately
  stopAutoMamas();

  const hora=now().txt;
  const u=SESSION.unit;
  let gpsOk=true,gpsSnap=null,dist=null;
  if(gpsPos){dist=distTo('MAMAS');gpsOk=dist<=(FD.config.pts.MAMAS?.r||200);gpsSnap={lat:gpsPos.lat,lon:gpsPos.lon,acc:Math.round(gpsPos.acc)};}

  const mamasEspMin=LV.salidaMin+tEsp(LV.origen,'MAMAS');
  const mamasMin=crossMin(hora,LV.salida);
  const tardMamas=Math.max(0,mamasMin-mamasEspMin);

  // Update local state
  LV={...LV,mamasHora:hora,tardMamas,mamasEspMin,gpsMamas:gpsSnap,gpsOkMamas:gpsOk};

  // Firebase async
  fbUpd('viajesActivos/'+u,{mamasHora:hora,tardMamas,mamasEspMin,gpsMamas:gpsSnap,gpsOkMamas:gpsOk});
  if(!gpsOk&&gpsPos) fbPush('gpsAlertas',{tipo:'MAMÃS',unit:u,dist,hora,pt:'MAMAS',fecha:today(),ts:Date.now()});

  setAlert('alert-2',tardMamas>0?`âš ï¸ MamÃ¡s +${tardMamas}min tarde Â· Hora: ${hora}`:`âœ… MamÃ¡s a tiempo Â· Hora: ${hora}`,tardMamas>0?'warn':'ok');

  // Collapse paso 2
  const c2=$('card-2');
  c2.classList.add('disabled');
  c2.style.opacity='0.75';
  // Insert done badge
  const badge=document.createElement('div');
  badge.className='mamas-done';badge.id='mamas-done-badge';
  badge.innerHTML=`<span>âœ…</span><span>MAMÃS: ${hora}${tardMamas>0?' Â· +'+tardMamas+'min tarde':' Â· a tiempo'}</span>`;
  c2.appendChild(badge);

  // Enable paso 3
  $('card-3').classList.remove('disabled');
  $('cd-dest').classList.add('show');
  $('prox-3').style.display='block';
  setStep(3);

  // Scroll to paso 3
  setTimeout(()=>$('card-3').scrollIntoView({behavior:'smooth',block:'start'}),300);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASO 3: LLEGADA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function registrarLlegada(){
  if(!LV){setAlert('alert-3','Sin viaje activo','err');return;}
  if(!LV.mamasHora){setAlert('alert-3','Primero marca en MamÃ¡s','err');return;}

  stopAutoLlegada();

  const hora=now().txt;
  const u=SESSION.unit;
  const dest=LV.dest;
  let gpsOk=true,gpsSnap=null,dist=null;
  if(gpsPos){dist=distTo(dest);gpsOk=dist<=(FD.config.pts[dest]?.r||200);gpsSnap={lat:gpsPos.lat,lon:gpsPos.lon,acc:Math.round(gpsPos.acc)};}

  const llegMin=crossMin(hora,LV.salida);
  const tardLleg=Math.max(0,llegMin-LV.esperMin);
  const tardMamas=LV.tardMamas||0;
  const tardTotal=tardLleg+tardMamas;
  const acumPrev=FD.acum[u]||0;
  const acumNew=acumPrev+tardTotal;
  const gpsAll=LV.gpsOk!==false&&LV.gpsOkMamas!==false&&gpsOk;

  const comp={...LV,destFinal:dest,llegada:hora,llegMin,tardLleg,tardTotal,gpsLleg:gpsSnap,gpsOkLleg:gpsOk,gpsAlert:!gpsAll,done:Date.now()};

  // Clear local state BEFORE async ops
  LV=null;tripActive=false;

  fbDel('viajesActivos/'+u);
  fbPush('historialDia',comp);
  fbSet('tardanzaAcum/'+u,acumNew);
  if(!gpsOk&&gpsPos) fbPush('gpsAlertas',{tipo:'LLEGADA',unit:u,dist,hora,pt:dest,fecha:today(),ts:Date.now()});

  const parts=[];
  if(tardMamas>0)parts.push(`MamÃ¡s +${tardMamas}min`);
  if(tardLleg>0)parts.push(`Llegada +${tardLleg}min`);
  const det=parts.length?` (${parts.join(', ')})`:' ';
  setAlert('alert-3',
    tardTotal>0?`âš ï¸ ${tardTotal}min tardanza${det}Â· Multa S/${tardTotal} Â· Acum: S/${acumNew}`:`âœ… A tiempo en ${dest} Â· Llegada: ${hora}`,
    tardTotal>0?'warn':'ok');

  // Reset UI
  stopCountdown();
  setStep(1);
  $('card-2').classList.add('disabled');$('card-2').style.opacity='';
  const bd=$('mamas-done-badge');if(bd)bd.remove();
  $('card-3').classList.add('disabled');
  $('inc-section').style.display='none';
  $('s-origen').value='';
  $('dest-display').textContent='â€” AutomÃ¡tico â€”';$('dest-display').style.color='';
  $('prox-1').style.display='none';$('prox-2').style.display='none';$('prox-3').style.display='none';
  $('fz-1').style.display='none';$('fz-2').style.display='none';$('fz-3').style.display='none';
  $('cd-dest').classList.remove('show');
  updateRouteBar(null);
  renderHistChofer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTDOWN TICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startCountdown(){
  stopCountdown();
  cdInterval=setInterval(tickCD,1000);
  tickCD();
}
function stopCountdown(){if(cdInterval){clearInterval(cdInterval);cdInterval=null;}}
function tickCD(){
  if(!LV) return;
  const t=now();
  let s=t.sec;
  if(LV.salidaMin&&s/60<LV.salidaMin-60) s+=86400; // midnight cross

  if(!LV.mamasHora){
    // Countdown to MamÃ¡s
    const espS=(LV.salidaMin+tEsp(LV.origen,'MAMAS'))*60;
    const rest=espS-s;
    const el=$('cd-mamas-val'),ef=$('cd-mamas-fill');
    if(el){
      if(rest>0){
        const mm=Math.floor(rest/60),ss=rest%60;
        el.textContent=String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
        const pct=Math.min(100,rest/(tEsp(LV.origen,'MAMAS')*60)*100);
        el.className='cd-val '+(pct>50?'g':pct>20?'y':'r');
        if(ef){ef.style.width=pct+'%';ef.style.background=pct>50?'var(--grn)':pct>20?'var(--amb)':'var(--red)';}
      } else {
        const lm=Math.floor(Math.abs(rest)/60),ls=Math.abs(rest)%60;
        el.textContent='+'+String(lm).padStart(2,'0')+':'+String(ls).padStart(2,'0')+' TARDE';
        el.className='cd-val r';
        if(ef){ef.style.width='100%';ef.style.background='var(--red)';}
      }
    }
    // Auto-trigger
    if(gpsPos&&inZone('MAMAS')&&!autoMamasLock) startAutoMamas();
    updateProxPt2();
  } else {
    // MamÃ¡s done â€” countdown to dest
    const el=$('cd-mamas-val');
    if(el){el.textContent='âœ… '+LV.mamasHora;el.className='cd-val g';}
    autoMamasLock=true;

    if(LV.dest){
      const espS=LV.esperMin*60;
      const rest=espS-s;
      const el2=$('cd-dest-val'),ef2=$('cd-dest-fill');
      if(el2){
        if(rest>0){
          const mm=Math.floor(rest/60),ss=rest%60;
          el2.textContent=String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0');
          const pct=Math.min(100,rest/(tEsp(LV.origen,LV.dest)*60)*100);
          el2.className='cd-val '+(pct>50?'g':pct>20?'y':'r');
          if(ef2){ef2.style.width=pct+'%';ef2.style.background=pct>50?'var(--blu)':pct>20?'var(--amb)':'var(--red)';}
        } else {
          const lm=Math.floor(Math.abs(rest)/60),ls=Math.abs(rest)%60;
          el2.textContent='+'+String(lm).padStart(2,'0')+':'+String(ls).padStart(2,'0')+' TARDE';
          el2.className='cd-val r';
          if(ef2){ef2.style.width='100%';ef2.style.background='var(--red)';}
        }
      }
      if(gpsPos&&inZone(LV.dest)&&!autoDestLock) startAutoLlegada();
      updateProxPt3();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO REGISTRATION â€” setTimeout chain (guaranteed single call)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startAutoMamas(){
  if(autoMamasLock||autoMamasTO) return;
  if(!LV||LV.mamasHora) return;
  autoMamasLock=true;cancelMamas=false;
  $('auto-mamas').classList.add('show');
  function tick(n){
    if(cancelMamas||!LV||LV.mamasHora){
      stopAutoMamas();return;
    }
    $('auto-mamas-cnt').textContent=n;
    if(n<=0){autoMamasTO=null;$('auto-mamas').classList.remove('show');registrarMamas();return;}
    beep(800,80,.2);
    autoMamasTO=setTimeout(()=>tick(n-1),1000);
  }
  tick(3);
}
function stopAutoMamas(){
  cancelMamas=true;autoMamasLock=true;
  if(autoMamasTO){clearTimeout(autoMamasTO);autoMamasTO=null;}
  $('auto-mamas').classList.remove('show');
}
function cancelAutoMamas(){
  stopAutoMamas();
  // Re-allow after 20s if MamÃ¡s still not registered
  setTimeout(()=>{if(LV&&!LV.mamasHora){autoMamasLock=false;cancelMamas=false;}},20000);
}

function startAutoLlegada(){
  if(autoDestLock||autoDestTO) return;
  if(!LV||!LV.mamasHora) return;
  const t=now();
  if(t.min<LV.esperMin-5) return;
  autoDestLock=true;cancelDest=false;
  $('auto-dest').classList.add('show');
  function tick(n){
    if(cancelDest||!LV){
      stopAutoLlegada();return;
    }
    $('auto-dest-cnt').textContent=n;
    if(n<=0){autoDestTO=null;$('auto-dest').classList.remove('show');registrarLlegada();return;}
    beep(800,80,.2);
    autoDestTO=setTimeout(()=>tick(n-1),1000);
  }
  tick(3);
}
function stopAutoLlegada(){
  cancelDest=true;autoDestLock=true;
  if(autoDestTO){clearTimeout(autoDestTO);autoDestTO=null;}
  $('auto-dest').classList.remove('show');
}
function cancelAutoLlegada(){
  stopAutoLlegada();
  setTimeout(()=>{if(LV&&LV.mamasHora){autoDestLock=false;cancelDest=false;}},20000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP INDICATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStep(n){
  [1,2,3].forEach(i=>{
    const el=$('sb-'+i);
    el.className='step-bar'+(i<n?' done':i===n?' active':'');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RETOMAR VIAJE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkRetomar(){
  if(SESSION.role!=='chofer'||!SESSION.unit) return;
  if(LV&&tripActive) return; // already in trip this session
  const v=FD.active[SESSION.unit];
  if(!v||!v.salida) {$('retomar-banner').classList.remove('show');return;}
  // Trip exists in Firebase from before
  const t=now();
  const tard=Math.max(0,t.min-v.esperMin);
  $('retomar-info').innerHTML=`
    <strong style="color:var(--txt)">${v.origen} â†’ ${v.dest}</strong><br>
    Salida: <span class="mono">${v.salida}</span> Â· MamÃ¡s esperada: <span class="mono">${minToTxt(v.salidaMin+tEsp(v.origen,'MAMAS'))}</span><br>
    ${v.mamasHora?`âœ… MamÃ¡s registrado: <span class="mono">${v.mamasHora}</span><br>`:''}
    Llegada esperada: <span class="mono" style="color:var(--amb)">${minToTxt(v.esperMin)}</span>
    ${tard>0?`<span style="color:var(--red)"> Â· +${tard}min TARDE</span>`:''}
  `;
  $('retomar-banner').classList.add('show');
}
function retomarViaje(){
  const v=FD.active[SESSION.unit];
  if(!v) return;
  LV={...v};tripActive=true;
  $('retomar-banner').classList.remove('show');
  // Restore UI
  $('dest-display').textContent=v.dest;
  $('dest-display').style.color=v.dest==='APLAO'?'var(--amb)':'var(--blu)';
  $('card-2').classList.remove('disabled');
  $('inc-section').style.display='block';
  if(v.mamasHora){
    $('card-2').classList.add('disabled');$('card-2').style.opacity='0.75';
    const b=document.createElement('div');b.className='mamas-done';b.id='mamas-done-badge';
    b.innerHTML=`<span>âœ…</span><span>MAMÃS: ${v.mamasHora}</span>`;
    $('card-2').appendChild(b);
    $('card-3').classList.remove('disabled');
    $('cd-dest').classList.add('show');
    setStep(3);
  } else {
    setStep(2);
  }
  updateRouteBar(v.origen);
  startCountdown();
}
function cancelarViaje(){
  const u=SESSION.unit;
  if(!u) return;
  fbDel('viajesActivos/'+u);
  LV=null;tripActive=false;
  $('retomar-banner').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL CHOFER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistChofer(){
  if(SESSION.role!=='chofer'||!SESSION.unit) return;
  const tbody=$('hist-tbody');
  if(!tbody) return;
  const viajes=Object.values(FD.hist||{}).filter(v=>String(v.unit)===String(SESSION.unit)&&v.fecha===today());
  if(!viajes.length){tbody.innerHTML='<tr><td colspan="7" style="color:var(--txt2);text-align:center;padding:20px">Sin viajes hoy</td></tr>';return;}
  viajes.sort((a,b)=>parseTxt(a.salida)-parseTxt(b.salida));
  tbody.innerHTML=viajes.map(v=>`
    <tr>
      <td><span class="badge ${v.origen==='CORIRE'?'blu':'amb'}">${v.origen}</span></td>
      <td class="mono">${v.salida}</td>
      <td class="mono">${v.mamasHora||'â€”'}</td>
      <td><span class="badge ${v.destFinal==='APLAO'?'amb':'blu'}">${v.destFinal||v.dest}</span></td>
      <td class="mono">${v.llegada||'â€”'}</td>
      <td>${v.tardTotal>0?`<span class="badge red">+${v.tardTotal}min</span>`:'<span class="badge grn">0</span>'}</td>
      <td class="mono">${v.tardTotal>0?'S/'+v.tardTotal:'â€”'}</td>
    </tr>`).join('');
}
function exportCSV(){
  const viajes=Object.values(FD.hist||{}).filter(v=>String(v.unit)===String(SESSION.unit)&&v.fecha===today());
  if(!viajes.length){alert('Sin viajes para exportar');return;}
  const rows=[['Origen','Salida','MamÃ¡s','Destino','Llegada','Tardanza','Multa'],...viajes.map(v=>[v.origen,v.salida,v.mamasHora||'',v.destFinal||v.dest,v.llegada||'',v.tardTotal||0,v.tardTotal>0?v.tardTotal:0])];
  const csv=rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`viajes_U${SESSION.unit}_${today()}.csv`;a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonitor(){
  const grid=$('units-grid'),tbody=$('monitor-tbody');
  if(!grid) return;
  const t=now();
  let running=0,late=0,onTime=0;
  let gridH='',rowsH='';
  for(let i=1;i<=N_UNITS;i++){
    const v=FD.active[i];
    const tard=v?Math.max(0,t.min-v.esperMin):0;
    const cls=v?(tard>0?'late':'run'):'';
    gridH+=`<div class="uc ${cls}">
      <div class="uc-n">U${String(i).padStart(2,'0')}</div>
      <div class="uc-name">${choferName(i)}</div>
      <div class="uc-s" style="color:${v?(tard>0?'var(--red)':'var(--blu)'):'var(--txt2)'}">${v?(tard>0?'+'+tard+'min TARDE':'EN RUTA'):'EN BASE'}</div>
      ${v?`<div class="uc-g">${v.origen}â†’${v.dest}</div>`:''}
    </div>`;
    if(v){running++;if(tard>0)late++;else onTime++;}
  }
  $('monitor-stats').innerHTML=`
    <div class="stat"><div class="stat-v">${running}</div><div class="stat-l">En ruta</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--grn)">${onTime}</div><div class="stat-l">A tiempo</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--red)">${late}</div><div class="stat-l">Con tardanza</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--txt2)">${N_UNITS-running}</div><div class="stat-l">En base</div></div>
  `;
  grid.innerHTML=gridH;
  const activos=Object.entries(FD.active||{});
  if(!activos.length){tbody.innerHTML='<tr><td colspan="8" style="color:var(--txt2);text-align:center;padding:16px">Sin viajes activos</td></tr>';return;}
  rowsH=activos.map(([u,v])=>{
    const tard=Math.max(0,t.min-v.esperMin);
    const mamasEsp=minToTxt(v.salidaMin+tEsp(v.origen,'MAMAS'));
    const mamC=v.mamasHora?`<span class="mono" style="color:var(--grn)">âœ… ${v.mamasHora}</span>`:`<span class="mono" style="color:var(--txt2)">${mamasEsp}</span>`;
    return `<tr>
      <td><strong class="mono">U${String(u).padStart(2,'00')}</strong></td>
      <td>${choferName(u)}</td>
      <td class="mono">${v.salida}</td>
      <td>${mamC}</td>
      <td><span class="badge ${v.dest==='APLAO'?'amb':'blu'}">${v.dest}</span></td>
      <td class="mono">${minToTxt(v.esperMin)}</td>
      <td>${tard>0?`<span class="badge red">+${tard}min</span>`:'<span class="badge grn">OK</span>'}</td>
      <td>${v.gpsSal?'<span class="badge grn">OK</span>':'<span class="badge amb">â€”</span>'}</td>
    </tr>`;
  }).join('');
  tbody.innerHTML=rowsH;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPERVISOR â€” HISTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadHistFecha(){
  const f=$('hist-fecha').value||today();
  $('hist-fecha').value=f;
  renderHistSup(f);
}
function renderHistSup(fecha){
  const f=fecha||$('hist-fecha').value||today();
  const tbody=$('hist-sup-tbody');if(!tbody)return;
  const viajes=Object.values(FD.hist||{}).filter(v=>v.fecha===f);
  if(!viajes.length){tbody.innerHTML='<tr><td colspan="10" style="color:var(--txt2);text-align:center;padding:20px">Sin registros</td></tr>';return;}
  viajes.sort((a,b)=>parseTxt(a.salida)-parseTxt(b.salida));
  tbody.innerHTML=viajes.map(v=>`<tr>
    <td class="mono">U${String(v.unit||v.unidad||'?').padStart(2,'0')}</td>
    <td>${choferName(v.unit||v.unidad)}</td>
    <td><span class="badge ${v.origen==='CORIRE'?'blu':'amb'}">${v.origen}</span></td>
    <td class="mono">${v.salida}</td>
    <td class="mono">${v.mamasHora||'â€”'}</td>
    <td><span class="badge ${(v.destFinal||v.dest)==='APLAO'?'amb':'blu'}">${v.destFinal||v.dest}</span></td>
    <td class="mono">${v.llegada||'â€”'}</td>
    <td>${(v.tardTotal||v.tardanza)>0?`<span class="badge red">+${v.tardTotal||v.tardanza}min</span>`:'<span class="badge grn">0</span>'}</td>
    <td class="mono">${(v.tardTotal||v.tardanza)>0?'S/'+(v.tardTotal||v.tardanza):'â€”'}</td>
    <td>${(v.gpsAlert)?'<span class="badge amb">âš </span>':'<span class="badge grn">OK</span>'}</td>
  </tr>`).join('');
}
function exportHistCSV(){
  const f=$('hist-fecha').value||today();
  const viajes=Object.values(FD.hist||{}).filter(v=>v.fecha===f);
  if(!viajes.length){alert('Sin datos');return;}
  const rows=[['U#','Chofer','Origen','Salida','MamÃ¡s','Destino','Llegada','Tardanza','Multa'],
    ...viajes.map(v=>[`U${String(v.unit||v.unidad).padStart(2,'0')}`,choferName(v.unit||v.unidad),v.origen,v.salida,v.mamasHora||'',v.destFinal||v.dest,v.llegada||'',(v.tardTotal||v.tardanza||0),(v.tardTotal||v.tardanza||0)])];
  const csv=rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download=`historial_${f}.csv`;a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMulta(){
  const u=$('mult-u').value,m=$('mult-m').value,mot=$('mult-mot').value.trim();
  if(!u||!m||!mot){alert('Completa todos los campos');return;}
  fbPush('multasExternas',{unit:u,monto:+m,motivo:mot,fecha:today(),hora:now().txt,ts:Date.now()});
  $('mult-m').value='';$('mult-mot').value='';
}
function renderMultas(){
  const el=$('multas-list');if(!el)return;
  const ms=Object.entries(FD.multas||{}).sort((a,b)=>b[1].ts-a[1].ts);
  if(!ms.length){el.innerHTML='<p style="color:var(--txt2);font-size:12px">Sin multas registradas</p>';return;}
  el.innerHTML=ms.map(([k,m])=>`
    <div style="background:var(--ink3);border:1px solid var(--wire);border-radius:8px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">
      <div>
        <strong class="mono">U${String(m.unit).padStart(2,'00')}</strong>
        <span style="color:var(--amb);margin-left:8px">S/${m.monto}</span>
        <span style="color:var(--txt2);font-size:11px;margin-left:8px">${m.motivo}</span>
        <div style="font-size:10px;color:var(--txt2)">${m.fecha} ${m.hora}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="fbDel('multasExternas/${k}')">âœ•</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG FORMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshConfigForms(){if(SESSION.role==='sup')renderConfigForms();}
function renderConfigForms(){
  if(SESSION.role!=='sup') return;
  const T=FD.config.times||{};
  const F=['cm','ma','am','mc','ca','ac'];
  F.forEach(k=>{const el=$('t-'+k);if(el)el.value=T[k]||'';});
  const P=FD.config.pts||{};
  if($('lat-cor')){
    $('lat-cor').value=P.CORIRE?.lat||'';$('lon-cor').value=P.CORIRE?.lon||'';$('rad-cor').value=P.CORIRE?.r||300;
    $('lat-mam').value=P.MAMAS?.lat||'';$('lon-mam').value=P.MAMAS?.lon||'';$('rad-mam').value=P.MAMAS?.r||200;
    $('lat-apl').value=P.APLAO?.lat||'';$('lon-apl').value=P.APLAO?.lon||'';$('rad-apl').value=P.APLAO?.r||300;
  }
  // Choferes grid
  const cg=$('choferes-grid');if(!cg)return;
  cg.innerHTML=Array.from({length:N_UNITS},(_,i)=>{
    const n=i+1;
    return `<div class="field" style="margin:0">
      <label>U${String(n).padStart(2,'0')}</label>
      <input id="ch-${n}" value="${FD.config.choferes?.[n]||''}">
    </div>`;
  }).join('');
}
function saveTimings(){
  const t={cm:+$('t-cm').value,ma:+$('t-ma').value,am:+$('t-am').value,mc:+$('t-mc').value,ca:+$('t-ca').value,ac:+$('t-ac').value};
  fbUpd('config',{times:t});alert('Tiempos guardados âœ“');
}
function saveZones(){
  const pts={
    CORIRE:{lat:+$('lat-cor').value,lon:+$('lon-cor').value,r:+$('rad-cor').value},
    MAMAS:{lat:+$('lat-mam').value,lon:+$('lon-mam').value,r:+$('rad-mam').value},
    APLAO:{lat:+$('lat-apl').value,lon:+$('lon-apl').value,r:+$('rad-apl').value},
  };
  fbUpd('config',{pts});alert('Zonas guardadas âœ“');
}
function saveChoferes(){
  const ch={};
  for(let i=1;i<=N_UNITS;i++){const el=$('ch-'+i);if(el&&el.value.trim())ch[i]=el.value.trim();}
  fbUpd('config',{choferes:ch});alert('Nombres guardados âœ“');
}
function changeClave(){
  const k=$('new-key').value,k2=$('new-key2').value;
  if(!k||k.length<4){setAlert('clave-alert','MÃ­nimo 4 caracteres','err');return;}
  if(k!==k2){setAlert('clave-alert','Las claves no coinciden','err');return;}
  fbUpd('config',{supKey:k});
  localStorage.setItem('sup_key',k);
  setAlert('clave-alert','Clave cambiada correctamente âœ“','ok');
  $('new-key').value='';$('new-key2').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGpsAlerts(){
  const el=$('gps-alertas-list');if(!el)return;
  const alerts=Object.entries(FD.gpsAlerts||{}).sort((a,b)=>b[1].ts-a[1].ts).slice(0,50);
  if(!alerts.length){el.innerHTML='<p style="color:var(--txt2);font-size:12px">Sin alertas GPS</p>';return;}
  el.innerHTML=alerts.map(([k,a])=>`
    <div style="background:var(--ink3);border:1px solid var(--wire);border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">
      <div>
        <span class="badge amb">${a.tipo}</span>
        <strong class="mono" style="margin-left:8px">U${String(a.unit||a.unidad).padStart(2,'00')}</strong>
        <span style="color:var(--txt2);font-size:11px;margin-left:8px">${a.pt||a.punto} Â· ${fmtDist(a.dist)} Â· ${a.hora}</span>
        <div style="font-size:10px;color:var(--txt2)">${a.fecha}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="fbDel('gpsAlertas/${k}')">âœ•</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INCIDENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openIncModal(){
  const v=LV||FD.active[SESSION.unit];
  $('modal-inc-sub').textContent=v?`U${String(SESSION.unit).padStart(2,'00')} Â· ${v.origen} â†’ ${v.dest} Â· Salida ${v.salida}`:`U${String(SESSION.unit).padStart(2,'00')}`;
  if(gpsPos)$('inc-gps').value=`${gpsPos.lat.toFixed(5)}, ${gpsPos.lon.toFixed(5)}`;
  $('inc-tipo').value='';$('inc-desc').value='';
  $('modal-inc').classList.add('show');
}
function closeIncModal(){$('modal-inc').classList.remove('show');}
function sendIncidente(){
  const tipo=$('inc-tipo').value,desc=$('inc-desc').value.trim();
  if(!tipo){setAlert('inc-alert','Selecciona el tipo','err');return;}
  const v=LV||FD.active[SESSION.unit];
  fbPush('incidentes',{unit:SESSION.unit,tipo,desc,hora:now().txt,fecha:today(),gps:gpsPos?{lat:gpsPos.lat,lon:gpsPos.lon}:null,origen:v?.origen||'',dest:v?.dest||'',ts:Date.now()});
  setAlert('inc-alert','âœ… Incidente reportado','ok');
  setTimeout(closeIncModal,1500);
}
function renderIncidentes(){
  const el=$('inc-lista');if(!el)return;
  const incs=Object.entries(FD.incidents||{}).sort((a,b)=>b[1].ts-a[1].ts).slice(0,50);
  if(!incs.length){el.innerHTML='<p style="color:var(--txt2);font-size:12px">Sin incidentes</p>';return;}
  el.innerHTML=incs.map(([k,i])=>`
    <div style="background:var(--amb-g);border:1px solid rgba(255,179,64,.25);border-radius:8px;padding:10px 12px;margin-bottom:6px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <strong class="mono">U${String(i.unit||i.unidad).padStart(2,'00')}</strong>
        <span class="mono" style="font-size:10px;color:var(--txt2)">${i.hora}</span>
        <span class="badge amb">${i.tipo}</span>
      </div>
      <div style="font-size:11px;color:var(--txt2)">${i.desc||'Sin descripciÃ³n'}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash(){
  const viajes=Object.values(FD.hist||{}).filter(v=>v.fecha===today());
  const totalViajes=viajes.length;
  const totalTard=viajes.reduce((s,v)=>s+(v.tardTotal||v.tardanza||0),0);
  const conTard=viajes.filter(v=>(v.tardTotal||v.tardanza||0)>0).length;
  $('dash-stats').innerHTML=`
    <div class="stat"><div class="stat-v">${totalViajes}</div><div class="stat-l">Viajes hoy</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--red)">${conTard}</div><div class="stat-l">Con tardanza</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--amb)">${totalTard}</div><div class="stat-l">Min tardanza</div></div>
    <div class="stat"><div class="stat-v" style="color:var(--amb)">S/${totalTard}</div><div class="stat-l">Multas</div></div>
  `;
  drawTardBar(viajes);
  drawHoraBar(viajes);
}
function drawTardBar(viajes){
  const c=$('chart-tard');if(!c)return;
  const ctx=c.getContext('2d');
  c.width=c.offsetWidth||350;c.height=180;
  const late=Array.from({length:N_UNITS},(_,i)=>{
    const u=String(i+1);
    return {u:'U'+String(i+1).padStart(2,'0'),t:viajes.filter(v=>String(v.unit||v.unidad)===u).reduce((s,v)=>s+(v.tardTotal||v.tardanza||0),0)};
  }).filter(x=>x.t>0).slice(0,12);
  if(!late.length){ctx.fillStyle='rgba(255,255,255,.1)';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#6a88b0';ctx.font='12px Space Grotesk';ctx.textAlign='center';ctx.fillText('Sin tardanzas hoy',c.width/2,c.height/2);return;}
  const max=Math.max(...late.map(x=>x.t));
  const bw=Math.min(40,(c.width-40)/late.length-8);
  const ch=c.height-40;
  ctx.clearRect(0,0,c.width,c.height);
  late.forEach((x,i)=>{
    const h=Math.max(4,(x.t/max)*ch);
    const bx=20+i*(bw+8),by=ch-h+10;
    ctx.fillStyle='rgba(255,68,102,.7)';
    ctx.beginPath();ctx.roundRect(bx,by,bw,h,4);ctx.fill();
    ctx.fillStyle='#c8d8f0';ctx.font='9px DM Mono';ctx.textAlign='center';
    ctx.fillText(x.u,bx+bw/2,c.height-4);
    ctx.fillStyle='#ff4466';ctx.font='10px DM Mono';
    ctx.fillText(x.t+'m',bx+bw/2,by-4);
  });
}
function drawHoraBar(viajes){
  const c=$('chart-hora');if(!c)return;
  const ctx=c.getContext('2d');
  c.width=c.offsetWidth||350;c.height=140;
  const hrs=Array(24).fill(0);
  viajes.forEach(v=>{const h=parseTxt(v.salida||'00:00')/60|0;if(h>=0&&h<24)hrs[h]++;});
  const max=Math.max(...hrs,1);
  const bw=(c.width-30)/24;
  ctx.clearRect(0,0,c.width,c.height);
  const ch=c.height-25;
  hrs.forEach((n,h)=>{
    const barH=Math.max(0,(n/max)*ch);
    const bx=15+h*bw,by=ch-barH+5;
    ctx.fillStyle=n>0?'rgba(79,142,255,.6)':'rgba(79,142,255,.1)';
    ctx.fillRect(bx,by,bw-2,barH);
    if(h%3===0){ctx.fillStyle='#6a88b0';ctx.font='9px DM Mono';ctx.textAlign='center';ctx.fillText(String(h).padStart(2,'0'),bx+bw/2,c.height-4);}
    if(n>0){ctx.fillStyle='#4f8eff';ctx.font='9px DM Mono';ctx.textAlign='center';ctx.fillText(n,bx+bw/2,by-3);}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTE MENSUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mesRep(d){repMonth=new Date(repMonth.getFullYear(),repMonth.getMonth()+d,1);renderReporte();}
function renderReporte(){
  const mk=repMonth.getFullYear()+'-'+String(repMonth.getMonth()+1).padStart(2,'0');
  $('mes-lbl') && ($('mes-lbl').textContent=MONTHS[repMonth.getMonth()]+' '+repMonth.getFullYear());
  const rep=FD.report?.[mk]||{};
  const tbody=$('rep-tbody');if(!tbody)return;
  if(!Object.keys(rep).length){tbody.innerHTML='<tr><td colspan="7" style="color:var(--txt2);text-align:center;padding:20px">Sin datos. Cierra el mes para generar reporte.</td></tr>';return;}
  tbody.innerHTML=Object.entries(rep).map(([u,r])=>`<tr>
    <td class="mono">U${String(u).padStart(2,'00')}</td>
    <td>${choferName(u)}</td>
    <td class="mono">${r.viajes||0}</td>
    <td>${r.tardMin>0?`<span class="badge red">${r.tardMin}min</span>`:'<span class="badge grn">0</span>'}</td>
    <td class="mono">S/${r.multaBase||0}</td>
    <td class="mono">S/${r.multaExtra||0}</td>
    <td><strong class="mono" style="color:var(--amb)">S/${(r.multaBase||0)+(r.multaExtra||0)}</strong></td>
  </tr>`).join('');
}
function cerrarMes(){
  if(!confirm('Â¿Cerrar el mes actual y generar reporte? Esta acciÃ³n no se puede deshacer.')) return;
  const mk=new Date().getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
  const viajes=Object.values(FD.hist||{}).filter(v=>v.fecha?.startsWith(mk));
  const rep={};
  for(let i=1;i<=N_UNITS;i++){
    const vs=viajes.filter(v=>String(v.unit||v.unidad)===String(i));
    const tardMin=vs.reduce((s,v)=>s+(v.tardTotal||v.tardanza||0),0);
    const multaExtra=Object.values(FD.multas||{}).filter(m=>String(m.unit)===String(i)&&m.fecha?.startsWith(mk)).reduce((s,m)=>s+m.monto,0);
    if(vs.length>0||multaExtra>0) rep[i]={viajes:vs.length,tardMin,multaBase:tardMin,multaExtra};
  }
  fbUpd('reporteMensual',{[mk]:rep});
  alert('Reporte mensual generado âœ“');
  repMonth=new Date();renderReporte();
}
function exportReportePDF(){alert('Para PDF: usa Ctrl+P / Imprimir desde el navegador');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAlert(id,msg,type){
  const el=$(id);if(!el)return;
  el.className='alert show '+type;el.textContent=msg;
  setTimeout(()=>el.classList.remove('show'),8000);
}
function beep(f=880,d=150,v=.3){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);
    o.frequency.value=f;g.gain.value=v;
    o.start();o.stop(ctx.currentTime+d/1000);
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD UNIT SELECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLoginUnitSelects(){
  ['login-unit','mult-u'].forEach(id=>{
    const el=$(id);if(!el)return;
    el.innerHTML='<option value="">â€”</option>'+Array.from({length:N_UNITS},(_,i)=>`<option value="${i+1}">U${String(i+1).padStart(2,'00')} Â· ${choferName(i+1)}</option>`).join('');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload=()=>{
  // Pre-fill today's date
  const hf=$('hist-fecha');if(hf)hf.value=today();
  // Try auto-connect
  const s=localStorage.getItem('ft_cfg');
  if(s){
    try{
      const c=JSON.parse(s);
      $('cfg-key').value=c.apiKey||'';$('cfg-url').value=c.databaseURL||'';$('cfg-pid').value=c.projectId||'';
      initFB(c);
    }catch(e){}
  }
};
</script>
</body>
</html>
